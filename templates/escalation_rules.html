{% extends "base_beautiful.html" %}

{% block title %}Escalation Rules - HomeNetMon{% endblock %}

{% block extra_css %}
<style>
/* Escalation Rules specific styling */
.escalation-header {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    backdrop-filter: blur(20px);
    padding: 2rem;
    margin-bottom: 2rem;
}

.escalation-card {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    backdrop-filter: blur(20px);
    transition: all 0.3s ease;
}

.escalation-card:hover {
    transform: translateY(-2px);
    border-color: rgba(255, 255, 255, 0.2);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.stat-card {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(139, 92, 246, 0.2) 100%);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    backdrop-filter: blur(20px);
    padding: 1.5rem;
    text-align: center;
    transition: all 0.3s ease;
}

.stat-card.primary {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.3) 0%, rgba(37, 99, 235, 0.3) 100%);
}

.stat-card.success {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.3) 0%, rgba(22, 163, 74, 0.3) 100%);
}

.stat-card.warning {
    background: linear-gradient(135deg, rgba(251, 191, 36, 0.3) 0%, rgba(245, 158, 11, 0.3) 100%);
}

.stat-card.info {
    background: linear-gradient(135deg, rgba(6, 182, 212, 0.3) 0%, rgba(8, 145, 178, 0.3) 100%);
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.stat-card h5 {
    color: rgba(255, 255, 255, 0.9);
    font-size: 1rem;
    margin-bottom: 0.5rem;
}

.stat-card h3 {
    color: rgba(255, 255, 255, 1);
    font-size: 2rem;
    font-weight: 300;
    margin-bottom: 0.25rem;
}

.stat-card small {
    color: rgba(255, 255, 255, 0.7);
}

.rule-status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
}

.rule-status-indicator.enabled {
    background-color: rgba(34, 197, 94, 0.8);
    box-shadow: 0 0 8px rgba(34, 197, 94, 0.4);
}

.rule-status-indicator.disabled {
    background-color: rgba(239, 68, 68, 0.8);
    box-shadow: 0 0 8px rgba(239, 68, 68, 0.4);
}

.priority-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-weight: 600;
}

.priority-1 {
    background: rgba(239, 68, 68, 0.2) !important;
    color: rgba(239, 68, 68, 1) !important;
    border: 1px solid rgba(239, 68, 68, 0.3) !important;
}

.priority-2 {
    background: rgba(251, 146, 60, 0.2) !important;
    color: rgba(251, 146, 60, 1) !important;
    border: 1px solid rgba(251, 146, 60, 0.3) !important;
}

.priority-3 {
    background: rgba(251, 191, 36, 0.2) !important;
    color: rgba(251, 191, 36, 1) !important;
    border: 1px solid rgba(251, 191, 36, 0.3) !important;
}

.priority-4 {
    background: rgba(34, 197, 94, 0.2) !important;
    color: rgba(34, 197, 94, 1) !important;
    border: 1px solid rgba(34, 197, 94, 0.3) !important;
}

.priority-5 {
    background: rgba(139, 92, 246, 0.2) !important;
    color: rgba(139, 92, 246, 1) !important;
    border: 1px solid rgba(139, 92, 246, 0.3) !important;
}

.trigger-type-badge {
    font-size: 0.75rem;
    margin-right: 0.25rem;
    background: rgba(6, 182, 212, 0.2) !important;
    color: rgba(6, 182, 212, 1) !important;
    border: 1px solid rgba(6, 182, 212, 0.3) !important;
}

.action-type-badge {
    font-size: 0.65rem;
    margin: 0.1rem;
    padding: 0.15rem 0.4rem;
    background: rgba(156, 163, 175, 0.2) !important;
    color: rgba(156, 163, 175, 1) !important;
    border: 1px solid rgba(156, 163, 175, 0.3) !important;
}

.rule-card {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    backdrop-filter: blur(20px);
    transition: all 0.3s ease;
    margin-bottom: 1rem;
}

.rule-card:hover {
    transform: translateY(-2px);
    border-color: rgba(255, 255, 255, 0.2);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.rule-card.disabled {
    opacity: 0.7;
    background: rgba(255, 255, 255, 0.02);
}

.bulk-actions {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    backdrop-filter: blur(20px);
    padding: 1rem;
    margin-bottom: 1rem;
    display: none;
}

.rule-metrics {
    font-size: 0.875rem;
    color: rgba(255, 255, 255, 0.7);
}

.execution-status {
    font-size: 0.75rem;
}

.rules-table {
    background: rgba(255, 255, 255, 0.03);
    color: rgba(255, 255, 255, 0.9);
}

.rules-table th {
    background: rgba(255, 255, 255, 0.05);
    color: rgba(255, 255, 255, 0.8);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    font-weight: 600;
}

.rules-table td {
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    color: rgba(255, 255, 255, 0.9);
}

.rules-table tbody tr:hover {
    background: rgba(255, 255, 255, 0.05);
}

.rules-table tbody tr.table-secondary {
    background: rgba(255, 255, 255, 0.02);
    opacity: 0.8;
}

.breadcrumb {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: 0.75rem 1rem;
}

.breadcrumb-item a {
    color: rgba(255, 255, 255, 0.8);
    text-decoration: none;
    transition: color 0.2s ease;
}

.breadcrumb-item a:hover {
    color: rgba(255, 255, 255, 1);
}

.breadcrumb-item.active {
    color: rgba(255, 255, 255, 0.6);
}

/* Form controls styling */
.form-control {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.9);
}

.form-control:focus {
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(59, 130, 246, 0.5);
    box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
    color: rgba(255, 255, 255, 1);
}

.form-select {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.9);
}

.form-select:focus {
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(59, 130, 246, 0.5);
    box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
    color: rgba(255, 255, 255, 1);
}

.form-label {
    color: rgba(255, 255, 255, 0.8);
    font-weight: 500;
}

/* Button styling */
.btn-primary {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.8) 0%, rgba(37, 99, 235, 0.8) 100%);
    border: 1px solid rgba(59, 130, 246, 0.5);
    color: rgba(255, 255, 255, 1);
}

.btn-primary:hover {
    background: linear-gradient(135deg, rgba(59, 130, 246, 1) 0%, rgba(37, 99, 235, 1) 100%);
    border-color: rgba(59, 130, 246, 0.8);
    transform: translateY(-1px);
}

.btn-outline-secondary {
    border-color: rgba(156, 163, 175, 0.5);
    color: rgba(156, 163, 175, 1);
    background: rgba(156, 163, 175, 0.1);
}

.btn-outline-secondary:hover {
    background: rgba(156, 163, 175, 0.2);
    border-color: rgba(156, 163, 175, 0.8);
    color: rgba(255, 255, 255, 1);
}

.btn-outline-primary {
    border-color: rgba(59, 130, 246, 0.5);
    color: rgba(59, 130, 246, 1);
    background: rgba(59, 130, 246, 0.1);
}

.btn-outline-primary:hover {
    background: rgba(59, 130, 246, 0.2);
    border-color: rgba(59, 130, 246, 0.8);
    color: rgba(255, 255, 255, 1);
}

.btn-outline-success {
    border-color: rgba(34, 197, 94, 0.5);
    color: rgba(34, 197, 94, 1);
    background: rgba(34, 197, 94, 0.1);
}

.btn-outline-success:hover {
    background: rgba(34, 197, 94, 0.2);
    border-color: rgba(34, 197, 94, 0.8);
    color: rgba(255, 255, 255, 1);
}

.btn-outline-info {
    border-color: rgba(6, 182, 212, 0.5);
    color: rgba(6, 182, 212, 1);
    background: rgba(6, 182, 212, 0.1);
}

.btn-outline-info:hover {
    background: rgba(6, 182, 212, 0.2);
    border-color: rgba(6, 182, 212, 0.8);
    color: rgba(255, 255, 255, 1);
}

.btn-outline-danger {
    border-color: rgba(239, 68, 68, 0.5);
    color: rgba(239, 68, 68, 1);
    background: rgba(239, 68, 68, 0.1);
}

.btn-outline-danger:hover {
    background: rgba(239, 68, 68, 0.2);
    border-color: rgba(239, 68, 68, 0.8);
    color: rgba(255, 255, 255, 1);
}

.btn-success {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.8) 0%, rgba(22, 163, 74, 0.8) 100%);
    border: 1px solid rgba(34, 197, 94, 0.5);
}

.btn-warning {
    background: linear-gradient(135deg, rgba(251, 191, 36, 0.8) 0%, rgba(245, 158, 11, 0.8) 100%);
    border: 1px solid rgba(251, 191, 36, 0.5);
    color: rgba(0, 0, 0, 0.8);
}

.btn-danger {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.8) 0%, rgba(220, 38, 38, 0.8) 100%);
    border: 1px solid rgba(239, 68, 68, 0.5);
}

.btn-secondary {
    background: linear-gradient(135deg, rgba(156, 163, 175, 0.8) 0%, rgba(107, 114, 128, 0.8) 100%);
    border: 1px solid rgba(156, 163, 175, 0.5);
}

/* Dropdown styling */
.dropdown-menu {
    background: rgba(30, 30, 30, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(20px);
}

.dropdown-item {
    color: rgba(255, 255, 255, 0.8);
    transition: all 0.2s ease;
}

.dropdown-item:hover {
    background: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 1);
}

.dropdown-header {
    color: rgba(255, 255, 255, 0.6);
}

/* Badge styling */
.badge {
    background: rgba(59, 130, 246, 0.2) !important;
    color: rgba(59, 130, 246, 1) !important;
    border: 1px solid rgba(59, 130, 246, 0.3) !important;
}

.badge.bg-secondary {
    background: rgba(156, 163, 175, 0.2) !important;
    color: rgba(156, 163, 175, 1) !important;
    border: 1px solid rgba(156, 163, 175, 0.3) !important;
}

.badge.bg-success {
    background: rgba(34, 197, 94, 0.2) !important;
    color: rgba(34, 197, 94, 1) !important;
    border: 1px solid rgba(34, 197, 94, 0.3) !important;
}

.badge.bg-info {
    background: rgba(6, 182, 212, 0.2) !important;
    color: rgba(6, 182, 212, 1) !important;
    border: 1px solid rgba(6, 182, 212, 0.3) !important;
}

/* Pagination styling */
.pagination .page-link {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.8);
}

.pagination .page-link:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.2);
    color: rgba(255, 255, 255, 1);
}

.pagination .page-item.active .page-link {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.8) 0%, rgba(37, 99, 235, 0.8) 100%);
    border-color: rgba(59, 130, 246, 0.5);
    color: rgba(255, 255, 255, 1);
}

/* Form switches */
.form-check-input:checked {
    background-color: rgba(34, 197, 94, 0.8);
    border-color: rgba(34, 197, 94, 0.8);
}

.form-check-input:focus {
    box-shadow: 0 0 0 0.25rem rgba(34, 197, 94, 0.25);
}

/* Loading skeleton */
.loading-skeleton {
    background: linear-gradient(90deg, rgba(255, 255, 255, 0.1) 25%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0.1) 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: 4px;
    height: 1rem;
}

@keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .table-responsive {
        display: none !important;
    }

    .rule-cards {
        display: block !important;
    }

    .desktop-only {
        display: none !important;
    }

    .escalation-header {
        padding: 1.5rem;
    }

    .stat-card {
        margin-bottom: 1rem;
    }
}

@media (min-width: 769px) {
    .rule-cards {
        display: none !important;
    }
}

/* Text color overrides */
.text-success {
    color: rgba(34, 197, 94, 1) !important;
}

.text-muted {
    color: rgba(255, 255, 255, 0.6) !important;
}

.text-primary {
    color: rgba(59, 130, 246, 1) !important;
}

.text-warning {
    color: rgba(251, 191, 36, 1) !important;
}

.text-info {
    color: rgba(6, 182, 212, 1) !important;
}

/* Alert toast styling */
.alert {
    background: rgba(30, 30, 30, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(20px);
    color: rgba(255, 255, 255, 0.9);
}

.alert-success {
    border-color: rgba(34, 197, 94, 0.3);
    background: rgba(34, 197, 94, 0.1);
}

.alert-danger {
    border-color: rgba(239, 68, 68, 0.3);
    background: rgba(239, 68, 68, 0.1);
}

.alert-info {
    border-color: rgba(6, 182, 212, 0.3);
    background: rgba(6, 182, 212, 0.1);
}
</style>
{% endblock %}

{% block content %}
<!-- Breadcrumb Navigation -->
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}"><i class="bi bi-house"></i> Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('alerts') }}"><i class="bi bi-exclamation-triangle"></i> Alerts & Issues</a></li>
        <li class="breadcrumb-item active" aria-current="page"><i class="bi bi-arrow-up-right-circle"></i> Escalation Rules</li>
    </ol>
</nav>

<!-- Header -->
<div class="escalation-header">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
        <div>
            <h1 class="page-title mb-2">
                <i class="bi bi-arrow-up-right-circle text-primary me-2"></i>Escalation Rules
            </h1>
            <p class="page-subtitle mb-0">Automate escalation workflows for notifications and alerts</p>
        </div>

        <div class="btn-group" role="group">
            <button class="btn btn-primary" onclick="createNewRule()">
                <i class="bi bi-plus-circle"></i> New Rule
            </button>
            <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="bi bi-download"></i> Templates
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="loadTemplate('basic_notification_failure')">Basic Notification Failure</a></li>
                    <li><a class="dropdown-item" href="#" onclick="loadTemplate('critical_alert')">Critical Alert Escalation</a></li>
                    <li><a class="dropdown-item" href="#" onclick="loadTemplate('high_failure_rate')">High Failure Rate</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" onclick="showAllTemplates()">Browse All Templates</a></li>
                </ul>
            </div>
            <button class="btn btn-outline-info" onclick="viewExecutions()">
                <i class="bi bi-list-task"></i> View Executions
            </button>
            <button class="btn btn-outline-success" onclick="refreshRules()">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4" id="stats-container">
    <div class="col-md-3 mb-3">
        <div class="stat-card primary">
            <h5>Total Rules</h5>
            <h3 id="total-rules">-</h3>
            <small>Configured rules</small>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="stat-card success">
            <h5>Active Rules</h5>
            <h3 id="active-rules">-</h3>
            <small>Currently enabled</small>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="stat-card warning">
            <h5>Pending Executions</h5>
            <h3 id="pending-executions">-</h3>
            <small>Waiting to run</small>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="stat-card info">
            <h5>24h Executions</h5>
            <h3 id="recent-executions">-</h3>
            <small>Last 24 hours</small>
        </div>
    </div>
</div>

<!-- Filters and Search -->
<div class="escalation-card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-funnel me-2"></i>Filters</h5>
        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#advanced-filters" aria-expanded="false">
            <i class="bi bi-chevron-down"></i> Advanced
        </button>
    </div>
    <div class="card-body">
        <!-- Basic Filters -->
        <div class="row mb-3">
            <div class="col-md-4">
                <label for="filter-search" class="form-label">Search Rules</label>
                <input type="text" class="form-control" id="filter-search" placeholder="Search by name or description..." onkeyup="applyFilters()">
            </div>
            <div class="col-md-4">
                <label for="filter-status" class="form-label">Status</label>
                <select class="form-select" id="filter-status" onchange="applyFilters()">
                    <option value="">All Rules</option>
                    <option value="enabled">Enabled Only</option>
                    <option value="disabled">Disabled Only</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="filter-trigger-type" class="form-label">Trigger Type</label>
                <select class="form-select" id="filter-trigger-type" onchange="applyFilters()">
                    <option value="">All Types</option>
                </select>
            </div>
        </div>

        <!-- Advanced Filters -->
        <div class="collapse" id="advanced-filters">
            <div class="border-top pt-3">
                <div class="row">
                    <div class="col-md-6">
                        <label for="filter-priority" class="form-label">Priority Range</label>
                        <div class="row">
                            <div class="col-6">
                                <select class="form-select form-select-sm" id="filter-priority-min" onchange="applyFilters()">
                                    <option value="">Min Priority</option>
                                    <option value="1">1 (Highest)</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5 (Lowest)</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <select class="form-select form-select-sm" id="filter-priority-max" onchange="applyFilters()">
                                    <option value="">Max Priority</option>
                                    <option value="1">1 (Highest)</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5 (Lowest)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label for="filter-created-by" class="form-label">Created By</label>
                        <input type="text" class="form-control form-control-sm" id="filter-created-by" placeholder="Username or email..." onkeyup="applyFilters()">
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <button class="btn btn-outline-secondary btn-sm" onclick="clearAllFilters()">
                            <i class="bi bi-x-circle"></i> Clear All Filters
                        </button>
                        <span class="ms-3 text-muted small" id="filter-results-count"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Actions -->
<div class="bulk-actions" id="bulk-actions">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <strong id="selected-count">0</strong> rules selected
        </div>
        <div class="btn-group btn-group-sm">
            <button class="btn btn-success" onclick="bulkEnable()">
                <i class="bi bi-check-circle"></i> Enable
            </button>
            <button class="btn btn-warning" onclick="bulkDisable()">
                <i class="bi bi-x-circle"></i> Disable
            </button>
            <button class="btn btn-danger" onclick="bulkDelete()">
                <i class="bi bi-trash"></i> Delete
            </button>
            <button class="btn btn-secondary" onclick="clearSelection()">
                Cancel
            </button>
        </div>
    </div>
</div>

<!-- Rules Content -->
<div class="escalation-card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Escalation Rules</h5>
        <div>
            <div class="form-check form-switch d-inline-block me-3">
                <input class="form-check-input" type="checkbox" id="select-all-rules" onchange="toggleSelectAll()">
                <label class="form-check-label small" for="select-all-rules">Select All</label>
            </div>
            <span class="badge bg-secondary" id="total-count">0 rules</span>
        </div>
    </div>
    <div class="card-body">
        <div id="loading-spinner" class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-2">Loading escalation rules...</div>
        </div>

        <!-- Desktop Table View -->
        <div class="table-responsive" id="rules-table" style="display: none;">
            <table class="table table-hover rules-table">
                <thead>
                    <tr>
                        <th width="50">
                            <input type="checkbox" id="table-select-all" onchange="toggleSelectAll()">
                        </th>
                        <th>Rule Name</th>
                        <th>Trigger Type</th>
                        <th>Priority</th>
                        <th>Status</th>
                        <th>Actions</th>
                        <th>Executions</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="rules-tbody">
                </tbody>
            </table>
        </div>

        <!-- Mobile Card View -->
        <div class="rule-cards" id="rules-cards">
            <!-- Cards will be populated here -->
        </div>

        <!-- Pagination -->
        <nav aria-label="Rules pagination" id="pagination-container" style="display: none;">
            <ul class="pagination justify-content-center" id="pagination">
            </ul>
        </nav>

        <div id="no-rules" class="text-center py-4" style="display: none;">
            <i class="bi bi-arrow-up-right-circle fs-1 text-muted"></i>
            <h5 class="mt-3 text-muted">No escalation rules found</h5>
            <p class="text-muted">Create your first escalation rule to automate alert workflows.</p>
            <button class="btn btn-primary" onclick="createNewRule()">
                <i class="bi bi-plus-circle"></i> Create First Rule
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
let currentFilters = {
    search: '',
    status: '',
    trigger_type: '',
    priority_min: '',
    priority_max: '',
    created_by: ''
};
let selectedRules = new Set();
let allRules = [];

// Load rules and statistics on page load
document.addEventListener('DOMContentLoaded', function() {
    loadTriggerTypes();
    loadStatistics();
    loadRules();
});

async function loadTriggerTypes() {
    try {
        const response = await fetch('/api/escalation/trigger-types');
        const data = await response.json();

        const select = document.getElementById('filter-trigger-type');
        Object.entries(data).forEach(([key, value]) => {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = value.name;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading trigger types:', error);
    }
}

async function loadStatistics() {
    try {
        const response = await fetch('/api/escalation/statistics');
        const stats = await response.json();

        document.getElementById('total-rules').textContent = stats.total_rules;
        document.getElementById('active-rules').textContent = stats.enabled_rules;
        document.getElementById('pending-executions').textContent = stats.pending_executions;
        document.getElementById('recent-executions').textContent = stats.total_executions;

    } catch (error) {
        console.error('Error loading statistics:', error);
    }
}

async function loadRules() {
    try {
        document.getElementById('loading-spinner').style.display = 'block';
        document.getElementById('rules-table').style.display = 'none';
        document.getElementById('rules-cards').style.display = 'none';
        document.getElementById('no-rules').style.display = 'none';

        const params = new URLSearchParams({
            page: currentPage,
            per_page: 20,
            ...currentFilters
        });

        // Remove empty parameters
        for (const [key, value] of [...params.entries()]) {
            if (!value) params.delete(key);
        }

        const response = await fetch(`/api/escalation/rules?${params}`);
        const data = await response.json();

        document.getElementById('loading-spinner').style.display = 'none';

        if (data.rules.length === 0) {
            document.getElementById('no-rules').style.display = 'block';
            return;
        }

        allRules = data.rules;
        document.getElementById('rules-table').style.display = 'block';
        document.getElementById('rules-cards').style.display = 'block';
        document.getElementById('total-count').textContent = `${data.pagination.total} rules`;

        renderRulesTable(data.rules);
        renderRulesCards(data.rules);
        updatePagination(data.pagination);
        updateFilterResultsCount(data.pagination.total);

    } catch (error) {
        console.error('Error loading rules:', error);
        document.getElementById('loading-spinner').style.display = 'none';
        showToast('Error loading escalation rules', 'error');
    }
}

function renderRulesTable(rules) {
    const tbody = document.getElementById('rules-tbody');
    tbody.innerHTML = '';

    rules.forEach(rule => {
        const row = document.createElement('tr');
        row.className = rule.enabled ? '' : 'table-secondary';

        // Status indicator
        const statusIndicator = rule.enabled ?
            '<span class="rule-status-indicator enabled" title="Enabled"></span>' :
            '<span class="rule-status-indicator disabled" title="Disabled"></span>';

        // Priority badge
        const priorityBadge = `<span class="badge priority-${rule.priority}">P${rule.priority}</span>`;

        // Trigger type badge
        const triggerBadge = `<span class="badge bg-info trigger-type-badge">${rule.trigger_type.replace('_', ' ')}</span>`;

        // Action type badges
        const actionBadges = rule.escalation_actions.map(action =>
            `<span class="badge bg-secondary action-type-badge">${action.action_type}</span>`
        ).join(' ');

        // Execution count with status
        const executionCount = rule.total_executions || 0;
        const executionDisplay = executionCount > 0 ?
            `<span class="text-success">${executionCount}</span>` :
            `<span class="text-muted">0</span>`;

        row.innerHTML = `
            <td>
                <input type="checkbox" class="rule-checkbox" value="${rule.id}" onchange="toggleRuleSelection(${rule.id})">
            </td>
            <td>
                ${statusIndicator}
                <strong>${rule.name}</strong>
                ${rule.description ? `<br><small class="text-muted">${rule.description}</small>` : ''}
            </td>
            <td>${triggerBadge}</td>
            <td>${priorityBadge}</td>
            <td>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" ${rule.enabled ? 'checked' : ''}
                           onchange="toggleRuleStatus(${rule.id}, this.checked)">
                </div>
            </td>
            <td>${actionBadges}</td>
            <td class="text-center">${executionDisplay}</td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="editRule(${rule.id})" title="Edit">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-outline-success" onclick="testRule(${rule.id})" title="Test">
                        <i class="bi bi-play"></i>
                    </button>
                    <button class="btn btn-outline-info" onclick="duplicateRule(${rule.id})" title="Duplicate">
                        <i class="bi bi-files"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="deleteRule(${rule.id})" title="Delete">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </td>
        `;

        tbody.appendChild(row);
    });
}

function renderRulesCards(rules) {
    const container = document.getElementById('rules-cards');
    container.innerHTML = '';

    rules.forEach(rule => {
        const card = document.createElement('div');
        card.className = `rule-card ${rule.enabled ? '' : 'disabled'}`;

        const statusIndicator = rule.enabled ?
            '<span class="rule-status-indicator enabled"></span>' :
            '<span class="rule-status-indicator disabled"></span>';

        const priorityBadge = `<span class="badge priority-${rule.priority}">P${rule.priority}</span>`;
        const triggerBadge = `<span class="badge bg-info">${rule.trigger_type.replace('_', ' ')}</span>`;

        const actionBadges = rule.escalation_actions.map(action =>
            `<span class="badge bg-secondary action-type-badge">${action.action_type}</span>`
        ).join(' ');

        card.innerHTML = `
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                        <input type="checkbox" class="rule-checkbox me-2" value="${rule.id}" onchange="toggleRuleSelection(${rule.id})">
                        ${statusIndicator}
                        <strong>${rule.name}</strong>
                        ${priorityBadge}
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" ${rule.enabled ? 'checked' : ''}
                               onchange="toggleRuleStatus(${rule.id}, this.checked)">
                    </div>
                </div>

                ${rule.description ? `<p class="text-muted mb-2">${rule.description}</p>` : ''}

                <div class="mb-2">
                    <strong>Trigger:</strong> ${triggerBadge}
                </div>

                <div class="mb-2">
                    <strong>Actions:</strong><br>
                    ${actionBadges}
                </div>

                <div class="rule-metrics mb-3">
                    <span class="me-3"><i class="bi bi-clock"></i> ${rule.escalation_interval_minutes}min intervals</span>
                    <span class="me-3"><i class="bi bi-repeat"></i> Max ${rule.max_escalations} levels</span>
                    <span><i class="bi bi-list-task"></i> ${rule.total_executions || 0} executions</span>
                </div>

                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                        Created by ${rule.created_by || 'Unknown'}
                    </small>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="editRule(${rule.id})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-outline-success" onclick="testRule(${rule.id})">
                            <i class="bi bi-play"></i>
                        </button>
                        <button class="btn btn-outline-info" onclick="duplicateRule(${rule.id})">
                            <i class="bi bi-files"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteRule(${rule.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;

        container.appendChild(card);
    });
}

function updatePagination(pagination) {
    const container = document.getElementById('pagination-container');
    const paginationElement = document.getElementById('pagination');

    if (pagination.pages <= 1) {
        container.style.display = 'none';
        return;
    }

    container.style.display = 'block';
    paginationElement.innerHTML = '';

    // Previous button
    const prevItem = document.createElement('li');
    prevItem.className = `page-item ${!pagination.has_prev ? 'disabled' : ''}`;
    prevItem.innerHTML = `<a class="page-link" href="#" onclick="changePage(${pagination.page - 1})">Previous</a>`;
    paginationElement.appendChild(prevItem);

    // Page numbers
    const startPage = Math.max(1, pagination.page - 2);
    const endPage = Math.min(pagination.pages, pagination.page + 2);

    for (let i = startPage; i <= endPage; i++) {
        const pageItem = document.createElement('li');
        pageItem.className = `page-item ${i === pagination.page ? 'active' : ''}`;
        pageItem.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
        paginationElement.appendChild(pageItem);
    }

    // Next button
    const nextItem = document.createElement('li');
    nextItem.className = `page-item ${!pagination.has_next ? 'disabled' : ''}`;
    nextItem.innerHTML = `<a class="page-link" href="#" onclick="changePage(${pagination.page + 1})">Next</a>`;
    paginationElement.appendChild(nextItem);
}

function changePage(page) {
    if (page < 1) return;
    currentPage = page;
    loadRules();
}

function applyFilters() {
    currentFilters = {
        search: document.getElementById('filter-search').value,
        status: document.getElementById('filter-status').value,
        trigger_type: document.getElementById('filter-trigger-type').value,
        priority_min: document.getElementById('filter-priority-min').value,
        priority_max: document.getElementById('filter-priority-max').value,
        created_by: document.getElementById('filter-created-by').value
    };
    currentPage = 1;
    loadRules();
}

function clearAllFilters() {
    document.getElementById('filter-search').value = '';
    document.getElementById('filter-status').value = '';
    document.getElementById('filter-trigger-type').value = '';
    document.getElementById('filter-priority-min').value = '';
    document.getElementById('filter-priority-max').value = '';
    document.getElementById('filter-created-by').value = '';
    applyFilters();
}

function updateFilterResultsCount(total) {
    document.getElementById('filter-results-count').textContent = `Showing ${total} results`;
}

function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('select-all-rules') || document.getElementById('table-select-all');
    const ruleCheckboxes = document.querySelectorAll('.rule-checkbox');

    selectedRules.clear();

    ruleCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
        if (selectAllCheckbox.checked) {
            selectedRules.add(parseInt(checkbox.value));
        }
    });

    updateBulkActions();
}

function toggleRuleSelection(ruleId) {
    if (selectedRules.has(ruleId)) {
        selectedRules.delete(ruleId);
    } else {
        selectedRules.add(ruleId);
    }
    updateBulkActions();
}

function updateBulkActions() {
    const bulkActions = document.getElementById('bulk-actions');
    const selectedCount = document.getElementById('selected-count');

    if (selectedRules.size > 0) {
        bulkActions.style.display = 'block';
        selectedCount.textContent = selectedRules.size;
    } else {
        bulkActions.style.display = 'none';
    }
}

function clearSelection() {
    selectedRules.clear();
    document.querySelectorAll('.rule-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    document.getElementById('select-all-rules').checked = false;
    if (document.getElementById('table-select-all')) {
        document.getElementById('table-select-all').checked = false;
    }
    updateBulkActions();
}

async function toggleRuleStatus(ruleId, enabled) {
    try {
        const response = await fetch(`/api/escalation/rules/${ruleId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ enabled: enabled })
        });

        if (response.ok) {
            showToast(`Rule ${enabled ? 'enabled' : 'disabled'} successfully`, 'success');
            loadStatistics();
        } else {
            throw new Error('Failed to update rule status');
        }

    } catch (error) {
        console.error('Error updating rule status:', error);
        showToast('Error updating rule status', 'error');
        // Revert checkbox
        const checkbox = event.target;
        checkbox.checked = !enabled;
    }
}

function createNewRule() {
    window.location.href = '/escalation-rules/new';
}

function editRule(ruleId) {
    window.location.href = `/escalation-rules/${ruleId}/edit`;
}

function viewExecutions() {
    window.location.href = '/escalation-executions';
}

async function testRule(ruleId) {
    // Implementation for rule testing will be added in the next phase
    showToast('Rule testing interface coming soon', 'info');
}

async function duplicateRule(ruleId) {
    try {
        const response = await fetch(`/api/escalation/rules/${ruleId}`);
        const rule = await response.json();

        // Redirect to new rule form with pre-filled data
        const params = new URLSearchParams();
        params.set('duplicate_from', ruleId);
        window.location.href = `/escalation-rules/new?${params}`;

    } catch (error) {
        console.error('Error duplicating rule:', error);
        showToast('Error duplicating rule', 'error');
    }
}

async function deleteRule(ruleId) {
    if (!confirm('Are you sure you want to delete this escalation rule? This action cannot be undone.')) {
        return;
    }

    try {
        const response = await fetch(`/api/escalation/rules/${ruleId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            showToast('Rule deleted successfully', 'success');
            loadRules();
            loadStatistics();
        } else {
            const data = await response.json();
            throw new Error(data.error || 'Failed to delete rule');
        }

    } catch (error) {
        console.error('Error deleting rule:', error);
        showToast('Error deleting rule: ' + error.message, 'error');
    }
}

async function bulkEnable() {
    await bulkUpdateStatus(true);
}

async function bulkDisable() {
    await bulkUpdateStatus(false);
}

async function bulkUpdateStatus(enabled) {
    if (selectedRules.size === 0) return;

    const action = enabled ? 'enable' : 'disable';
    if (!confirm(`Are you sure you want to ${action} ${selectedRules.size} selected rules?`)) {
        return;
    }

    try {
        const promises = Array.from(selectedRules).map(ruleId =>
            fetch(`/api/escalation/rules/${ruleId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ enabled: enabled })
            })
        );

        await Promise.all(promises);

        showToast(`Successfully ${action}d ${selectedRules.size} rules`, 'success');
        clearSelection();
        loadRules();
        loadStatistics();

    } catch (error) {
        console.error(`Error ${action}ing rules:`, error);
        showToast(`Error ${action}ing rules`, 'error');
    }
}

async function bulkDelete() {
    if (selectedRules.size === 0) return;

    if (!confirm(`Are you sure you want to delete ${selectedRules.size} selected rules? This action cannot be undone.`)) {
        return;
    }

    try {
        const promises = Array.from(selectedRules).map(ruleId =>
            fetch(`/api/escalation/rules/${ruleId}`, {
                method: 'DELETE'
            })
        );

        await Promise.all(promises);

        showToast(`Successfully deleted ${selectedRules.size} rules`, 'success');
        clearSelection();
        loadRules();
        loadStatistics();

    } catch (error) {
        console.error('Error deleting rules:', error);
        showToast('Error deleting rules', 'error');
    }
}

function refreshRules() {
    loadStatistics();
    loadRules();
}

async function loadTemplate(templateName) {
    try {
        const response = await fetch('/api/escalation/rules/templates');
        const data = await response.json();

        const template = data.templates.find(t => t.name.toLowerCase().includes(templateName));
        if (template) {
            // Redirect to new rule form with template data
            const params = new URLSearchParams();
            params.set('template', templateName);
            window.location.href = `/escalation-rules/new?${params}`;
        }

    } catch (error) {
        console.error('Error loading template:', error);
        showToast('Error loading template', 'error');
    }
}

function showAllTemplates() {
    window.location.href = '/escalation-rules/templates';
}

function showToast(message, type = 'info') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    toast.style.top = '20px';
    toast.style.right = '20px';
    toast.style.zIndex = '9999';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(toast);

    // Auto remove after 5 seconds
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 5000);
}
</script>
{% endblock %}