{% extends "base_with_quickstats.html" %}

{% block title %}Settings - HomeNetMon{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-gear"></i> Settings</h1>
</div>

<div class="row">
    <div class="col-md-3">
        <!-- Settings Navigation -->
        <div class="list-group" id="settings-nav">
            <a class="list-group-item list-group-item-action active" data-bs-toggle="list" href="#network-settings">
                <i class="bi bi-router"></i> Network
            </a>
            <a class="list-group-item list-group-item-action" data-bs-toggle="list" href="#interface-settings">
                <i class="bi bi-palette"></i> Interface
            </a>
            <a class="list-group-item list-group-item-action" data-bs-toggle="list" href="#alert-settings">
                <i class="bi bi-bell"></i> Alerts
            </a>
            <a class="list-group-item list-group-item-action" data-bs-toggle="list" href="#system-settings">
                <i class="bi bi-gear"></i> System
            </a>
        </div>
    </div>
    
    <div class="col-md-9">
        <div class="tab-content">
            <!-- Network Settings -->
            <div class="tab-pane fade show active" id="network-settings">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Network Configuration</h5>
                    </div>
                    <div class="card-body">
                        <form id="network-settings-form">
                            <div class="mb-4">
                                <label for="network-range" class="form-label">
                                    <i class="bi bi-globe"></i> Network Range to Monitor
                                </label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="network-range" placeholder="192.168.86.0/24">
                                    <button type="button" class="btn btn-outline-success" id="save-network-range-btn" onclick="saveNetworkRangeQuick()" style="display: none;">
                                        <i class="bi bi-check2"></i> Save
                                    </button>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setNetworkRange('192.168.1.0/24')">192.168.1.x</button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setNetworkRange('192.168.86.0/24')">192.168.86.x</button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setNetworkRange('10.0.0.0/24')">10.0.0.x</button>
                                    </div>
                                </div>
                                <div class="form-text">
                                    CIDR notation for the network range to monitor (e.g., 192.168.1.0/24 monitors 192.168.1.1-254)
                                    <br><small class="text-muted">Common ranges: Home networks typically use 192.168.1.x or 192.168.86.x</small>
                                    <br><small class="text-success" id="network-range-help" style="display: none;">✓ Valid network range format</small>
                                </div>
                                <div class="invalid-feedback">
                                    Please enter a valid CIDR network range (e.g., 192.168.1.0/24)
                                </div>
                                
                                <!-- Network Range Helper -->
                                <div class="mt-2">
                                    <div class="card bg-light">
                                        <div class="card-body py-2">
                                            <div class="row align-items-center">
                                                <div class="col-md-8">
                                                    <small>
                                                        <strong>Currently monitoring:</strong> 
                                                        <span id="current-network-display" class="text-primary">Loading...</span>
                                                        (<span id="current-network-range">Loading...</span>)
                                                    </small>
                                                </div>
                                                <div class="col-md-4 text-end">
                                                    <button type="button" class="btn btn-outline-info btn-sm" onclick="detectNetworkRange()">
                                                        <i class="bi bi-search"></i> Auto-detect
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Automatic Monitoring Configuration -->
                            <div class="alert alert-info mb-4">
                                <h6><i class="bi bi-info-circle"></i> Automatic Monitoring Settings</h6>
                                <p class="mb-2">HomeNetMon continuously monitors your network in the background. Use these settings to control how frequently automatic operations run:</p>
                                <ul class="mb-0">
                                    <li><strong>Ping Interval:</strong> How often to check if devices are online</li>
                                    <li><strong>Scan Interval:</strong> How often to discover new devices on the network</li>
                                </ul>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="ping-interval" class="form-label">
                                        <i class="bi bi-broadcast"></i> Automatic Ping Interval (seconds)
                                    </label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="ping-interval" min="5" max="900">
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setPingInterval(30)">30s</button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setPingInterval(60)">1m</button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setPingInterval(300)">5m</button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setPingInterval(600)">10m</button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setPingInterval(900)">15m</button>
                                        </div>
                                    </div>
                                    <div class="form-text">
                                        How often to automatically ping all monitored devices (5-900 seconds)
                                        <br><small class="text-muted">Default: 30 seconds • Lower values = more frequent monitoring</small>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <label for="scan-interval" class="form-label">
                                        <i class="bi bi-search"></i> Automatic Scan Interval (seconds)
                                    </label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="scan-interval" min="60" max="3600">
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setScanInterval(120)">2m</button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setScanInterval(300)">5m</button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setScanInterval(600)">10m</button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setScanInterval(900)">15m</button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setScanInterval(1800)">30m</button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setScanInterval(3600)">1h</button>
                                        </div>
                                    </div>
                                    <div class="form-text">
                                        How often to automatically scan for new devices (60-3600 seconds)
                                        <br><small class="text-muted">Default: 300 seconds (5 minutes) • Lower values = more frequent discovery</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Current Monitoring Status -->
                            <div class="card mt-4 bg-light">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="bi bi-activity"></i> Current Monitoring Status
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="bi bi-broadcast me-2 text-primary"></i>
                                                <div>
                                                    <strong>Last Ping:</strong> 
                                                    <span id="current-last-ping" class="text-muted">Loading...</span>
                                                </div>
                                            </div>
                                            <div class="d-flex align-items-center">
                                                <i class="bi bi-clock me-2 text-primary"></i>
                                                <div>
                                                    <strong>Next Ping:</strong> 
                                                    <span id="current-next-ping" class="text-muted">Loading...</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="bi bi-search me-2 text-info"></i>
                                                <div>
                                                    <strong>Last Scan:</strong> 
                                                    <span id="current-last-scan" class="text-muted">Loading...</span>
                                                </div>
                                            </div>
                                            <div class="d-flex align-items-center">
                                                <i class="bi bi-clock me-2 text-info"></i>
                                                <div>
                                                    <strong>Next Scan:</strong> 
                                                    <span id="current-next-scan" class="text-muted">Loading...</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <small class="text-muted">
                                            <i class="bi bi-info-circle"></i>
                                            Changes to ping and scan intervals require a service restart to take effect.
                                        </small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <label for="ping-timeout" class="form-label">Ping Timeout (seconds)</label>
                                    <input type="number" class="form-control" id="ping-timeout" min="1" max="10" step="0.1">
                                    <div class="form-text">Maximum time to wait for ping response</div>
                                </div>
                                
                                <div class="col-md-6">
                                    <label for="max-workers" class="form-label">Max Workers</label>
                                    <input type="number" class="form-control" id="max-workers" min="1" max="100">
                                    <div class="form-text">Maximum concurrent monitoring threads</div>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <button type="submit" class="btn btn-primary">Save Network Settings</button>
                                <button type="button" class="btn btn-outline-warning ms-2" id="restart-services-btn" style="display: none;">
                                    <i class="bi bi-arrow-clockwise"></i> Restart Services
                                </button>
                                <div class="form-text mt-2" id="restart-notice">
                                    <i class="bi bi-info-circle text-muted"></i> <span class="text-muted">Configure your network settings above</span>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Interface Settings -->
            <div class="tab-pane fade" id="interface-settings">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Interface Customization</h5>
                    </div>
                    <div class="card-body">
                        <form id="interface-settings-form">
                            <div class="mb-4">
                                <label for="dashboard-title" class="form-label">
                                    <i class="bi bi-speedometer2"></i> Dashboard Title
                                </label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="dashboard-title" 
                                           value="{{ dashboard_title }}" 
                                           placeholder="Home Network Dashboard"
                                           maxlength="50">
                                    <button type="button" class="btn btn-outline-success" id="save-dashboard-title-btn" 
                                            onclick="saveDashboardTitle()" style="display: none;">
                                        <i class="bi bi-check2"></i> Save
                                    </button>
                                </div>
                                <div class="form-text">
                                    Custom title displayed at the top of the dashboard page
                                </div>
                                <div class="invalid-feedback">
                                    Please enter a valid title (1-50 characters)
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <h6>Preview</h6>
                                <div class="card bg-light">
                                    <div class="card-body py-2">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-speedometer2 me-2 text-primary"></i>
                                            <span id="dashboard-title-preview" class="fw-bold">{{ dashboard_title }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <button type="button" class="btn btn-outline-secondary" onclick="resetDashboardTitle()">
                                        <i class="bi bi-arrow-clockwise"></i> Reset to Default
                                    </button>
                                </div>
                                <div class="col-md-6 text-end">
                                    <button type="submit" class="btn btn-success" id="save-interface-settings">
                                        <i class="bi bi-check-lg"></i> Save Interface Settings
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Alert Settings -->
            <div class="tab-pane fade" id="alert-settings">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Alert Configuration</h5>
                    </div>
                    <div class="card-body">
                        <form id="alert-settings-form">
                            <!-- Email Alerts -->
                            <div class="mb-4">
                                <h6>Email Notifications</h6>
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="email-alerts-enabled">
                                    <label class="form-check-label" for="email-alerts-enabled">
                                        Enable Email Alerts
                                    </label>
                                </div>
                                
                                <div id="email-settings" style="display: none;">
                                    <div class="mb-3">
                                        <label for="email-from" class="form-label">From Email</label>
                                        <input type="email" class="form-control" id="email-from" placeholder="alerts@yourdomain.com">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="email-to" class="form-label">To Email(s)</label>
                                        <input type="text" class="form-control" id="email-to" placeholder="admin@yourdomain.com,user@yourdomain.com">
                                        <div class="form-text">Comma-separated list of email addresses</div>
                                    </div>
                                    
                                    <div class="text-center mb-3">
                                        <button type="button" class="btn btn-outline-primary" id="test-email-btn">
                                            <i class="bi bi-envelope"></i> Send Test Email
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <hr>
                            
                            <!-- Webhook Alerts -->
                            <div class="mb-4">
                                <h6>Webhook Notifications</h6>
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="webhook-alerts-enabled">
                                    <label class="form-check-label" for="webhook-alerts-enabled">
                                        Enable Webhook Alerts
                                    </label>
                                </div>
                                
                                <div id="webhook-settings" style="display: none;">
                                    <div class="mb-3">
                                        <label for="webhook-url" class="form-label">Webhook URL</label>
                                        <input type="url" class="form-control" id="webhook-url" placeholder="https://your-webhook-url.com/alerts">
                                        <div class="form-text">URL to POST alert notifications to</div>
                                    </div>
                                    
                                    <div class="text-center mb-3">
                                        <button type="button" class="btn btn-outline-primary" id="test-webhook-btn">
                                            <i class="bi bi-globe"></i> Send Test Webhook
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <hr>
                            
                            <!-- Push Notifications -->
                            <div class="mb-4">
                                <h6>Mobile Push Notifications</h6>
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="push-alerts-enabled">
                                    <label class="form-check-label" for="push-alerts-enabled">
                                        Enable Push Notifications
                                    </label>
                                </div>
                                
                                <div id="push-settings" style="display: none;">
                                    <div class="alert alert-info">
                                        <strong><i class="bi bi-info-circle"></i> Setup Instructions:</strong>
                                        <ol class="mb-0">
                                            <li>Install the <strong>ntfy</strong> app on your phone (<a href="https://ntfy.sh" target="_blank">iOS</a> / <a href="https://play.google.com/store/apps/details?id=io.heckel.ntfy" target="_blank">Android</a>)</li>
                                            <li>Choose a unique topic name (e.g., "kyle-homenetmon-alerts")</li>
                                            <li>Subscribe to your topic in the ntfy app</li>
                                            <li>Enter the same topic name below</li>
                                        </ol>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="ntfy-topic" class="form-label">Ntfy Topic</label>
                                        <input type="text" class="form-control" id="ntfy-topic" placeholder="your-unique-topic-name">
                                        <div class="form-text">Choose a unique topic name for your notifications</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="ntfy-server" class="form-label">Ntfy Server</label>
                                        <input type="url" class="form-control" id="ntfy-server" placeholder="https://ntfy.sh">
                                        <div class="form-text">Default server is free. You can use your own ntfy server</div>
                                    </div>
                                    
                                    <div class="text-center mb-3">
                                        <button type="button" class="btn btn-outline-success" id="test-push-btn">
                                            <i class="bi bi-phone-vibrate"></i> Send Test Notification
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <hr>
                            
                            <!-- Alert Thresholds -->
                            <div class="mb-4">
                                <h6>Alert Thresholds</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="device-down-threshold" class="form-label">Device Down Threshold (minutes)</label>
                                        <input type="number" class="form-control" id="device-down-threshold" min="1" max="60">
                                        <div class="form-text">Alert after device is down for X minutes</div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="high-latency-threshold" class="form-label">High Latency Threshold (ms)</label>
                                        <input type="number" class="form-control" id="high-latency-threshold" min="100" max="10000">
                                        <div class="form-text">Alert when response time exceeds X milliseconds</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Alert Sensitivity -->
                            <div class="mb-4">
                                <h6>Alert Sensitivity & Control</h6>
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i>
                                    Configure how sensitive the alert system is to various events. Lower sensitivity = fewer alerts.
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-4">
                                        <label for="alert-sensitivity" class="form-label">Overall Alert Sensitivity</label>
                                        <select class="form-select" id="alert-sensitivity">
                                            <option value="low" selected>Low (Fewer alerts)</option>
                                            <option value="medium">Medium (Balanced)</option>
                                            <option value="high">High (More alerts)</option>
                                        </select>
                                        <div class="form-text">Overall sensitivity level for all alert types</div>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label for="performance-alert-enabled" class="form-label">Performance Alerts</label>
                                        <select class="form-select" id="performance-alert-enabled">
                                            <option value="disabled">Disabled</option>
                                            <option value="critical-only" selected>Critical Only</option>
                                            <option value="enabled">Enabled</option>
                                        </select>
                                        <div class="form-text">Enable or disable performance monitoring alerts</div>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label for="security-alert-enabled" class="form-label">Security Alerts</label>
                                        <select class="form-select" id="security-alert-enabled">
                                            <option value="disabled">Disabled</option>
                                            <option value="critical-only" selected>Critical Only</option>
                                            <option value="enabled">Enabled</option>
                                        </select>
                                        <div class="form-text">Enable or disable security scanning alerts</div>
                                    </div>
                                </div>
                                
                                <div class="row mt-3">
                                    <div class="col-md-4">
                                        <label for="anomaly-alert-enabled" class="form-label">Anomaly Detection Alerts</label>
                                        <select class="form-select" id="anomaly-alert-enabled">
                                            <option value="disabled" selected>Disabled (Recommended)</option>
                                            <option value="critical-only">Critical Only</option>
                                            <option value="enabled">Enabled</option>
                                        </select>
                                        <div class="form-text">Anomaly alerts can be noisy - consider disabling</div>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label for="consecutive-failures" class="form-label">Consecutive Failures Required</label>
                                        <input type="number" class="form-control" id="consecutive-failures" min="1" max="10" value="5">
                                        <div class="form-text">Number of consecutive failures before alerting</div>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label for="alert-frequency" class="form-label">Alert Check Frequency (minutes)</label>
                                        <input type="number" class="form-control" id="alert-frequency" min="1" max="60" value="10">
                                        <div class="form-text">How often to check for new alerts</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <button type="submit" class="btn btn-primary">Save Alert Settings</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- System Settings -->
            <div class="tab-pane fade" id="system-settings">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">System Configuration</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <h6>Data Retention</h6>
                            <p class="text-muted">Configure how long to keep monitoring data</p>
                            <!-- This would be implemented based on specific requirements -->
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i>
                                Data retention is currently set to 30 days and managed automatically.
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <h6>Backup & Restore</h6>
                            <p class="text-muted">Backup and restore your HomeNetMon configuration</p>
                            <div class="btn-group">
                                <button class="btn btn-outline-primary" id="backup-config-btn">
                                    <i class="bi bi-download"></i> Download Configuration
                                </button>
                                <button class="btn btn-outline-secondary" id="restore-config-btn">
                                    <i class="bi bi-upload"></i> Restore Configuration
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <h6>Reset Settings</h6>
                            <p class="text-muted">Reset all settings to default values</p>
                            <button class="btn btn-outline-danger" id="reset-settings-btn">
                                <i class="bi bi-arrow-clockwise"></i> Reset to Defaults
                            </button>
                        </div>
                        
                        <div class="mb-4">
                            <h6>Data Management</h6>
                            <p class="text-muted">Reset historical monitoring data to start fresh uptime calculations</p>
                            <button class="btn btn-outline-danger" id="reset-ping-history-btn">
                                <i class="bi bi-database-dash"></i> Reset Ping History
                            </button>
                            <div class="form-text mt-2">
                                <i class="bi bi-exclamation-triangle text-danger"></i> 
                                This will permanently delete all historical ping data. Uptime percentages will start calculating fresh from now.
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <h6>System Control</h6>
                            <p class="text-muted">Restart the HomeNetMon application and all monitoring services</p>
                            <button class="btn btn-warning" id="restart-system-btn">
                                <i class="bi bi-power"></i> Restart HomeNetMon
                            </button>
                            <div class="form-text mt-2">
                                <i class="bi bi-exclamation-triangle text-warning"></i> 
                                This will restart the entire application and briefly interrupt monitoring.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let networkConfig = {};
let alertConfig = {};

// Load network configuration
async function loadNetworkConfig() {
    try {
        const response = await fetch('/api/config/network');
        networkConfig = await response.json();
        
        // Populate form
        document.getElementById('network-range').value = networkConfig.network_range || '';
        document.getElementById('ping-interval').value = networkConfig.ping_interval || '';
        document.getElementById('scan-interval').value = networkConfig.scan_interval || '';
        document.getElementById('ping-timeout').value = networkConfig.ping_timeout || '';
        document.getElementById('max-workers').value = networkConfig.max_workers || '';
        
        // Update network range display
        if (networkConfig.network_range) {
            updateNetworkRangeDisplay(networkConfig.network_range);
            // Also update the "Currently monitoring" display
            document.getElementById('current-network-display').textContent = networkConfig.network_range;
        }
        
    } catch (error) {
        console.error('Error loading network config:', error);
        
        let errorMessage = 'Failed to load network configuration';
        let recoveryAction = 'Check your connection and try refreshing the page';
        
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
            errorMessage = 'Cannot connect to HomeNetMon server';
            recoveryAction = 'Verify the service is running and refresh the page';
        }
        
        showEnhancedToast(errorMessage, recoveryAction, 'error', function() {
            loadNetworkConfig();
        });
    }
}

// Load current monitoring status
async function loadMonitoringStatus() {
    try {
        const response = await fetch('/api/monitoring/background-activity');
        const data = await response.json();
        
        // Format time function
        function formatTimeAgo(dateStr) {
            if (!dateStr) return 'never';
            const now = new Date();
            const date = new Date(dateStr);
            const diff = now - date;
            const minutes = Math.floor(diff / (1000 * 60));
            const hours = Math.floor(minutes / 60);
            
            if (minutes < 1) return 'just now';
            else if (minutes < 60) return `${minutes}m ago`;
            else if (hours < 24) return `${hours}h ago`;
            else return `${Math.floor(hours / 24)}d ago`;
        }
        
        function formatTimeUntil(dateStr) {
            if (!dateStr) return 'unknown';
            const now = new Date();
            const date = new Date(dateStr);
            const diff = date - now;
            const minutes = Math.floor(diff / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            if (diff <= 0) return 'due now';
            else if (minutes > 0) return `in ${minutes}m ${seconds}s`;
            else return `in ${seconds}s`;
        }
        
        // Update UI
        document.getElementById('current-last-ping').textContent = formatTimeAgo(data.last_ping_time);
        document.getElementById('current-last-scan').textContent = formatTimeAgo(data.last_scan_time);
        document.getElementById('current-next-ping').textContent = `in ~${Math.round(data.ping_interval_seconds / 60)}min`;
        document.getElementById('current-next-scan').textContent = formatTimeUntil(data.next_scan_time);
        
    } catch (error) {
        console.error('Error loading monitoring status:', error);
        document.getElementById('current-last-ping').textContent = 'error';
        document.getElementById('current-last-scan').textContent = 'error';
        document.getElementById('current-next-ping').textContent = 'error';
        document.getElementById('current-next-scan').textContent = 'error';
    }
}

// Preset interval functions
function setPingInterval(seconds) {
    document.getElementById('ping-interval').value = seconds;
}

function setScanInterval(seconds) {
    document.getElementById('scan-interval').value = seconds;
}

// Network range functions
function setNetworkRange(range) {
    const input = document.getElementById('network-range');
    const saveButton = document.getElementById('save-network-range-btn');
    
    input.value = range;
    updateNetworkRangeDisplay(range);
    
    // Update the "Currently monitoring" display immediately
    document.getElementById('current-network-display').textContent = range;
    
    // Clear validation classes and hide save button for preset values
    input.classList.remove('is-valid', 'is-invalid');
    saveButton.style.display = 'none';
    document.getElementById('network-range-help').style.display = 'none';
    
    showRestartButton();
}

function updateNetworkRangeDisplay(cidr) {
    try {
        if (!cidr) return;
        
        const parts = cidr.split('/');
        if (parts.length !== 2) return;
        
        const network = parts[0];
        const prefix = parseInt(parts[1]);
        
        // Calculate range for /24 networks (most common)
        if (prefix === 24) {
            const octets = network.split('.');
            if (octets.length === 4) {
                const baseNetwork = `${octets[0]}.${octets[1]}.${octets[2]}`;
                const rangeText = `${baseNetwork}.1 - ${baseNetwork}.254`;
                
                document.getElementById('current-network-display').textContent = cidr;
                document.getElementById('current-network-range').textContent = rangeText;
            }
        } else {
            // For other prefixes, show general info
            document.getElementById('current-network-display').textContent = cidr;
            document.getElementById('current-network-range').textContent = `/${prefix} network`;
        }
    } catch (error) {
        console.error('Error updating network range display:', error);
    }
}

async function detectNetworkRange() {
    try {
        const button = event.target.closest('button');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="bi bi-hourglass-split"></i> Detecting...';
        button.disabled = true;
        
        // Try to detect from current devices
        const response = await fetch('/api/devices');
        const data = await response.json();
        
        if (data.devices && data.devices.length > 0) {
            // Analyze IP addresses to guess network range
            const ips = data.devices.map(d => d.ip_address);
            const networkGuess = guessNetworkFromIPs(ips);
            
            if (networkGuess) {
                setNetworkRange(networkGuess);
                showToast(`Detected network range: ${networkGuess}`, 'success');
            } else {
                showToast('Could not auto-detect network range', 'warning');
            }
        } else {
            showToast('No devices found to analyze network range', 'info');
        }
        
        button.innerHTML = originalText;
        button.disabled = false;
        
    } catch (error) {
        console.error('Error detecting network range:', error);
        showToast('Error detecting network range', 'error');
        
        const button = event.target.closest('button');
        button.innerHTML = '<i class="bi bi-search"></i> Auto-detect';
        button.disabled = false;
    }
}

function guessNetworkFromIPs(ips) {
    if (!ips || ips.length === 0) return null;
    
    try {
        // Analyze the most common network pattern
        const networks = {};
        
        ips.forEach(ip => {
            const parts = ip.split('.');
            if (parts.length === 4) {
                const network = `${parts[0]}.${parts[1]}.${parts[2]}.0/24`;
                networks[network] = (networks[network] || 0) + 1;
            }
        });
        
        // Return the most common network
        let maxCount = 0;
        let bestNetwork = null;
        
        for (const [network, count] of Object.entries(networks)) {
            if (count > maxCount) {
                maxCount = count;
                bestNetwork = network;
            }
        }
        
        return bestNetwork;
    } catch (error) {
        console.error('Error guessing network from IPs:', error);
        return null;
    }
}

// Save network configuration
async function saveNetworkConfig(event) {
    event.preventDefault();
    
    try {
        const formData = {
            network_range: document.getElementById('network-range').value.trim(),
            ping_interval: parseInt(document.getElementById('ping-interval').value),
            scan_interval: parseInt(document.getElementById('scan-interval').value),
            ping_timeout: parseFloat(document.getElementById('ping-timeout').value),
            max_workers: parseInt(document.getElementById('max-workers').value)
        };
        
        const response = await fetch('/api/config/network', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            const data = await response.json();
            showToast('Network configuration saved successfully', 'success');
        } else {
            const error = await response.json();
            showToast(error.error || 'Error saving network configuration', 'error');
        }
        
    } catch (error) {
        console.error('Error saving network config:', error);
        
        // Enhanced error handling with recovery suggestions
        let errorMessage = 'Network configuration could not be saved';
        let recoveryAction = 'Please check your inputs and try again';
        
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
            errorMessage = 'Unable to connect to HomeNetMon server';
            recoveryAction = 'Check if the service is running and refresh the page';
        } else if (error.message && error.message.includes('timeout')) {
            errorMessage = 'Request timed out while saving configuration';
            recoveryAction = 'The server may be busy. Wait a moment and try again';
        }
        
        showEnhancedToast(errorMessage, recoveryAction, 'error', function() {
            // Retry action - re-trigger form submission
            document.querySelector('#network-config-form').dispatchEvent(new Event('submit'));
        });
    }
}

// Load alert configuration
async function loadAlertConfig() {
    try {
        const response = await fetch('/api/config/alerts');
        alertConfig = await response.json();
        
        // Populate form
        document.getElementById('email-alerts-enabled').checked = alertConfig.email_enabled || false;
        document.getElementById('webhook-alerts-enabled').checked = alertConfig.webhook_enabled || false;
        document.getElementById('push-alerts-enabled').checked = alertConfig.push_enabled || false;
        document.getElementById('email-from').value = alertConfig.email_from || '';
        document.getElementById('email-to').value = alertConfig.email_to || '';
        document.getElementById('webhook-url').value = alertConfig.webhook_url || '';
        document.getElementById('ntfy-topic').value = alertConfig.ntfy_topic || '';
        document.getElementById('ntfy-server').value = alertConfig.ntfy_server || 'https://ntfy.sh';
        document.getElementById('device-down-threshold').value = alertConfig.device_down_threshold || '';
        document.getElementById('high-latency-threshold').value = alertConfig.high_latency_threshold || '';
        
        // Show/hide sections based on enabled state
        toggleEmailSettings();
        toggleWebhookSettings();
        togglePushSettings();
        
    } catch (error) {
        console.error('Error loading alert config:', error);
        
        let errorMessage = 'Failed to load alert configuration';
        let recoveryAction = 'Verify your connection and try again';
        
        if (error.name === 'TypeError') {
            errorMessage = 'Connection to server failed';
            recoveryAction = 'Check if HomeNetMon service is running';
        }
        
        showEnhancedToast(errorMessage, recoveryAction, 'error', function() {
            loadAlertConfig();
        });
    }
}

// Save alert configuration
async function saveAlertConfig(event) {
    event.preventDefault();
    
    try {
        const formData = {
            email_enabled: document.getElementById('email-alerts-enabled').checked,
            webhook_enabled: document.getElementById('webhook-alerts-enabled').checked,
            push_enabled: document.getElementById('push-alerts-enabled').checked,
            email_from: document.getElementById('email-from').value.trim(),
            email_to: document.getElementById('email-to').value.trim(),
            webhook_url: document.getElementById('webhook-url').value.trim(),
            ntfy_topic: document.getElementById('ntfy-topic').value.trim(),
            ntfy_server: document.getElementById('ntfy-server').value.trim(),
            device_down_threshold: parseInt(document.getElementById('device-down-threshold').value),
            high_latency_threshold: parseInt(document.getElementById('high-latency-threshold').value)
        };
        
        const response = await fetch('/api/config/alerts', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            showToast('Alert configuration saved successfully', 'success');
        } else {
            const error = await response.json();
            showToast(error.error || 'Error saving alert configuration', 'error');
        }
        
    } catch (error) {
        console.error('Error saving alert config:', error);
        showToast('Error saving alert configuration', 'error');
    }
}

// Quick save function for network range only
async function saveNetworkRangeQuick() {
    try {
        const networkRange = document.getElementById('network-range').value.trim();
        
        if (!networkRange) {
            showToast('Please enter a network range', 'warning');
            return;
        }
        
        // Basic client-side validation
        const cidrPattern = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\/(?:[0-9]|[1-2][0-9]|3[0-2])$/;
        if (!cidrPattern.test(networkRange)) {
            showToast('Invalid network range format. Use CIDR notation (e.g., 192.168.1.0/24)', 'error');
            return;
        }
        
        const formData = {
            network_range: networkRange
        };
        
        const saveButton = document.getElementById('save-network-range-btn');
        const originalText = saveButton.innerHTML;
        saveButton.disabled = true;
        saveButton.innerHTML = '<i class="bi bi-hourglass-split"></i> Saving...';
        
        const response = await fetch('/api/config/network', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            const data = await response.json();
            showToast('Network range saved successfully!', 'success');
            
            // Hide the save button after successful save
            saveButton.style.display = 'none';
            
            // Trigger a network scan with the new range
            showToast('Triggering network scan with new range...', 'info');
            setTimeout(() => {
                fetch('/api/monitoring/scan', { method: 'POST' })
                    .then(() => showToast('Network scan started', 'success'))
                    .catch(() => showToast('Network scan trigger failed', 'warning'));
            }, 1000);
            
        } else {
            const error = await response.json();
            showToast(error.error || 'Error saving network range', 'error');
        }
        
    } catch (error) {
        console.error('Error saving network range:', error);
        showToast('Error saving network range', 'error');
    } finally {
        const saveButton = document.getElementById('save-network-range-btn');
        saveButton.disabled = false;
        saveButton.innerHTML = '<i class="bi bi-check2"></i> Save';
    }
}

// Dashboard title management functions
async function saveDashboardTitle() {
    try {
        const title = document.getElementById('dashboard-title').value.trim();
        
        if (!title || title.length < 1 || title.length > 50) {
            showToast('Please enter a valid title (1-50 characters)', 'warning');
            document.getElementById('dashboard-title').classList.add('is-invalid');
            return;
        }
        
        const saveButton = document.getElementById('save-dashboard-title-btn');
        const originalText = saveButton.innerHTML;
        saveButton.disabled = true;
        saveButton.innerHTML = '<i class="bi bi-hourglass-split"></i> Saving...';
        
        const response = await fetch('/api/config/dashboard-title', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ title: title })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            showToast('Dashboard title updated successfully!', 'success');
            document.getElementById('dashboard-title-preview').textContent = title;
            document.getElementById('dashboard-title').classList.remove('is-invalid');
            document.getElementById('dashboard-title').classList.add('is-valid');
            
            // Hide save button after successful save
            setTimeout(() => {
                saveButton.style.display = 'none';
                document.getElementById('dashboard-title').classList.remove('is-valid');
            }, 1000);
            
        } else {
            showToast(data.error || 'Error saving dashboard title', 'error');
        }
        
    } catch (error) {
        console.error('Error saving dashboard title:', error);
        showToast('Error saving dashboard title', 'error');
    } finally {
        const saveButton = document.getElementById('save-dashboard-title-btn');
        saveButton.disabled = false;
        saveButton.innerHTML = '<i class="bi bi-check2"></i> Save';
    }
}

function resetDashboardTitle() {
    const defaultTitle = 'Home Network Dashboard';
    document.getElementById('dashboard-title').value = defaultTitle;
    document.getElementById('dashboard-title-preview').textContent = defaultTitle;
    document.getElementById('save-dashboard-title-btn').style.display = 'inline-block';
}

// Handle dashboard title input changes
document.addEventListener('DOMContentLoaded', function() {
    const titleInput = document.getElementById('dashboard-title');
    if (titleInput) {
        titleInput.addEventListener('input', function() {
            const saveButton = document.getElementById('save-dashboard-title-btn');
            const preview = document.getElementById('dashboard-title-preview');
            
            if (this.value.trim() !== '{{ dashboard_title }}') {
                saveButton.style.display = 'inline-block';
            } else {
                saveButton.style.display = 'none';
            }
            
            // Update preview
            preview.textContent = this.value.trim() || 'Home Network Dashboard';
            
            // Validation
            if (this.value.length > 50) {
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
            }
        });
    }
});

// Toggle email settings visibility
function toggleEmailSettings() {
    const enabled = document.getElementById('email-alerts-enabled').checked;
    document.getElementById('email-settings').style.display = enabled ? 'block' : 'none';
}

// Toggle webhook settings visibility
function toggleWebhookSettings() {
    const enabled = document.getElementById('webhook-alerts-enabled').checked;
    document.getElementById('webhook-settings').style.display = enabled ? 'block' : 'none';
}

// Toggle push notification settings visibility
function togglePushSettings() {
    const enabled = document.getElementById('push-alerts-enabled').checked;
    document.getElementById('push-settings').style.display = enabled ? 'block' : 'none';
}

// Test email configuration
async function testEmail() {
    try {
        const emailData = {
            from_email: document.getElementById('email-from').value.trim(),
            to_emails: document.getElementById('email-to').value.trim()
        };
        
        if (!emailData.from_email || !emailData.to_emails) {
            showToast('Please fill in email configuration first', 'warning');
            return;
        }
        
        const button = document.getElementById('test-email-btn');
        const originalText = button.innerHTML;
        button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sending...';
        button.disabled = true;
        
        const response = await fetch('/api/config/test/email', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(emailData)
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showToast('Test email sent successfully', 'success');
        } else {
            showToast(data.error || 'Error sending test email', 'error');
        }
        
        button.innerHTML = originalText;
        button.disabled = false;
        
    } catch (error) {
        console.error('Error testing email:', error);
        showToast('Error testing email configuration', 'error');
        
        const button = document.getElementById('test-email-btn');
        button.innerHTML = '<i class="bi bi-envelope"></i> Send Test Email';
        button.disabled = false;
    }
}

// Test webhook configuration
async function testWebhook() {
    try {
        const webhookUrl = document.getElementById('webhook-url').value.trim();
        
        if (!webhookUrl) {
            showToast('Please enter webhook URL first', 'warning');
            return;
        }
        
        const button = document.getElementById('test-webhook-btn');
        const originalText = button.innerHTML;
        button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sending...';
        button.disabled = true;
        
        const response = await fetch('/api/config/test/webhook', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ webhook_url: webhookUrl })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showToast('Test webhook sent successfully', 'success');
        } else {
            showToast(data.error || 'Error sending test webhook', 'error');
        }
        
        button.innerHTML = originalText;
        button.disabled = false;
        
    } catch (error) {
        console.error('Error testing webhook:', error);
        showToast('Error testing webhook configuration', 'error');
        
        const button = document.getElementById('test-webhook-btn');
        button.innerHTML = '<i class="bi bi-globe"></i> Send Test Webhook';
        button.disabled = false;
    }
}

// Test push notification configuration
async function testPush() {
    try {
        const button = document.getElementById('test-push-btn');
        button.innerHTML = '<i class="bi bi-hourglass-split"></i> Sending...';
        button.disabled = true;
        
        const response = await fetch('/api/config/test/push', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast(result.message, 'success');
        } else {
            showToast(result.error || 'Failed to send test notification', 'error');
        }
        
        button.innerHTML = '<i class="bi bi-phone-vibrate"></i> Send Test Notification';
        button.disabled = false;
        
    } catch (error) {
        console.error('Error testing push notifications:', error);
        showToast('Error testing push notification configuration', 'error');
        
        const button = document.getElementById('test-push-btn');
        button.innerHTML = '<i class="bi bi-phone-vibrate"></i> Send Test Notification';
        button.disabled = false;
    }
}

// Restart services
async function restartServices() {
    const button = document.getElementById('restart-services-btn');
    const originalText = button.innerHTML;
    
    try {
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Restarting...';
        button.disabled = true;
        
        const response = await fetch('/api/config/restart-services', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast(data.message, 'success');
            
            // Hide the restart button after successful restart
            setTimeout(() => {
                button.style.display = 'none';
                document.getElementById('restart-notice').innerHTML = 
                    '<i class="bi bi-check-circle text-success"></i> <span class="text-success">Services restart initiated successfully</span>';
            }, 1000);
        } else {
            showToast(data.error || 'Error restarting services', 'error');
            button.innerHTML = originalText;
            button.disabled = false;
        }
        
    } catch (error) {
        console.error('Error restarting services:', error);
        showToast('Error restarting services', 'error');
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

// Show restart button when network range changes
function showRestartButton() {
    const button = document.getElementById('restart-services-btn');
    const notice = document.getElementById('restart-notice');
    
    button.style.display = 'inline-block';
    notice.innerHTML = '<i class="bi bi-exclamation-triangle text-warning"></i> <span class="text-warning">Network range changed. Restart required to apply changes.</span>';
}

// Restart system
async function restartSystem() {
    if (!confirm('Are you sure you want to restart HomeNetMon? This will temporarily interrupt monitoring for about 10-15 seconds.')) {
        return;
    }
    
    const button = document.getElementById('restart-system-btn');
    const originalText = button.innerHTML;
    
    try {
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Restarting Application...';
        button.disabled = true;
        
        const response = await fetch('/api/config/restart-system', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast(data.message, 'success');
            
            // Show countdown and then refresh
            let countdown = 15;
            const countdownInterval = setInterval(() => {
                button.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>Restarting... (${countdown}s)`;
                countdown--;
                
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    // Refresh the page after restart
                    window.location.reload();
                }
            }, 1000);
        } else {
            showToast(data.error || 'Error restarting system', 'error');
            button.innerHTML = originalText;
            button.disabled = false;
        }
        
    } catch (error) {
        console.error('Error restarting system:', error);
        showToast('Error restarting system', 'error');
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

// Reset ping history
async function resetPingHistory() {
    // First confirmation
    if (!confirm('⚠️ WARNING: This will permanently delete ALL historical ping data!\n\nThis includes:\n• All uptime history\n• All response time data\n• All monitoring records\n\nUptime percentages will start fresh from 0%.\n\nAre you sure you want to continue?')) {
        return;
    }
    
    // Second confirmation with more specific warning
    if (!confirm('🚨 FINAL WARNING: This action CANNOT be undone!\n\n• Your router showing 70% uptime will reset to 0%\n• All devices will start with 0% uptime\n• Historical charts will be empty\n• This affects ALL devices\n\nClick OK only if you understand these consequences.')) {
        return;
    }
    
    const button = document.getElementById('reset-ping-history-btn');
    const originalText = button.innerHTML;
    
    try {
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Deleting Historical Data...';
        button.disabled = true;
        
        const response = await fetch('/api/config/reset-monitoring-data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                confirm: true
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast(data.message, 'success');
            
            // Show detailed success information
            const details = data.details;
            const successMessage = `
                <div class="alert alert-success mt-3">
                    <h6><i class="bi bi-check-circle"></i> Historical Data Reset Complete</h6>
                    <ul class="mb-0">
                        <li>Deleted ${details.total_deleted} monitoring records</li>
                        <li>Time span: ${details.time_span || 'Unknown'}</li>
                        <li>Reset ${details.devices_reset} devices</li>
                        <li>New monitoring started at: ${new Date(details.reset_time).toLocaleString()}</li>
                    </ul>
                    <p class="mt-2 mb-0"><strong>All uptime percentages will now start calculating fresh!</strong></p>
                </div>
            `;
            
            button.parentNode.insertAdjacentHTML('afterend', successMessage);
            button.innerHTML = '<i class="bi bi-check-circle"></i> Data Reset Complete';
            button.classList.remove('btn-outline-danger');
            button.classList.add('btn-success');
            
        } else {
            showToast(data.error || 'Error resetting ping history', 'error');
            button.innerHTML = originalText;
            button.disabled = false;
        }
        
    } catch (error) {
        console.error('Error resetting ping history:', error);
        showToast('Error resetting ping history', 'error');
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

// Reset settings
async function resetSettings() {
    if (!confirm('Are you sure you want to reset all settings to defaults? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/config/reset', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ confirm: true })
        });
        
        if (response.ok) {
            showToast('Settings reset to defaults successfully', 'success');
            // Reload configurations
            setTimeout(() => {
                loadNetworkConfig();
                loadAlertConfig();
            }, 1000);
        } else {
            const error = await response.json();
            showToast(error.error || 'Error resetting settings', 'error');
        }
        
    } catch (error) {
        console.error('Error resetting settings:', error);
        showToast('Error resetting settings', 'error');
    }
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Load configurations
    loadNetworkConfig();
    loadAlertConfig();
    loadMonitoringStatus();
    
    // Auto-refresh monitoring status every 10 seconds
    setInterval(loadMonitoringStatus, 10000);
    
    // Form event listeners
    document.getElementById('network-settings-form').addEventListener('submit', saveNetworkConfig);
    document.getElementById('alert-settings-form').addEventListener('submit', saveAlertConfig);
    
    // Toggle event listeners
    document.getElementById('email-alerts-enabled').addEventListener('change', toggleEmailSettings);
    document.getElementById('webhook-alerts-enabled').addEventListener('change', toggleWebhookSettings);
    document.getElementById('push-alerts-enabled').addEventListener('change', togglePushSettings);
    
    // Test button event listeners
    document.getElementById('test-email-btn').addEventListener('click', testEmail);
    document.getElementById('test-webhook-btn').addEventListener('click', testWebhook);
    document.getElementById('test-push-btn').addEventListener('click', testPush);
    
    // System actions
    document.getElementById('reset-settings-btn').addEventListener('click', resetSettings);
    document.getElementById('restart-services-btn').addEventListener('click', restartServices);
    document.getElementById('restart-system-btn').addEventListener('click', restartSystem);
    document.getElementById('reset-ping-history-btn').addEventListener('click', resetPingHistory);
    
    // Network range change detection with real-time validation
    document.getElementById('network-range').addEventListener('input', function() {
        const newRange = this.value.trim();
        const saveButton = document.getElementById('save-network-range-btn');
        
        if (newRange) {
            // Update the "Currently monitoring" display as user types
            document.getElementById('current-network-display').textContent = newRange;
            updateNetworkRangeDisplay(newRange);
            
            // Show save button when user types manually
            saveButton.style.display = 'block';
            
            // Basic validation feedback
            const cidrPattern = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\/(?:[0-9]|[1-2][0-9]|3[0-2])$/;
            const input = this;
            
            if (cidrPattern.test(newRange)) {
                input.classList.remove('is-invalid');
                input.classList.add('is-valid');
                saveButton.disabled = false;
                document.getElementById('network-range-help').style.display = 'block';
            } else {
                input.classList.remove('is-valid');
                input.classList.add('is-invalid');
                saveButton.disabled = true;
                document.getElementById('network-range-help').style.display = 'none';
            }
        } else {
            // Hide save button if input is empty
            saveButton.style.display = 'none';
            this.classList.remove('is-valid', 'is-invalid');
            document.getElementById('network-range-help').style.display = 'none';
        }
        showRestartButton();
    });
});
</script>
{% endblock %}