{% extends "base.html" %}

{% block title %}Dashboard - HomeNetMon{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-speedometer2"></i> Kyle's Network Dashboard</h1>
    
    <div class="btn-group" role="group">
        <button type="button" class="btn btn-outline-primary" id="refresh-btn">
            <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
        <button type="button" class="btn btn-outline-primary" id="scan-btn">
            <i class="bi bi-search"></i> Scan Network
        </button>
        <button type="button" class="btn btn-outline-success" id="ping-all-btn">
            <i class="bi bi-broadcast"></i> Ping All
        </button>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-warning dropdown-toggle" data-bs-toggle="dropdown" id="bulk-actions-btn">
                <i class="bi bi-gear"></i> Bulk Actions
            </button>
            <ul class="dropdown-menu">
                <li><h6 class="dropdown-header">Device Control</h6></li>
                <li><a class="dropdown-item" href="#" id="bulk-wake-on-lan"><i class="bi bi-power"></i> Wake Selected</a></li>
                <li><a class="dropdown-item" href="#" id="bulk-ping-devices"><i class="bi bi-wifi"></i> Ping Selected</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><h6 class="dropdown-header">Management</h6></li>
                <li><a class="dropdown-item" href="#" id="bulk-enable-monitoring"><i class="bi bi-check-circle"></i> Enable Monitoring</a></li>
                <li><a class="dropdown-item" href="#" id="bulk-disable-monitoring"><i class="bi bi-x-circle"></i> Disable Monitoring</a></li>
                <li><a class="dropdown-item" href="#" id="bulk-set-group"><i class="bi bi-collection"></i> Set Group</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item text-danger" href="#" id="bulk-delete-devices"><i class="bi bi-trash"></i> Delete Selected</a></li>
            </ul>
        </div>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="bi bi-eye"></i> View
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" id="view-grid">Grid View</a></li>
                <li><a class="dropdown-item" href="#" id="view-list">List View</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" id="enable-selection-mode"><i class="bi bi-check-square"></i> Enable Selection</a></li>
            </ul>
        </div>
    </div>
</div>

<!-- System Status Bar -->
<div id="status-bar" class="mb-3 fade-in" style="display: block;">
    <div class="card border-primary">
        <div class="card-header bg-primary text-white py-2">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <strong><i class="bi bi-activity me-2"></i>HomeNetMon System Status</strong>
                    <div id="activity-spinner" class="spinner-border spinner-border-sm ms-2" style="display: none;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div class="col-md-8 text-end">
                    <span id="system-status-text" class="badge bg-success">All Systems Operational</span>
                </div>
            </div>
        </div>
        <div class="card-body py-2">
            <div class="row g-0">
                <!-- Current Date/Time -->
                <div class="col-md-3 border-end pe-3">
                    <div class="text-center">
                        <small class="text-muted d-block">Current Date & Time</small>
                        <strong class="text-primary">
                            <i class="bi bi-calendar-check me-1"></i>
                            <span id="current-date">-</span>
                        </strong>
                        <div class="small text-dark mt-1">
                            <i class="bi bi-clock me-1"></i>
                            <span id="current-time">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- Service Uptime -->
                <div class="col-md-3 border-end pe-3">
                    <div class="text-center">
                        <small class="text-muted d-block">Service Uptime</small>
                        <strong class="text-success">
                            <i class="bi bi-server me-1"></i>
                            <span id="service-uptime">-</span>
                        </strong>
                        <div class="small text-muted mt-1">
                            Started: <span id="service-start-time">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- Network Scanning -->
                <div class="col-md-3 border-end pe-3">
                    <div class="text-center">
                        <small class="text-muted d-block">Network Scanning</small>
                        <div class="small">
                            <div class="mb-1">
                                <i class="bi bi-search text-info me-1"></i>
                                Last: <span id="last-scan-time">-</span>
                            </div>
                            <div>
                                <i class="bi bi-arrow-clockwise text-primary me-1"></i>
                                Next: <span id="next-scan-time">-</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Device Monitoring -->
                <div class="col-md-3">
                    <div class="text-center">
                        <small class="text-muted d-block">Device Monitoring</small>
                        <div class="small">
                            <div class="mb-1">
                                <i class="bi bi-wifi text-success me-1"></i>
                                Last: <span id="last-ping-time">-</span>
                            </div>
                            <div>
                                <i class="bi bi-broadcast text-primary me-1"></i>
                                Next: <span id="next-ping-time">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ping All Progress Bar -->
<div id="ping-progress-container" class="mb-4" style="display: none;">
    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Pinging All Devices</h6>
                <span id="ping-progress-text">0 / 0 devices</span>
            </div>
            <div class="progress">
                <div id="ping-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                </div>
            </div>
            <div class="mt-2 d-flex justify-content-between">
                <small class="text-success">
                    <i class="bi bi-check-circle"></i> 
                    <span id="ping-success-count">0</span> successful
                </small>
                <small class="text-danger">
                    <i class="bi bi-x-circle"></i> 
                    <span id="ping-fail-count">0</span> failed
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Network Scan Progress Bar -->
<div id="scan-progress-container" class="mb-4" style="display: none;">
    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">
                    <i class="bi bi-radar me-2"></i>
                    Scanning Network
                </h6>
                <span id="scan-progress-text">Initializing...</span>
            </div>
            <div class="progress">
                <div id="scan-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-info" 
                     role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                </div>
            </div>
            <div class="mt-2 d-flex justify-content-between">
                <small class="text-info">
                    <i class="bi bi-search"></i> 
                    Discovering devices on 192.168.86.0/24
                </small>
                <small class="text-success">
                    <i class="bi bi-plus-circle"></i> 
                    <span id="scan-new-devices">0</span> new devices found
                </small>
            </div>
        </div>
    </div>
</div>


<!-- Bulk Selection Controls -->
<div id="bulk-selection-controls" class="card mb-3" style="display: none;">
    <div class="card-body py-2">
        <div class="row align-items-center">
            <div class="col-md-4">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="select-all-devices">
                    <label class="form-check-label fw-bold" for="select-all-devices">
                        Select All Devices
                    </label>
                </div>
            </div>
            <div class="col-md-4 text-center">
                <span class="badge bg-primary" id="selected-count">0 devices selected</span>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-sm btn-outline-secondary" id="clear-selection">
                    <i class="bi bi-x-circle"></i> Clear Selection
                </button>
                <button class="btn btn-sm btn-outline-primary" id="toggle-selection-mode">
                    <i class="bi bi-check-square"></i> Exit Selection
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Filters and Search -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row align-items-end">
            <div class="col-md-3">
                <label for="search-input" class="form-label">Search Devices</label>
                <div class="search-box">
                    <input type="text" class="form-control" id="search-input" placeholder="Search by name or IP...">
                </div>
            </div>
            
            <div class="col-md-2">
                <label for="filter-status" class="form-label">Status</label>
                <select class="form-select" id="filter-status">
                    <option value="">All</option>
                    <option value="up">Online</option>
                    <option value="down">Offline</option>
                    <option value="warning">Warning</option>
                    <option value="unknown">Unknown</option>
                </select>
            </div>
            
            <div class="col-md-2">
                <label for="filter-type" class="form-label">Type</label>
                <select class="form-select" id="filter-type">
                    <option value="">All Types</option>
                </select>
            </div>
            
            <div class="col-md-2">
                <label for="filter-group" class="form-label">Group</label>
                <select class="form-select" id="filter-group">
                    <option value="">All Groups</option>
                </select>
            </div>
            
            <div class="col-md-3">
                <button type="button" class="btn btn-outline-secondary me-2" id="clear-filters">
                    <i class="bi bi-x-circle"></i> Clear
                </button>
                <button type="button" class="btn btn-primary" id="add-device-btn" data-bs-toggle="modal" data-bs-target="#addDeviceModal">
                    <i class="bi bi-plus-circle"></i> Add Device
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Indicator -->
<div class="text-center py-5" id="loading-indicator">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2 text-muted">Loading devices...</p>
</div>

<!-- Devices Grid/List -->
<div id="devices-container">
    <!-- Grid View -->
    <div id="grid-view" class="row dashboard-grid">
        <!-- Device cards will be inserted here -->
    </div>
    
    <!-- List View -->
    <div id="list-view" class="card" style="display: none;">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Status</th>
                        <th>Name</th>
                        <th>IP Address</th>
                        <th>Type</th>
                        <th>Response Time</th>
                        <th>Uptime</th>
                        <th>Last Seen</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="devices-table-body">
                    <!-- Device rows will be inserted here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- No Devices Message -->
<div class="text-center py-5" id="no-devices" style="display: none;">
    <i class="bi bi-router display-1 text-muted"></i>
    <h3 class="mt-3 text-muted">No devices found</h3>
    <p class="text-muted">Try adjusting your filters or scan the network for new devices.</p>
    <button type="button" class="btn btn-primary" id="scan-network-btn">
        <i class="bi bi-search"></i> Scan Network
    </button>
</div>

<!-- Add Device Modal -->
<div class="modal fade" id="addDeviceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Device</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="add-device-form">
                    <div class="mb-3">
                        <label for="device-ip" class="form-label">IP Address *</label>
                        <input type="text" class="form-control" id="device-ip" required>
                        <div class="form-text">Enter the IP address of the device to monitor</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="device-name" class="form-label">Custom Name</label>
                        <input type="text" class="form-control" id="device-name">
                        <div class="form-text">Optional: Give the device a friendly name</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="device-type" class="form-label">Device Type</label>
                        <select class="form-select" id="device-type">
                            <option value="unknown">Unknown</option>
                            <option value="router">Router</option>
                            <option value="computer">Computer</option>
                            <option value="phone">Phone</option>
                            <option value="iot">IoT Device</option>
                            <option value="printer">Printer</option>
                            <option value="camera">Camera</option>
                            <option value="server">Server</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="device-group" class="form-label">Group</label>
                        <input type="text" class="form-control" id="device-group">
                        <div class="form-text">Optional: Organize devices into groups</div>
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="device-monitor" checked>
                        <label class="form-check-label" for="device-monitor">
                            Monitor this device
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-device-btn">Add Device</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentView = 'grid';
let filteredDevices = [];

// Load devices data
async function loadDevices() {
    try {
        document.getElementById('loading-indicator').style.display = 'block';
        document.getElementById('devices-container').style.display = 'none';
        document.getElementById('no-devices').style.display = 'none';
        
        const response = await fetch('/api/devices');
        const data = await response.json();
        
        devices = data.devices || [];
        filteredDevices = devices;
        
        // Load filter options
        await loadFilterOptions();
        
        // Update sidebar stats
        updateSidebarStats();
        
        // Display devices
        displayDevices();
        
        document.getElementById('loading-indicator').style.display = 'none';
        document.getElementById('devices-container').style.display = 'block';
        
    } catch (error) {
        console.error('Error loading devices:', error);
        showToast('Error loading devices', 'error');
        document.getElementById('loading-indicator').style.display = 'none';
    }
}

// Load filter options
async function loadFilterOptions() {
    try {
        // Load device types
        const typesResponse = await fetch('/api/devices/types');
        const typesData = await typesResponse.json();
        
        const typeSelect = document.getElementById('filter-type');
        typeSelect.innerHTML = '<option value="">All Types</option>';
        typesData.types.forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.textContent = getDeviceTypeDisplayName(type);
            typeSelect.appendChild(option);
        });
        
        // Load device groups
        const groupsResponse = await fetch('/api/devices/groups');
        const groupsData = await groupsResponse.json();
        
        const groupSelect = document.getElementById('filter-group');
        groupSelect.innerHTML = '<option value="">All Groups</option>';
        groupsData.groups.forEach(group => {
            const option = document.createElement('option');
            option.value = group;
            option.textContent = group;
            groupSelect.appendChild(option);
        });
        
    } catch (error) {
        console.error('Error loading filter options:', error);
    }
}

// Get device icon based on device type
function getDeviceIcon(deviceType) {
    const icons = {
        'camera': 'camera-video',
        'router': 'router',
        'apple': 'apple',
        'phone': 'phone',
        'computer': 'laptop',
        'smart_home': 'house-gear',
        'iot': 'cpu',
        'gaming': 'controller',
        'media': 'tv',
        'printer': 'printer',
        'storage': 'hdd-stack',
        'unknown': 'question-circle'
    };
    
    return icons[deviceType] || 'question-circle';
}

// Get device type display name
function getDeviceTypeDisplayName(deviceType) {
    const displayNames = {
        'camera': 'Camera',
        'router': 'Router',
        'apple': 'Apple Device',
        'phone': 'Phone',
        'computer': 'Computer',
        'smart_home': 'Smart Home',
        'iot': 'IoT Device',
        'gaming': 'Gaming',
        'media': 'Media Device',
        'printer': 'Printer',
        'storage': 'Storage',
        'unknown': 'Unknown'
    };
    
    return displayNames[deviceType] || 'Unknown';
}

// Update sidebar statistics
function updateSidebarStats() {
    const statusCounts = {
        up: 0,
        down: 0,
        warning: 0,
        unknown: 0
    };
    
    devices.forEach(device => {
        if (statusCounts.hasOwnProperty(device.status)) {
            statusCounts[device.status]++;
        }
    });
    
    // Update sidebar stats only
    document.getElementById('total-devices').textContent = devices.length;
    document.getElementById('devices-up').textContent = statusCounts.up;
    document.getElementById('devices-down').textContent = statusCounts.down;
}

// Display devices based on current view
function displayDevices() {
    if (filteredDevices.length === 0) {
        document.getElementById('devices-container').style.display = 'none';
        document.getElementById('no-devices').style.display = 'block';
        return;
    }
    
    document.getElementById('devices-container').style.display = 'block';
    document.getElementById('no-devices').style.display = 'none';
    
    if (currentView === 'grid') {
        displayGridView();
    } else {
        displayListView();
    }
}

// Display devices in grid view
function displayGridView() {
    const gridContainer = document.getElementById('grid-view');
    gridContainer.innerHTML = '';
    
    filteredDevices.forEach((device, index) => {
        const card = createDeviceCard(device, index);
        gridContainer.appendChild(card);
    });
}

// Create device card element
function createDeviceCard(device, index = 0) {
    const col = document.createElement('div');
    col.className = `col-md-4 col-lg-3 mb-4 fade-in-delay-${Math.min(index % 3 + 1, 3)}`;
    
    const alertBadge = device.active_alerts > 0 ? 
        `<span class="badge bg-danger alert-badge">${device.active_alerts}</span>` : '';
    
    col.innerHTML = `
        <div class="card device-card h-100" onclick="handleDeviceCardClick(event, ${device.id})">
            <div class="card-body position-relative">
                ${alertBadge}
                <div class="form-check position-absolute top-0 start-0 mt-2 ms-2 device-checkbox" style="display: none;">
                    <input class="form-check-input device-select" type="checkbox" value="${device.id}" onclick="event.stopPropagation();">
                </div>
                
                <div class="d-flex align-items-center mb-2">
                    <span class="status-indicator ${device.status}"></span>
                    <i class="bi bi-${getDeviceIcon(device.device_type)} me-2 text-primary"></i>
                    <h6 class="card-title mb-0">${device.display_name}</h6>
                </div>
                
                <p class="text-muted small mb-2">${device.ip_address}</p>
                
                <div class="row text-center">
                    <div class="col-6">
                        <div class="small text-muted">Response</div>
                        <div class="fw-bold">${formatResponseTime(device.latest_response_time)}</div>
                    </div>
                    <div class="col-6">
                        <div class="small text-muted">Uptime</div>
                        <div class="fw-bold">${formatUptime(device.uptime_percentage)}</div>
                    </div>
                </div>
                
                <div class="mt-2">
                    <span class="badge bg-light text-dark">
                        <i class="bi bi-${getDeviceIcon(device.device_type)} me-1"></i>
                        ${getDeviceTypeDisplayName(device.device_type)}
                    </span>
                    ${device.device_group ? `<span class="badge bg-secondary">${device.device_group}</span>` : ''}
                </div>
            </div>
            
            <div class="card-footer bg-transparent">
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                        ${device.last_seen ? new Date(device.last_seen).toLocaleString() : 'Never'}
                    </small>
                    <div class="btn-group btn-group-sm" onclick="event.stopPropagation()">
                        <button class="btn btn-outline-primary" onclick="pingDevice(${device.id})">
                            <i class="bi bi-wifi"></i>
                        </button>
                        <button class="btn btn-outline-secondary" onclick="editDevice(${device.id})">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    return col;
}

// Display devices in list view
function displayListView() {
    const tbody = document.getElementById('devices-table-body');
    tbody.innerHTML = '';
    
    filteredDevices.forEach(device => {
        const row = createDeviceRow(device);
        tbody.appendChild(row);
    });
}

// Create device table row
function createDeviceRow(device) {
    const row = document.createElement('tr');
    row.style.cursor = 'pointer';
    row.onclick = () => viewDevice(device.id);
    
    const alertBadge = device.active_alerts > 0 ? 
        `<span class="badge bg-danger ms-1">${device.active_alerts}</span>` : '';
    
    row.innerHTML = `
        <td>
            <span class="status-indicator ${device.status}"></span>
            ${device.status}
        </td>
        <td>
            <i class="bi bi-${getDeviceIcon(device.device_type)} me-2 text-primary"></i>
            ${device.display_name}
            ${alertBadge}
        </td>
        <td>${device.ip_address}</td>
        <td>
            <span class="badge bg-light text-dark">
                <i class="bi bi-${getDeviceIcon(device.device_type)} me-1"></i>
                ${getDeviceTypeDisplayName(device.device_type)}
            </span>
            ${device.device_group ? `<br><span class="badge bg-secondary">${device.device_group}</span>` : ''}
        </td>
        <td>${formatResponseTime(device.latest_response_time)}</td>
        <td>${formatUptime(device.uptime_percentage)}</td>
        <td>${device.last_seen ? new Date(device.last_seen).toLocaleString() : 'Never'}</td>
        <td onclick="event.stopPropagation()">
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" onclick="pingDevice(${device.id})">
                    <i class="bi bi-wifi"></i>
                </button>
                <button class="btn btn-outline-secondary" onclick="editDevice(${device.id})">
                    <i class="bi bi-pencil"></i>
                </button>
            </div>
        </td>
    `;
    
    return row;
}

// Filter devices based on current filters
function filterDevices() {
    const search = document.getElementById('search-input').value.toLowerCase();
    const status = document.getElementById('filter-status').value;
    const type = document.getElementById('filter-type').value;
    const group = document.getElementById('filter-group').value;
    
    filteredDevices = devices.filter(device => {
        // Search filter
        const matchesSearch = !search || 
            device.display_name.toLowerCase().includes(search) ||
            device.ip_address.toLowerCase().includes(search) ||
            (device.hostname && device.hostname.toLowerCase().includes(search));
        
        // Status filter
        const matchesStatus = !status || device.status === status;
        
        // Type filter
        const matchesType = !type || device.device_type === type;
        
        // Group filter
        const matchesGroup = !group || device.device_group === group;
        
        return matchesSearch && matchesStatus && matchesType && matchesGroup;
    });
    
    displayDevices();
}

// Clear all filters
function clearFilters() {
    document.getElementById('search-input').value = '';
    document.getElementById('filter-status').value = '';
    document.getElementById('filter-type').value = '';
    document.getElementById('filter-group').value = '';
    
    filteredDevices = devices;
    displayDevices();
}

// Switch view mode
function switchView(viewType) {
    currentView = viewType;
    
    if (viewType === 'grid') {
        document.getElementById('grid-view').style.display = 'block';
        document.getElementById('list-view').style.display = 'none';
    } else {
        document.getElementById('grid-view').style.display = 'none';
        document.getElementById('list-view').style.display = 'block';
    }
    
    displayDevices();
}

// View device details
function viewDevice(deviceId) {
    window.location.href = `/device/${deviceId}`;
}

// Edit device
function editDevice(deviceId) {
    // Implementation for edit device modal
    console.log('Edit device:', deviceId);
}

// Ping device manually
async function pingDevice(deviceId) {
    try {
        const response = await fetch(`/api/devices/${deviceId}/ping`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast(`Device pinged successfully: ${formatResponseTime(data.response_time)}`, 'success');
        } else {
            showToast('Device ping failed', 'error');
        }
        
        // Refresh devices after ping
        setTimeout(loadDevices, 1000);
        
    } catch (error) {
        console.error('Error pinging device:', error);
        showToast('Error pinging device', 'error');
    }
}

// Add new device
async function addDevice() {
    try {
        const ip = document.getElementById('device-ip').value.trim();
        const name = document.getElementById('device-name').value.trim();
        const type = document.getElementById('device-type').value;
        const group = document.getElementById('device-group').value.trim();
        const monitor = document.getElementById('device-monitor').checked;
        
        if (!ip) {
            showToast('IP address is required', 'error');
            return;
        }
        
        const deviceData = {
            ip_address: ip,
            custom_name: name || null,
            device_type: type,
            device_group: group || null,
            is_monitored: monitor
        };
        
        const response = await fetch('/api/devices', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(deviceData)
        });
        
        if (response.ok) {
            showToast('Device added successfully', 'success');
            
            // Close modal and reset form
            const modal = bootstrap.Modal.getInstance(document.getElementById('addDeviceModal'));
            modal.hide();
            document.getElementById('add-device-form').reset();
            
            // Reload devices
            loadDevices();
        } else {
            const error = await response.json();
            showToast(error.error || 'Error adding device', 'error');
        }
        
    } catch (error) {
        console.error('Error adding device:', error);
        showToast('Error adding device', 'error');
    }
}

// Update device status from real-time updates
function updateDeviceStatus(data) {
    const device = devices.find(d => d.id === data.device_id);
    if (device) {
        device.latest_response_time = data.response_time;
        device.status = data.status;
        device.last_seen = data.timestamp;
        
        // Update display if device is currently visible
        if (filteredDevices.includes(device)) {
            displayDevices();
        }
        
    }
}

// System status management  
let systemStatus = {
    nextScanTime: null,
    lastPingTime: null,
    lastScanTime: null,
    nextPingTime: null,
    intervalIds: []
};

async function updateSystemStatus() {
    try {
        // Fetch background activity data
        const cacheBuster = Date.now();
        const [activityResponse, healthResponse] = await Promise.all([
            fetch(`/api/monitoring/background-activity?_=${cacheBuster}`),
            fetch(`/health?_=${cacheBuster}`)
        ]);
        
        if (!activityResponse.ok || !healthResponse.ok) {
            throw new Error('Failed to fetch system status data');
        }
        
        const activityData = await activityResponse.json();
        const healthData = await healthResponse.json();
        
        // Update system status data
        systemStatus.lastPingTime = activityData.last_ping_time;
        systemStatus.lastScanTime = activityData.last_scan_time;
        systemStatus.nextScanTime = activityData.next_scan_time;
        systemStatus.nextPingTime = activityData.next_ping_time;
        
        const statusBar = document.getElementById('status-bar');
        
        // Show the status bar if monitoring is active
        if (activityData.monitoring_active && healthData.status === 'healthy') {
            statusBar.style.display = 'block';
        } else {
            statusBar.style.display = 'none';
            return;
        }
        
        // Update service uptime
        if (healthData.uptime_seconds !== undefined) {
            const uptimeText = formatUptimeDuration(healthData.uptime_seconds);
            document.getElementById('service-uptime').textContent = uptimeText;
        }
        
        if (healthData.started_at) {
            const startTime = new Date(healthData.started_at);
            document.getElementById('service-start-time').textContent = startTime.toLocaleString();
        }
        
        // Update last ping time
        if (activityData.last_ping_time) {
            const lastPing = new Date(activityData.last_ping_time);
            document.getElementById('last-ping-time').textContent = formatTimeAgo(lastPing);
        } else {
            document.getElementById('last-ping-time').textContent = 'never';
        }
        
        // Update next ping time
        if (activityData.next_ping_time) {
            const nextPing = new Date(activityData.next_ping_time);
            const now = new Date();
            const timeUntilNext = Math.max(0, nextPing - now);
            
            if (timeUntilNext > 0) {
                const minutesLeft = Math.ceil(timeUntilNext / (1000 * 60));
                if (minutesLeft < 1) {
                    document.getElementById('next-ping-time').textContent = 'in < 1m';
                } else if (minutesLeft <= 60) {
                    document.getElementById('next-ping-time').textContent = `in ${minutesLeft}m`;
                } else {
                    document.getElementById('next-ping-time').textContent = nextPing.toLocaleTimeString();
                }
            } else {
                document.getElementById('next-ping-time').textContent = 'due now';
            }
        } else {
            document.getElementById('next-ping-time').textContent = 'unknown';
        }
        
        // Update last scan time
        if (activityData.last_scan_time) {
            const lastScan = new Date(activityData.last_scan_time);
            document.getElementById('last-scan-time').textContent = formatTimeAgo(lastScan);
        } else {
            document.getElementById('last-scan-time').textContent = 'never';
        }
        
        // Update next scan time
        if (activityData.next_scan_time) {
            const nextScan = new Date(activityData.next_scan_time);
            const now = new Date();
            const timeUntilNext = Math.max(0, nextScan - now);
            
            if (timeUntilNext > 0) {
                const minutesLeft = Math.ceil(timeUntilNext / (1000 * 60));
                if (minutesLeft < 1) {
                    document.getElementById('next-scan-time').textContent = 'in < 1m';
                } else if (minutesLeft <= 60) {
                    document.getElementById('next-scan-time').textContent = `in ${minutesLeft}m`;
                } else {
                    document.getElementById('next-scan-time').textContent = nextScan.toLocaleTimeString();
                }
            } else {
                document.getElementById('next-scan-time').textContent = 'due now';
            }
        } else {
            document.getElementById('next-scan-time').textContent = 'unknown';
        }
        
        // Update system status badge
        const recentPings = activityData.recent_activity?.ping_count_1h || 0;
        const statusText = document.getElementById('system-status-text');
        if (recentPings > 0) {
            statusText.textContent = `Monitoring Active (${recentPings} pings/hour)`;
            statusText.className = 'badge bg-success';
        } else {
            statusText.textContent = 'Monitoring Standby';
            statusText.className = 'badge bg-warning';
        }
        
    } catch (error) {
        console.error('Error updating system status:', error);
        // Show error status
        const statusBar = document.getElementById('status-bar');
        if (statusBar) {
            const statusText = document.getElementById('system-status-text');
            if (statusText) {
                statusText.textContent = 'System Error';
                statusText.className = 'badge bg-danger';
            }
        }
    }
}

function formatTimeAgo(date) {
    const now = new Date();
    const diff = now - date;
    const minutes = Math.floor(diff / (1000 * 60));
    const hours = Math.floor(minutes / 60);
    
    if (minutes < 1) {
        return 'just now';
    } else if (minutes < 60) {
        return `${minutes}m ago`;
    } else if (hours < 24) {
        return `${hours}h ago`;
    } else {
        const days = Math.floor(hours / 24);
        return `${days}d ago`;
    }
}

function formatUptimeDuration(seconds) {
    const days = Math.floor(seconds / 86400);
    const hours = Math.floor((seconds % 86400) / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    
    if (days > 0) {
        return `${days}d ${hours}h`;
    } else if (hours > 0) {
        return `${hours}h ${minutes}m`;
    } else {
        return `${minutes}m`;
    }
}

function showActivitySpinner() {
    const spinner = document.getElementById('activity-spinner');
    if (spinner) {
        spinner.style.display = 'inline-block';
    }
}

function hideActivitySpinner() {
    const spinner = document.getElementById('activity-spinner');
    if (spinner) {
        spinner.style.display = 'none';
    }
    updateSystemStatus();
}

function startSystemStatusUpdates() {
    console.log('Starting system status updates');
    
    // Update system status every 5 seconds
    systemStatus.intervalIds.push(setInterval(updateSystemStatus, 5000));
    
    // Update current date and time every second
    systemStatus.intervalIds.push(setInterval(updateCurrentDateTime, 1000));
    
    // Initial updates
    updateSystemStatus();
    updateCurrentDateTime();
}

// NetworkGraph class removed - now on dedicated topology page


// Network graph initialization removed - now on dedicated topology page

// Update current date and time
function updateCurrentDateTime() {
    const now = new Date();
    
    // Format date (e.g., "Dec 25, 2024")
    const dateOptions = {
        year: 'numeric',
        month: 'short', 
        day: 'numeric'
    };
    const formattedDate = now.toLocaleDateString('en-US', dateOptions);
    
    // Format time (e.g., "14:30:25")
    const timeOptions = {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
    };
    const formattedTime = now.toLocaleTimeString('en-US', timeOptions);
    
    // Update the new status bar elements
    const dateElement = document.getElementById('current-date');
    const timeElement = document.getElementById('current-time');
    
    if (dateElement) dateElement.textContent = formattedDate;
    if (timeElement) timeElement.textContent = formattedTime;
}


// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Load initial data
    loadDevices();
    
    // Start system status updates
    startSystemStatusUpdates();
    
    // Network graph moved to dedicated topology page
    
    // Removed graph layout functions - now on topology page
    
    // Search and filter event listeners
    document.getElementById('search-input').addEventListener('input', filterDevices);
    document.getElementById('filter-status').addEventListener('change', filterDevices);
    document.getElementById('filter-type').addEventListener('change', filterDevices);
    document.getElementById('filter-group').addEventListener('change', filterDevices);
    
    // Button event listeners
    document.getElementById('clear-filters').addEventListener('click', clearFilters);
    document.getElementById('refresh-btn').addEventListener('click', loadDevices);
    // Network scan button with progress tracking
    document.getElementById('scan-btn').addEventListener('click', async () => {
        startNetworkScan();
    });
    document.getElementById('scan-network-btn').addEventListener('click', async () => {
        startNetworkScan();
    });
    
    // Network scan function
    async function startNetworkScan() {
        const button = document.getElementById('scan-btn');
        const originalText = button.innerHTML;
        const progressContainer = document.getElementById('scan-progress-container');
        const progressBar = document.getElementById('scan-progress-bar');
        const progressText = document.getElementById('scan-progress-text');
        const newDevicesCount = document.getElementById('scan-new-devices');
        
        try {
            // Get current device count
            const beforeResponse = await fetch('/api/devices');
            const beforeData = await beforeResponse.json();
            const devicesBefore = beforeData.devices.length;
            
            // Show progress bar and disable button
            button.disabled = true;
            button.innerHTML = '<i class="bi bi-radar"></i> Scanning...';
            progressContainer.style.display = 'block';
            
            // Initialize progress
            progressText.textContent = 'Initializing scan...';
            progressBar.style.width = '0%';
            progressBar.setAttribute('aria-valuenow', '0');
            newDevicesCount.textContent = '0';
            
            showToast('Network scan initiated - discovering devices...', 'info');
            
            // Simulate scan progress stages
            const scanStages = [
                { progress: 10, text: 'Checking ARP table...', delay: 500 },
                { progress: 25, text: 'Starting nmap scan...', delay: 1000 },
                { progress: 40, text: 'Scanning IP range 192.168.86.1-50...', delay: 1500 },
                { progress: 60, text: 'Scanning IP range 192.168.86.51-100...', delay: 1500 },
                { progress: 75, text: 'Scanning IP range 192.168.86.101-200...', delay: 1500 },
                { progress: 90, text: 'Resolving hostnames and vendors...', delay: 1000 },
                { progress: 100, text: 'Updating database...', delay: 800 }
            ];
            
            for (const stage of scanStages) {
                await new Promise(resolve => setTimeout(resolve, stage.delay));
                progressBar.style.width = `${stage.progress}%`;
                progressBar.setAttribute('aria-valuenow', stage.progress.toString());
                progressText.textContent = stage.text;
            }
            
            // Get updated device count
            const afterResponse = await fetch('/api/devices');
            const afterData = await afterResponse.json();
            const devicesAfter = afterData.devices.length;
            const newDevices = devicesAfter - devicesBefore;
            
            newDevicesCount.textContent = newDevices.toString();
            progressText.textContent = `Scan complete - ${devicesAfter} total devices`;
            
            // Show completion message
            if (newDevices > 0) {
                showToast(`Network scan completed! Found ${newDevices} new devices (${devicesAfter} total)`, 'success');
            } else {
                showToast(`Network scan completed! ${devicesAfter} devices confirmed`, 'info');
            }
            
            // Hide progress bar after a delay
            setTimeout(() => {
                progressContainer.style.display = 'none';
            }, 4000);
            
            // Refresh device list to show any new devices
            setTimeout(loadDevices, 1000);
            
        } catch (error) {
            console.error('Error during network scan:', error);
            showToast('Network scan failed: ' + error.message, 'danger');
            progressContainer.style.display = 'none';
        } finally {
            // Restore button state
            button.disabled = false;
            button.innerHTML = originalText;
        }
    }
    
    // Ping All button with progress tracking
    document.getElementById('ping-all-btn').addEventListener('click', async () => {
        const button = document.getElementById('ping-all-btn');
        const originalText = button.innerHTML;
        const progressContainer = document.getElementById('ping-progress-container');
        const progressBar = document.getElementById('ping-progress-bar');
        const progressText = document.getElementById('ping-progress-text');
        const successCount = document.getElementById('ping-success-count');
        const failCount = document.getElementById('ping-fail-count');
        
        try {
            // Get all monitored devices first
            const devicesResponse = await fetch('/api/devices?monitored=true');
            if (!devicesResponse.ok) {
                throw new Error('Failed to fetch devices');
            }
            const devicesData = await devicesResponse.json();
            const devices = devicesData.devices;
            
            if (devices.length === 0) {
                showToast('No monitored devices found', 'warning');
                return;
            }
            
            // Show progress bar and disable button
            button.disabled = true;
            button.innerHTML = '<i class="bi bi-hourglass-split"></i> Pinging...';
            progressContainer.style.display = 'block';
            
            // Initialize progress
            let completed = 0;
            let successful = 0;
            let failed = 0;
            
            progressText.textContent = `0 / ${devices.length} devices`;
            progressBar.style.width = '0%';
            progressBar.setAttribute('aria-valuenow', '0');
            successCount.textContent = '0';
            failCount.textContent = '0';
            
            showToast(`Pinging ${devices.length} devices...`, 'info');
            
            // Ping devices one by one to show progress
            for (const device of devices) {
                try {
                    const response = await fetch(`/api/devices/${device.id}/ping`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    completed++;
                    const progress = (completed / devices.length) * 100;
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success !== false) {
                            successful++;
                        } else {
                            failed++;
                        }
                    } else {
                        failed++;
                    }
                    
                    // Update progress bar
                    progressBar.style.width = `${progress}%`;
                    progressBar.setAttribute('aria-valuenow', progress.toString());
                    progressText.textContent = `${completed} / ${devices.length} devices`;
                    successCount.textContent = successful.toString();
                    failCount.textContent = failed.toString();
                    
                    // Add small delay to make progress visible
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                } catch (error) {
                    console.error(`Error pinging device ${device.id}:`, error);
                    completed++;
                    failed++;
                    
                    const progress = (completed / devices.length) * 100;
                    progressBar.style.width = `${progress}%`;
                    progressBar.setAttribute('aria-valuenow', progress.toString());
                    progressText.textContent = `${completed} / ${devices.length} devices`;
                    failCount.textContent = failed.toString();
                }
            }
            
            // Show final results
            const successRate = devices.length > 0 ? Math.round((successful / devices.length) * 100) : 0;
            const message = `Ping completed: ${successful}/${devices.length} devices online (${successRate}%)`;
            
            if (successRate >= 80) {
                showToast(message, 'success');
            } else if (successRate >= 50) {
                showToast(message, 'warning');
            } else {
                showToast(message, 'danger');
            }
            
            // Hide progress bar after a delay
            setTimeout(() => {
                progressContainer.style.display = 'none';
            }, 3000);
            
            // Refresh device list to show updated status
            setTimeout(loadDevices, 1000);
            
        } catch (error) {
            console.error('Error pinging devices:', error);
            showToast('Failed to ping devices: ' + error.message, 'danger');
            progressContainer.style.display = 'none';
        } finally {
            // Restore button state
            button.disabled = false;
            button.innerHTML = originalText;
        }
    });
    
    // View switchers
    document.getElementById('view-grid').addEventListener('click', (e) => {
        e.preventDefault();
        switchView('grid');
    });
    document.getElementById('view-list').addEventListener('click', (e) => {
        e.preventDefault();
        switchView('list');
    });
    document.getElementById('enable-selection-mode').addEventListener('click', (e) => {
        e.preventDefault();
        if (!selectionMode) toggleSelectionMode();
    });
    
    // Add device modal
    document.getElementById('save-device-btn').addEventListener('click', addDevice);
    
    // Bulk operations event listeners
    document.getElementById('toggle-selection-mode').addEventListener('click', toggleSelectionMode);
    document.getElementById('select-all-devices').addEventListener('change', selectAllDevices);
    document.getElementById('clear-selection').addEventListener('click', clearSelection);
    document.getElementById('bulk-wake-on-lan').addEventListener('click', bulkWakeOnLan);
    document.getElementById('bulk-ping-devices').addEventListener('click', bulkPingDevices);
    document.getElementById('bulk-enable-monitoring').addEventListener('click', () => bulkUpdateMonitoring(true));
    document.getElementById('bulk-disable-monitoring').addEventListener('click', () => bulkUpdateMonitoring(false));
    document.getElementById('bulk-set-group').addEventListener('click', bulkSetGroup);
    document.getElementById('bulk-delete-devices').addEventListener('click', bulkDeleteDevices);
    
    // Auto-refresh every 30 seconds
    setInterval(loadDevices, 30000);
});

// Global variables for bulk operations
let selectionMode = false;
let selectedDevices = new Set();

// Handle device card clicks (navigation or selection)
function handleDeviceCardClick(event, deviceId) {
    if (selectionMode) {
        event.preventDefault();
        toggleDeviceSelection(deviceId);
    } else {
        viewDevice(deviceId);
    }
}

// Toggle selection mode
function toggleSelectionMode() {
    selectionMode = !selectionMode;
    const button = document.getElementById('toggle-selection-mode');
    const bulkControls = document.getElementById('bulk-selection-controls');
    const checkboxes = document.querySelectorAll('.device-checkbox');
    
    if (selectionMode) {
        // Enable selection mode
        button.innerHTML = '<i class="bi bi-x-circle"></i> Exit Selection';
        bulkControls.style.display = 'block';
        checkboxes.forEach(cb => cb.style.display = 'block');
        
        // Add selection visual cues
        document.querySelectorAll('.device-card').forEach(card => {
            card.style.cursor = 'pointer';
            card.classList.add('selection-mode');
        });
        
        showToast('Selection mode enabled - click devices to select them', 'info');
    } else {
        // Disable selection mode
        button.innerHTML = '<i class="bi bi-check-square"></i> Enable Selection';
        bulkControls.style.display = 'none';
        checkboxes.forEach(cb => cb.style.display = 'none');
        clearSelection();
        
        // Remove selection visual cues
        document.querySelectorAll('.device-card').forEach(card => {
            card.style.cursor = '';
            card.classList.remove('selection-mode');
        });
    }
}

// Toggle device selection
function toggleDeviceSelection(deviceId) {
    const checkbox = document.querySelector(`input[value="${deviceId}"]`);
    if (checkbox) {
        checkbox.checked = !checkbox.checked;
        if (checkbox.checked) {
            selectedDevices.add(deviceId);
        } else {
            selectedDevices.delete(deviceId);
        }
        updateSelectionCount();
        updateSelectAllCheckbox();
    }
}

// Select all devices
function selectAllDevices() {
    const selectAllCheckbox = document.getElementById('select-all-devices');
    const deviceCheckboxes = document.querySelectorAll('.device-select');
    
    if (selectAllCheckbox.checked) {
        deviceCheckboxes.forEach(cb => {
            cb.checked = true;
            selectedDevices.add(parseInt(cb.value));
        });
    } else {
        deviceCheckboxes.forEach(cb => {
            cb.checked = false;
            selectedDevices.delete(parseInt(cb.value));
        });
    }
    updateSelectionCount();
}

// Clear selection
function clearSelection() {
    selectedDevices.clear();
    document.querySelectorAll('.device-select').forEach(cb => cb.checked = false);
    document.getElementById('select-all-devices').checked = false;
    updateSelectionCount();
}

// Update selection count display
function updateSelectionCount() {
    const count = selectedDevices.size;
    const countElement = document.getElementById('selected-count');
    countElement.textContent = `${count} device${count !== 1 ? 's' : ''} selected`;
    countElement.className = count > 0 ? 'badge bg-primary' : 'badge bg-secondary';
}

// Update select all checkbox state
function updateSelectAllCheckbox() {
    const selectAllCheckbox = document.getElementById('select-all-devices');
    const deviceCheckboxes = document.querySelectorAll('.device-select');
    const checkedBoxes = document.querySelectorAll('.device-select:checked');
    
    selectAllCheckbox.indeterminate = checkedBoxes.length > 0 && checkedBoxes.length < deviceCheckboxes.length;
    selectAllCheckbox.checked = checkedBoxes.length === deviceCheckboxes.length && deviceCheckboxes.length > 0;
}

// Bulk Wake-on-LAN
async function bulkWakeOnLan() {
    if (selectedDevices.size === 0) {
        showToast('Please select devices to wake', 'warning');
        return;
    }
    
    if (!confirm(`Send Wake-on-LAN packets to ${selectedDevices.size} selected device(s)?`)) {
        return;
    }
    
    try {
        const deviceIds = Array.from(selectedDevices);
        showToast(`Sending Wake-on-LAN to ${deviceIds.length} devices...`, 'info');
        
        const response = await fetch('/api/device-control/bulk-wake', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ device_ids: deviceIds })
        });
        
        const result = await response.json();
        if (result.summary) {
            const { successful, failed, total } = result.summary;
            const message = `Wake-on-LAN completed: ${successful}/${total} successful`;
            showToast(message, successful === total ? 'success' : 'warning');
        }
        
        if (result.results?.length > 0) {
            console.log('Bulk WOL results:', result.results);
        }
        
    } catch (error) {
        console.error('Bulk Wake-on-LAN error:', error);
        showToast('Bulk Wake-on-LAN operation failed', 'error');
    }
}

// Bulk ping devices
async function bulkPingDevices() {
    if (selectedDevices.size === 0) {
        showToast('Please select devices to ping', 'warning');
        return;
    }
    
    try {
        const deviceIds = Array.from(selectedDevices);
        showToast(`Pinging ${deviceIds.length} selected devices...`, 'info');
        
        const response = await fetch('/api/device-control/bulk-ping', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ device_ids: deviceIds, count: 3 })
        });
        
        const result = await response.json();
        if (result.summary) {
            const { successful, failed, total } = result.summary;
            const successRate = Math.round((successful / total) * 100);
            const message = `Bulk ping completed: ${successful}/${total} devices responded (${successRate}%)`;
            showToast(message, successful === total ? 'success' : 'warning');
        }
        
    } catch (error) {
        console.error('Bulk ping error:', error);
        showToast('Bulk ping operation failed', 'error');
    }
}

// Bulk update monitoring status
async function bulkUpdateMonitoring(enabled) {
    if (selectedDevices.size === 0) {
        showToast('Please select devices to update', 'warning');
        return;
    }
    
    const action = enabled ? 'enable' : 'disable';
    if (!confirm(`${enabled ? 'Enable' : 'Disable'} monitoring for ${selectedDevices.size} selected device(s)?`)) {
        return;
    }
    
    try {
        const deviceIds = Array.from(selectedDevices);
        let successful = 0;
        let failed = 0;
        
        showToast(`${enabled ? 'Enabling' : 'Disabling'} monitoring for ${deviceIds.length} devices...`, 'info');
        
        for (const deviceId of deviceIds) {
            try {
                const response = await fetch(`/api/devices/${deviceId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_monitored: enabled })
                });
                
                if (response.ok) {
                    successful++;
                } else {
                    failed++;
                }
            } catch (error) {
                failed++;
            }
        }
        
        const message = `Monitoring ${action} completed: ${successful}/${deviceIds.length} successful`;
        showToast(message, successful === deviceIds.length ? 'success' : 'warning');
        
        // Refresh device list
        setTimeout(loadDevices, 1000);
        
    } catch (error) {
        console.error('Bulk monitoring update error:', error);
        showToast(`Bulk monitoring ${action} failed`, 'error');
    }
}

// Bulk set group
async function bulkSetGroup() {
    if (selectedDevices.size === 0) {
        showToast('Please select devices to group', 'warning');
        return;
    }
    
    const groupName = prompt(`Enter group name for ${selectedDevices.size} selected device(s):`);
    if (groupName === null) return; // User cancelled
    
    try {
        const deviceIds = Array.from(selectedDevices);
        let successful = 0;
        let failed = 0;
        
        showToast(`Setting group "${groupName}" for ${deviceIds.length} devices...`, 'info');
        
        for (const deviceId of deviceIds) {
            try {
                const response = await fetch(`/api/devices/${deviceId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ device_group: groupName || null })
                });
                
                if (response.ok) {
                    successful++;
                } else {
                    failed++;
                }
            } catch (error) {
                failed++;
            }
        }
        
        const message = `Group assignment completed: ${successful}/${deviceIds.length} successful`;
        showToast(message, successful === deviceIds.length ? 'success' : 'warning');
        
        // Refresh device list and filter options
        setTimeout(() => {
            loadDevices();
            loadFilterOptions();
        }, 1000);
        
    } catch (error) {
        console.error('Bulk group assignment error:', error);
        showToast('Bulk group assignment failed', 'error');
    }
}

// Bulk delete devices
async function bulkDeleteDevices() {
    if (selectedDevices.size === 0) {
        showToast('Please select devices to delete', 'warning');
        return;
    }
    
    if (!confirm(`DELETE ${selectedDevices.size} selected device(s)? This action cannot be undone!`)) {
        return;
    }
    
    try {
        const deviceIds = Array.from(selectedDevices);
        let successful = 0;
        let failed = 0;
        
        showToast(`Deleting ${deviceIds.length} devices...`, 'info');
        
        for (const deviceId of deviceIds) {
            try {
                const response = await fetch(`/api/devices/${deviceId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    successful++;
                } else {
                    failed++;
                }
            } catch (error) {
                failed++;
            }
        }
        
        const message = `Device deletion completed: ${successful}/${deviceIds.length} successful`;
        showToast(message, successful === deviceIds.length ? 'success' : 'warning');
        
        // Clear selection and refresh
        clearSelection();
        setTimeout(loadDevices, 1000);
        
    } catch (error) {
        console.error('Bulk delete error:', error);
        showToast('Bulk delete operation failed', 'error');
    }
}
</script>
{% endblock %}