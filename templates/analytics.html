{% extends "base.html" %}

{% block title %}Analytics - HomeNetMon{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-graph-up"></i> Network Analytics</h1>
    
    <div class="btn-group" role="group">
        <button type="button" class="btn btn-outline-primary" id="refresh-analytics">
            <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
        <div class="dropdown">
            <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="bi bi-calendar3"></i> Time Range
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item time-range-btn" href="#" data-hours="24">Last 24 Hours</a></li>
                <li><a class="dropdown-item time-range-btn" href="#" data-hours="168">Last Week</a></li>
                <li><a class="dropdown-item time-range-btn" href="#" data-days="30">Last Month</a></li>
            </ul>
        </div>
    </div>
</div>

<!-- Network Health Score Card -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-3 text-center">
                        <div class="position-relative d-inline-block">
                            <div id="health-score-circle" class="rounded-circle d-flex align-items-center justify-content-center" 
                                 style="width: 120px; height: 120px; border: 8px solid #e9ecef;">
                                <div class="text-center">
                                    <div id="health-score-value" class="h2 fw-bold mb-0">--</div>
                                    <small class="text-muted">Health Score</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5 id="health-status" class="mb-3">Network Status</h5>
                        <div class="row g-3">
                            <div class="col-6">
                                <div class="text-muted small">Devices Up</div>
                                <div id="devices-up-count" class="fw-bold">--</div>
                            </div>
                            <div class="col-6">
                                <div class="text-muted small">Avg Response</div>
                                <div id="avg-response-time" class="fw-bold">--</div>
                            </div>
                            <div class="col-6">
                                <div class="text-muted small">Success Rate</div>
                                <div id="success-rate" class="fw-bold">--%</div>
                            </div>
                            <div class="col-6">
                                <div class="text-muted small">Total Devices</div>
                                <div id="total-devices-count" class="fw-bold">--</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <h6 class="text-muted mb-2">Recommendations</h6>
                        <div id="health-recommendations">
                            <div class="placeholder-glow">
                                <span class="placeholder col-12 mb-1"></span>
                                <span class="placeholder col-8 mb-1"></span>
                                <span class="placeholder col-10"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Internet Speed Test Card -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-speedometer"></i> Internet Speed Test</h6>
                <div class="btn-group">
                    <button class="btn btn-primary" id="speedtest-btn" title="Test download and upload speeds">
                        <i class="bi bi-speedometer2"></i> Run Speed Test
                    </button>
                    <button class="btn btn-outline-danger" id="cancel-speedtest-btn" style="display: none;" title="Cancel speed test">
                        <i class="bi bi-x-circle"></i> Cancel
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div id="speedtest-results" class="row text-center">
                            <div class="col-md-4">
                                <div class="p-3 border rounded">
                                    <div class="h5 mb-1" id="download-speed">--</div>
                                    <div class="small text-muted">Download (Mbps)</div>
                                    <div id="download-rating" class="small"></div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="p-3 border rounded">
                                    <div class="h5 mb-1" id="upload-speed">--</div>
                                    <div class="small text-muted">Upload (Mbps)</div>
                                    <div id="upload-rating" class="small"></div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="p-3 border rounded">
                                    <div class="h5 mb-1" id="ping-latency">--</div>
                                    <div class="small text-muted">Ping (ms)</div>
                                    <div id="ping-rating" class="small"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="speedtest-status" class="mt-3 text-center" style="display: none;">
                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                            <span>Running speed test...</span>
                        </div>
                        
                        <div id="speedtest-progress" class="mt-3" style="display: none;">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div id="speedtest-info">
                            <h6 class="text-muted mb-2">Last Test</h6>
                            <div id="last-test-time" class="small mb-2">Never</div>
                            
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="text-muted mb-0">Overall Rating</h6>
                                <button class="btn btn-sm btn-outline-secondary" id="refresh-rating-btn" title="Refresh overall rating">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                            </div>
                            <div id="overall-speed-rating" class="d-flex align-items-center mb-2">
                                <span class="badge" id="overall-rating-badge">Unknown</span>
                            </div>
                            
                            <div id="speed-recommendations" class="small">
                                <div class="placeholder-glow">
                                    <span class="placeholder col-12 mb-1"></span>
                                    <span class="placeholder col-8"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Analytics Cards Row -->
<div class="row mb-4">
    <!-- Device Insights -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-award"></i> Device Champions</h6>
                <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#device-insights">
                    <i class="bi bi-chevron-down"></i>
                </button>
            </div>
            <div class="card-body collapse show" id="device-insights">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-success">üèÜ Most Reliable</h6>
                        <div id="most-reliable-devices">
                            <div class="placeholder-glow">
                                <div class="placeholder col-12 mb-2"></div>
                                <div class="placeholder col-10 mb-2"></div>
                                <div class="placeholder col-8"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-warning">‚ö° Fastest Response</h6>
                        <div id="fastest-devices">
                            <div class="placeholder-glow">
                                <div class="placeholder col-12 mb-2"></div>
                                <div class="placeholder col-10 mb-2"></div>
                                <div class="placeholder col-8"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <hr class="my-3">
                
                <h6 class="mb-3">üìä Device Types Performance</h6>
                <div id="device-types-chart">
                    <canvas id="device-types-canvas" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Usage Patterns -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-clock-history"></i> Usage Patterns</h6>
                <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#usage-patterns">
                    <i class="bi bi-chevron-down"></i>
                </button>
            </div>
            <div class="card-body collapse show" id="usage-patterns">
                <div class="mb-3">
                    <h6>üìà 24-Hour Activity Pattern</h6>
                    <div style="height: 250px; position: relative;">
                        <canvas id="hourly-pattern-chart"></canvas>
                    </div>
                </div>
                
                <hr class="my-3">
                
                <div class="row text-center">
                    <div class="col-4">
                        <div class="text-muted small">Peak Hour</div>
                        <div id="peak-hour" class="fw-bold text-primary">--:--</div>
                    </div>
                    <div class="col-4">
                        <div class="text-muted small">Quiet Hour</div>
                        <div id="quiet-hour" class="fw-bold text-secondary">--:--</div>
                    </div>
                    <div class="col-4">
                        <div class="text-muted small">Data Points</div>
                        <div id="total-data-points" class="fw-bold">--</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Network Trends -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-graph-up-arrow"></i> Network Performance Trends</h6>
                <div class="btn-group btn-group-sm" role="group">
                    <input type="radio" class="btn-check" name="trend-period" id="trend-7d" value="7" checked>
                    <label class="btn btn-outline-primary" for="trend-7d">7 Days</label>
                    
                    <input type="radio" class="btn-check" name="trend-period" id="trend-30d" value="30">
                    <label class="btn btn-outline-primary" for="trend-30d">30 Days</label>
                    
                    <input type="radio" class="btn-check" name="trend-period" id="trend-90d" value="90">
                    <label class="btn btn-outline-primary" for="trend-90d">90 Days</label>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-speedometer2 text-primary me-2"></i>
                            <div>
                                <div class="small text-muted">Response Time Trend</div>
                                <div id="response-trend" class="fw-bold">--</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-shield-check text-success me-2"></i>
                            <div>
                                <div class="small text-muted">Reliability Trend</div>
                                <div id="reliability-trend" class="fw-bold">--</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="height: 400px;">
                    <canvas id="trends-chart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bandwidth Analytics -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-speedometer"></i> Bandwidth Usage Analytics</h6>
                <div class="btn-group btn-group-sm" role="group">
                    <input type="radio" class="btn-check" name="bandwidth-period" id="bw-24h" value="24" checked>
                    <label class="btn btn-outline-primary" for="bw-24h">24 Hours</label>
                    
                    <input type="radio" class="btn-check" name="bandwidth-period" id="bw-7d" value="168">
                    <label class="btn btn-outline-primary" for="bw-7d">7 Days</label>
                </div>
            </div>
            <div class="card-body">
                <!-- Network-wide bandwidth summary -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4 mb-1" id="total-bandwidth">--</div>
                            <div class="text-muted small">Current Total</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4 mb-1" id="peak-bandwidth">--</div>
                            <div class="text-muted small">Peak Usage</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4 mb-1" id="avg-bandwidth">--</div>
                            <div class="text-muted small">Average Usage</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4 mb-1" id="total-data">--</div>
                            <div class="text-muted small">Total Data</div>
                        </div>
                    </div>
                </div>
                
                <!-- Bandwidth timeline chart -->
                <div style="height: 300px; margin-bottom: 20px;">
                    <canvas id="bandwidth-chart"></canvas>
                </div>
                
                <!-- Top bandwidth consumers -->
                <div class="row">
                    <div class="col-12">
                        <h6 class="mb-3">Top Bandwidth Consumers</h6>
                        <div id="bandwidth-consumers">
                            <div class="text-center py-3">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <div class="mt-2 text-muted">Loading bandwidth data...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Fun Network Statistics -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-emoji-smile"></i> Fun Network Facts</h6>
            </div>
            <div class="card-body">
                <div class="row g-3" id="network-facts">
                    <div class="col-md-3 col-6">
                        <div class="text-center p-3 border rounded">
                            <div class="h4 mb-1">üèÜ</div>
                            <div class="small text-muted">Network Champion</div>
                            <div id="network-champion" class="fw-bold small">Loading...</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="text-center p-3 border rounded">
                            <div class="h4 mb-1">‚ö°</div>
                            <div class="small text-muted">Speed Demon</div>
                            <div id="speed-demon" class="fw-bold small">Loading...</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="text-center p-3 border rounded">
                            <div class="h4 mb-1">üìä</div>
                            <div class="small text-muted">Data Collected</div>
                            <div id="total-pings" class="fw-bold small">Loading...</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="text-center p-3 border rounded">
                            <div class="h4 mb-1">üïí</div>
                            <div class="small text-muted">Peak Activity</div>
                            <div id="peak-activity-time" class="fw-bold small">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let healthChart, deviceTypesChart, hourlyChart, trendsChart;
    let currentTimeRange = { hours: 24 };

    // Initialize analytics page
    document.addEventListener('DOMContentLoaded', function() {
        loadAllAnalytics();
        loadSpeedTestData();
        
        // Load benchmark data after initial page load
        setTimeout(loadSpeedTestBenchmark, 1000);
        
        // Event listeners
        document.getElementById('refresh-analytics').addEventListener('click', loadAllAnalytics);
        
        // Speed test event listeners
        document.getElementById('speedtest-btn').addEventListener('click', () => runSpeedTest('comprehensive'));
        document.getElementById('cancel-speedtest-btn').addEventListener('click', cancelSpeedTest);
        document.getElementById('refresh-rating-btn').addEventListener('click', async () => {
            const btn = document.getElementById('refresh-rating-btn');
            const icon = btn.querySelector('i');
            
            // Show loading state
            btn.disabled = true;
            icon.className = 'bi bi-arrow-clockwise loading';
            
            try {
                await loadSpeedTestBenchmark();
                showToast('Overall rating refreshed', 'success');
            } catch (error) {
                showToast('Failed to refresh rating', 'error');
            } finally {
                // Reset button state
                btn.disabled = false;
                icon.className = 'bi bi-arrow-clockwise';
            }
        });
        
        // Time range buttons
        document.querySelectorAll('.time-range-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const hours = e.target.dataset.hours;
                const days = e.target.dataset.days;
                
                if (hours) {
                    currentTimeRange = { hours: parseInt(hours) };
                } else if (days) {
                    currentTimeRange = { days: parseInt(days) };
                }
                
                loadAllAnalytics();
            });
        });
        
        // Trend period radio buttons
        document.querySelectorAll('input[name="trend-period"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                loadNetworkTrends(parseInt(e.target.value));
            });
        });
        
        // Bandwidth period radio buttons
        document.querySelectorAll('input[name="bandwidth-period"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                loadBandwidthAnalytics(parseInt(e.target.value));
            });
        });
    });

    async function loadAllAnalytics() {
        showLoadingState();
        
        try {
            await Promise.all([
                loadNetworkHealth(),
                loadDeviceInsights(),
                loadUsagePatterns(),
                loadNetworkTrends(7),  // Default 7 days
                loadBandwidthAnalytics(24)  // Default 24 hours for bandwidth
            ]);
        } catch (error) {
            console.error('Error loading analytics:', error);
            showToast('Error loading analytics data', 'error');
        }
    }

    async function loadNetworkHealth() {
        try {
            const params = new URLSearchParams(currentTimeRange);
            const response = await fetch(`/api/analytics/network-health-score?${params}`);
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            updateHealthScoreDisplay(data);
        } catch (error) {
            console.error('Error loading network health:', error);
            document.getElementById('health-score-value').textContent = 'Error';
        }
    }

    async function loadDeviceInsights() {
        try {
            const params = new URLSearchParams({ hours: 168 }); // Always use 1 week for insights
            const response = await fetch(`/api/analytics/device-insights?${params}`);
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            updateDeviceInsights(data);
        } catch (error) {
            console.error('Error loading device insights:', error);
        }
    }

    async function loadUsagePatterns() {
        try {
            const response = await fetch('/api/analytics/usage-patterns?days=7');
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            updateUsagePatterns(data);
        } catch (error) {
            console.error('Error loading usage patterns:', error);
        }
    }

    async function loadNetworkTrends(days = 7) {
        try {
            const response = await fetch(`/api/analytics/network-trends?days=${days}`);
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            updateNetworkTrends(data);
        } catch (error) {
            console.error('Error loading network trends:', error);
        }
    }

    function updateHealthScoreDisplay(data) {
        const scoreElement = document.getElementById('health-score-value');
        const circleElement = document.getElementById('health-score-circle');
        const statusElement = document.getElementById('health-status');
        
        // Animate score counting up
        animateNumber(scoreElement, 0, data.health_score, 1000);
        
        // Update circle color
        circleElement.style.borderColor = data.status_color;
        scoreElement.style.color = data.status_color;
        
        // Update status
        statusElement.innerHTML = `
            <i class="bi bi-circle-fill me-2" style="color: ${data.status_color}"></i>
            Network Status: ${data.status.charAt(0).toUpperCase() + data.status.slice(1)}
        `;
        
        // Update metrics
        document.getElementById('devices-up-count').textContent = 
            `${data.metrics.devices_up}/${data.metrics.total_devices}`;
        document.getElementById('avg-response-time').textContent = 
            `${data.metrics.avg_response_time}ms`;
        document.getElementById('success-rate').textContent = 
            `${data.metrics.success_rate}%`;
        document.getElementById('total-devices-count').textContent = 
            data.metrics.total_devices;
        
        // Update recommendations
        const recommendationsElement = document.getElementById('health-recommendations');
        if (data.recommendations && data.recommendations.length > 0) {
            recommendationsElement.innerHTML = data.recommendations
                .map(rec => `<div class="small mb-1">${rec}</div>`)
                .join('');
        } else {
            recommendationsElement.innerHTML = '<div class="small text-muted">No recommendations at this time.</div>';
        }
    }

    function updateDeviceInsights(data) {
        // Most reliable devices
        const reliableElement = document.getElementById('most-reliable-devices');
        if (data.most_reliable && data.most_reliable.length > 0) {
            reliableElement.innerHTML = data.most_reliable.slice(0, 3).map((device, index) => `
                <div class="d-flex justify-content-between align-items-center small mb-1">
                    <span>${index + 1}. ${device.name}</span>
                    <span class="badge bg-success">${device.uptime}%</span>
                </div>
            `).join('');
        } else {
            reliableElement.innerHTML = '<div class="small text-muted">No data available</div>';
        }
        
        // Fastest devices
        const fastestElement = document.getElementById('fastest-devices');
        if (data.fastest_devices && data.fastest_devices.length > 0) {
            fastestElement.innerHTML = data.fastest_devices.slice(0, 3).map((device, index) => `
                <div class="d-flex justify-content-between align-items-center small mb-1">
                    <span>${index + 1}. ${device.name}</span>
                    <span class="badge bg-info">${device.response_time}ms</span>
                </div>
            `).join('');
        } else {
            fastestElement.innerHTML = '<div class="small text-muted">No data available</div>';
        }
        
        // Update fun facts
        if (data.most_reliable && data.most_reliable.length > 0) {
            document.getElementById('network-champion').textContent = data.most_reliable[0].name;
        }
        
        if (data.fastest_devices && data.fastest_devices.length > 0) {
            document.getElementById('speed-demon').textContent = data.fastest_devices[0].name;
        }
        
        // Device types chart
        if (data.device_types && data.device_types.length > 0) {
            updateDeviceTypesChart(data.device_types);
        }
    }

    function updateUsagePatterns(data) {
        // Update hourly pattern chart
        if (data.hourly_patterns && data.hourly_patterns.length > 0) {
            updateHourlyPatternChart(data.hourly_patterns);
        }
        
        // Update insights
        if (data.insights) {
            document.getElementById('peak-hour').textContent = data.insights.peak_hour;
            document.getElementById('quiet-hour').textContent = data.insights.quiet_hour;
            document.getElementById('total-data-points').textContent = 
                data.insights.total_data_points.toLocaleString();
            document.getElementById('peak-activity-time').textContent = data.insights.peak_hour;
            document.getElementById('total-pings').textContent = 
                data.insights.total_data_points.toLocaleString() + ' pings';
        }
    }

    function updateNetworkTrends(data) {
        // Update trend indicators
        const responseTrend = document.getElementById('response-trend');
        const reliabilityTrend = document.getElementById('reliability-trend');
        
        const trendIcons = {
            'improving': 'üìà Improving',
            'degrading': 'üìâ Degrading', 
            'stable': '‚û°Ô∏è Stable',
            'insufficient_data': '‚ùì Insufficient Data'
        };
        
        const trendColors = {
            'improving': 'text-success',
            'degrading': 'text-danger',
            'stable': 'text-info',
            'insufficient_data': 'text-muted'
        };
        
        if (data.analysis) {
            responseTrend.textContent = trendIcons[data.analysis.response_trend] || data.analysis.response_trend;
            responseTrend.className = `fw-bold ${trendColors[data.analysis.response_trend] || ''}`;
            
            reliabilityTrend.textContent = trendIcons[data.analysis.reliability_trend] || data.analysis.reliability_trend;
            reliabilityTrend.className = `fw-bold ${trendColors[data.analysis.reliability_trend] || ''}`;
        }
        
        // Update trends chart
        if (data.trend_data && data.trend_data.length > 0) {
            updateTrendsChart(data.trend_data);
        }
    }

    function updateDeviceTypesChart(deviceTypes) {
        const ctx = document.getElementById('device-types-canvas').getContext('2d');
        
        if (deviceTypesChart) {
            deviceTypesChart.destroy();
        }
        
        deviceTypesChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: deviceTypes.map(d => d.type),
                datasets: [{
                    data: deviceTypes.map(d => d.count),
                    backgroundColor: [
                        '#0d6efd', '#6f42c1', '#d63384', '#dc3545', '#fd7e14',
                        '#ffc107', '#20c997', '#198754', '#0dcaf0', '#6c757d'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            usePointStyle: true,
                            font: { size: 11 }
                        }
                    }
                }
            }
        });
    }

    function updateHourlyPatternChart(hourlyData) {
        const ctx = document.getElementById('hourly-pattern-chart').getContext('2d');
        
        if (hourlyChart) {
            hourlyChart.destroy();
        }
        
        hourlyChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: hourlyData.map(d => d.hour),
                datasets: [{
                    label: 'Activity Level',
                    data: hourlyData.map(d => d.total_pings),
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Ping Count'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Hour of Day'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                },
                layout: {
                    padding: {
                        top: 10,
                        bottom: 10
                    }
                }
            }
        });
    }

    function updateTrendsChart(trendData) {
        const ctx = document.getElementById('trends-chart').getContext('2d');
        
        if (trendsChart) {
            trendsChart.destroy();
        }
        
        trendsChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: trendData.map(d => d.date),
                datasets: [
                    {
                        label: 'Avg Response Time (ms)',
                        data: trendData.map(d => d.avg_response_time),
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        yAxisID: 'y',
                        tension: 0.4
                    },
                    {
                        label: 'Success Rate (%)',
                        data: trendData.map(d => d.success_rate),
                        borderColor: '#198754',
                        backgroundColor: 'rgba(25, 135, 84, 0.1)',
                        yAxisID: 'y1',
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Response Time (ms)'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Success Rate (%)'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                    }
                }
            }
        });
    }

    function animateNumber(element, start, end, duration) {
        const startTime = performance.now();
        
        function update(currentTime) {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            
            const current = start + (end - start) * progress;
            element.textContent = Math.round(current);
            
            if (progress < 1) {
                requestAnimationFrame(update);
            }
        }
        
        requestAnimationFrame(update);
    }

    function showLoadingState() {
        // Show loading placeholders
        document.getElementById('health-score-value').textContent = '--';
        document.getElementById('health-status').textContent = 'Loading...';
    }

    // Speed Test Functions
    async function loadSpeedTestData() {
        try {
            // Load latest speed test result
            const response = await fetch('/api/speedtest/latest');
            
            if (response.ok) {
                const data = await response.json();
                updateSpeedTestDisplay(data);
            } else {
                // No previous results
                updateSpeedTestDisplay(null);
            }
            
            // Load speed test benchmark
            await loadSpeedTestBenchmark();
        } catch (error) {
            console.error('Error loading speed test data:', error);
            updateSpeedTestDisplay(null);
        }
    }

    async function loadSpeedTestBenchmark() {
        try {
            console.log('Loading speed test benchmark...');
            const response = await fetch('/api/speedtest/benchmark');
            console.log('Benchmark response status:', response.status);
            
            if (response.ok) {
                const data = await response.json();
                console.log('Benchmark data received:', data);
                if (data.benchmark) {
                    updateSpeedTestBenchmark(data.benchmark);
                    console.log('Benchmark updated successfully');
                } else {
                    console.warn('No benchmark data in response');
                    showBenchmarkUnavailable('No benchmark data available');
                }
            } else {
                const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                console.warn('Benchmark API error:', errorData);
                showBenchmarkUnavailable(errorData.error || 'Failed to load benchmark');
            }
        } catch (error) {
            console.error('Error loading speed test benchmark:', error);
            showBenchmarkUnavailable('Network error loading benchmark');
        }
    }

    function showBenchmarkUnavailable(message) {
        console.log('Showing benchmark unavailable:', message);
        const ratingBadge = document.getElementById('overall-rating-badge');
        if (ratingBadge) {
            ratingBadge.textContent = 'Unavailable';
            ratingBadge.style.backgroundColor = '#6c757d';
            ratingBadge.className = 'badge';
            ratingBadge.title = message;
        }
        
        // Clear placeholders and show unavailable state
        const speedRecommendations = document.getElementById('speed-recommendations');
        if (speedRecommendations) {
            speedRecommendations.innerHTML = '<div class="small text-muted">Run a speed test to see recommendations</div>';
        }
        
        // Clear individual ratings
        ['download-rating', 'upload-rating', 'ping-rating'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.innerHTML = '<span class="badge" style="background-color: #6c757d">N/A</span>';
            }
        });
    }

    let currentSpeedTestController = null;

    async function runSpeedTest(testType) {
        try {
            // Disable button and show progress
            const speedBtn = document.getElementById('speedtest-btn');
            const cancelBtn = document.getElementById('cancel-speedtest-btn');
            const statusDiv = document.getElementById('speedtest-status');
            const progressDiv = document.getElementById('speedtest-progress');
            
            speedBtn.disabled = true;
            cancelBtn.style.display = 'inline-block';
            statusDiv.style.display = 'block';
            progressDiv.style.display = 'block';
            
            // Update status text
            const statusText = 'Running speed test (download + upload)...';
            statusDiv.querySelector('span').textContent = statusText;
            
            // Create abort controller for cancellation
            currentSpeedTestController = new AbortController();
            
            // Start the test
            const response = await fetch('/api/speedtest/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: testType }),
                signal: currentSpeedTestController.signal
            });
            
            const startData = await response.json();
            
            if (startData.error) {
                throw new Error(startData.error);
            }
            
            showToast('Speed test started', 'info');
            
            // Simulate progress animation (30 seconds for comprehensive test)
            animateProgress(30);
            
            // Poll for results
            await pollForSpeedTestResults();
            
        } catch (error) {
            if (error.name === 'AbortError') {
                showToast('Speed test cancelled', 'warning');
            } else {
                console.error('Error running speed test:', error);
                showToast(`Speed test error: ${error.message}`, 'error');
            }
        } finally {
            // Re-enable button and hide progress
            document.getElementById('speedtest-btn').disabled = false;
            document.getElementById('cancel-speedtest-btn').style.display = 'none';
            document.getElementById('speedtest-status').style.display = 'none';
            document.getElementById('speedtest-progress').style.display = 'none';
            currentSpeedTestController = null;
        }
    }

    function cancelSpeedTest() {
        if (currentSpeedTestController) {
            currentSpeedTestController.abort();
            showToast('Cancelling speed test...', 'warning');
        }
    }


    function animateProgress(estimatedSeconds) {
        const progressBar = document.querySelector('#speedtest-progress .progress-bar');
        let progress = 0;
        const increment = 100 / estimatedSeconds;
        
        const interval = setInterval(() => {
            progress += increment;
            if (progress >= 100) {
                progress = 100;
                clearInterval(interval);
            }
            progressBar.style.width = `${progress}%`;
        }, 1000);
        
        return interval;
    }

    async function pollForSpeedTestResults() {
        let attempts = 0;
        const maxAttempts = 36; // 6 minutes max (36 * 10 seconds)
        const testStartTime = Date.now();
        
        while (attempts < maxAttempts) {
            try {
                await new Promise(resolve => setTimeout(resolve, 10000)); // Wait 10 seconds
                attempts++;
                
                const response = await fetch('/api/speedtest/latest');
                if (response.ok) {
                    const data = await response.json();
                    
                    // Check if this is a new result since we started the test
                    const resultTime = new Date(data.timestamp).getTime();
                    if (data.success && resultTime > testStartTime) {
                        updateSpeedTestDisplay(data);
                        await loadSpeedTestBenchmark(); // Refresh benchmark  
                        showToast('Speed test completed!', 'success');
                        return;
                    }
                }
                
                // Update progress text
                const statusSpan = document.querySelector('#speedtest-status span');
                if (statusSpan) {
                    statusSpan.textContent = `Running speed test... (${attempts * 10}s elapsed)`;
                }
                
            } catch (error) {
                attempts++;
                console.error('Error polling for results:', error);
            }
        }
        
        showToast('Speed test timed out. It may still be running in the background.', 'warning');
    }

    function updateSpeedTestDisplay(data) {
        const downloadEl = document.getElementById('download-speed');
        const uploadEl = document.getElementById('upload-speed');
        const pingEl = document.getElementById('ping-latency');
        const lastTestEl = document.getElementById('last-test-time');
        
        if (!data || !data.success) {
            downloadEl.textContent = '--';
            uploadEl.textContent = '--';
            pingEl.textContent = '--';
            lastTestEl.textContent = 'Never';
            
            // Clear ratings
            document.getElementById('download-rating').textContent = '';
            document.getElementById('upload-rating').textContent = '';
            document.getElementById('ping-rating').textContent = '';
            return;
        }
        
        // Update speed values
        downloadEl.textContent = data.download_mbps || '--';
        uploadEl.textContent = data.upload_mbps || '--';
        pingEl.textContent = data.ping_ms || '--';
        
        // Update timestamp
        const testTime = new Date(data.timestamp);
        lastTestEl.textContent = testTime.toLocaleString();
        
        // Update basic ratings
        updateSpeedRatings(data);
    }

    function updateSpeedTestBenchmark(benchmark) {
        console.log('Updating speed test benchmark:', benchmark);
        if (!benchmark) {
            console.warn('No benchmark data provided to updateSpeedTestBenchmark');
            return;
        }
        
        // Update overall rating
        const ratingBadge = document.getElementById('overall-rating-badge');
        if (!ratingBadge) {
            console.error('overall-rating-badge element not found');
            return;
        }
        
        console.log('Setting overall rating to:', benchmark.overall.rating);
        ratingBadge.textContent = benchmark.overall.rating.replace('_', ' ').toUpperCase();
        ratingBadge.style.backgroundColor = benchmark.overall.color;
        ratingBadge.className = 'badge';
        ratingBadge.title = `Score: ${benchmark.overall.score}/5.0`;
        
        // Update individual ratings
        updateRatingElement('download-rating', benchmark.download);
        updateRatingElement('upload-rating', benchmark.upload);
        updateRatingElement('ping-rating', benchmark.ping);
        
        // Update recommendations
        const recommendationsEl = document.getElementById('speed-recommendations');
        const recommendations = [
            benchmark.download.description,
            benchmark.upload.description,
            benchmark.ping.description
        ].filter(Boolean);
        
        if (recommendations.length > 0) {
            recommendationsEl.innerHTML = recommendations
                .map(rec => `<div class="mb-1">${rec}</div>`)
                .join('');
        }
    }

    function updateRatingElement(elementId, ratingData) {
        const element = document.getElementById(elementId);
        if (element && ratingData) {
            element.innerHTML = `<span class="badge" style="background-color: ${ratingData.color}">${ratingData.rating.toUpperCase()}</span>`;
        }
    }

    function updateSpeedRatings(data) {
        // Simple rating logic for immediate feedback
        const downloadRating = getSimpleSpeedRating(data.download_mbps, false);
        const uploadRating = getSimpleSpeedRating(data.upload_mbps, true);
        const pingRating = getSimplePingRating(data.ping_ms);
        
        updateRatingElement('download-rating', downloadRating);
        updateRatingElement('upload-rating', uploadRating);
        updateRatingElement('ping-rating', pingRating);
    }

    function getSimpleSpeedRating(speed, isUpload) {
        if (isUpload) {
            if (speed >= 25) return { rating: 'excellent', color: '#28a745' };
            if (speed >= 10) return { rating: 'good', color: '#17a2b8' };
            if (speed >= 5) return { rating: 'fair', color: '#ffc107' };
            return { rating: 'poor', color: '#dc3545' };
        } else {
            if (speed >= 50) return { rating: 'excellent', color: '#28a745' };
            if (speed >= 25) return { rating: 'good', color: '#17a2b8' };
            if (speed >= 10) return { rating: 'fair', color: '#ffc107' };
            return { rating: 'poor', color: '#dc3545' };
        }
    }

    function getSimplePingRating(ping) {
        if (ping <= 30) return { rating: 'excellent', color: '#28a745' };
        if (ping <= 60) return { rating: 'good', color: '#17a2b8' };
        if (ping <= 100) return { rating: 'fair', color: '#ffc107' };
        return { rating: 'poor', color: '#dc3545' };
    }
    
    // Bandwidth Analytics Functions
    let bandwidthChart = null;
    
    async function loadBandwidthAnalytics(hours = 24) {
        try {
            console.log(`Loading bandwidth analytics for ${hours} hours`);
            
            // Load bandwidth summary and timeline data
            const [summaryResponse, timelineResponse, devicesResponse] = await Promise.all([
                fetch(`/api/monitoring/bandwidth/summary?hours=${hours}`),
                fetch(`/api/monitoring/bandwidth/timeline?hours=${hours}&interval=hour`),
                fetch(`/api/monitoring/bandwidth/devices?hours=${hours}&limit=10`)
            ]);
            
            const summaryData = await summaryResponse.json();
            const timelineData = await timelineResponse.json();
            const devicesData = await devicesResponse.json();
            
            if (summaryData.error || timelineData.error || devicesData.error) {
                throw new Error(summaryData.error || timelineData.error || devicesData.error);
            }
            
            updateBandwidthSummary(summaryData);
            updateBandwidthChart(timelineData);
            updateBandwidthConsumers(devicesData);
            
        } catch (error) {
            console.error('Error loading bandwidth analytics:', error);
            // Show fallback UI with dummy data or no data message
            updateBandwidthSummaryFallback();
            updateBandwidthConsumersFallback();
        }
    }
    
    function updateBandwidthSummary(data) {
        document.getElementById('total-bandwidth').textContent = 
            formatBandwidthValue(data.current_bandwidth?.current_total_mbps || 0);
        document.getElementById('peak-bandwidth').textContent = 
            formatBandwidthValue(data.peak_bandwidth?.peak_total_mbps || 0);
        document.getElementById('avg-bandwidth').textContent = 
            formatBandwidthValue(data.average_bandwidth?.avg_total_mbps || 0);
        document.getElementById('total-data').textContent = 
            formatDataUsage(data.total_data?.total_gb || 0);
    }
    
    function updateBandwidthSummaryFallback() {
        document.getElementById('total-bandwidth').textContent = 'N/A';
        document.getElementById('peak-bandwidth').textContent = 'N/A';
        document.getElementById('avg-bandwidth').textContent = 'N/A';
        document.getElementById('total-data').textContent = 'N/A';
    }
    
    function updateBandwidthChart(data) {
        const ctx = document.getElementById('bandwidth-chart').getContext('2d');
        
        if (bandwidthChart) {
            bandwidthChart.destroy();
        }
        
        const timeline = data.timeline || [];
        const labels = timeline.map(item => new Date(item.timestamp).toLocaleString());
        const inData = timeline.map(item => item.avg_bandwidth_in_mbps || 0);
        const outData = timeline.map(item => item.avg_bandwidth_out_mbps || 0);
        
        bandwidthChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Download (Mbps)',
                    data: inData,
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    tension: 0.4,
                    fill: true
                }, {
                    label: 'Upload (Mbps)',
                    data: outData,
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Bandwidth (Mbps)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    title: {
                        display: true,
                        text: 'Network Bandwidth Usage Over Time'
                    }
                }
            }
        });
    }
    
    function updateBandwidthConsumers(data) {
        const container = document.getElementById('bandwidth-consumers');
        const devices = data.devices || [];
        
        if (devices.length === 0) {
            container.innerHTML = '<div class="text-center py-3 text-muted">No bandwidth data available</div>';
            return;
        }
        
        const html = devices.map((device, index) => {
            const totalGB = device.bandwidth_stats?.total_gb || 0;
            const avgMbps = device.bandwidth_stats?.avg_total_mbps || 0;
            const peakMbps = device.bandwidth_stats?.peak_total_mbps || 0;
            
            return `
                <div class="row align-items-center py-2 ${index < devices.length - 1 ? 'border-bottom' : ''}">
                    <div class="col-md-4">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <span class="badge bg-primary">${index + 1}</span>
                            </div>
                            <div>
                                <div class="fw-bold">${device.device_name}</div>
                                <div class="small text-muted">${device.ip_address}</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="text-center">
                            <div class="fw-bold">${totalGB.toFixed(2)} GB</div>
                            <div class="small text-muted">Total Data</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="fw-bold">${formatBandwidthValue(avgMbps)}</div>
                            <div class="small text-muted">Avg Bandwidth</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="fw-bold">${formatBandwidthValue(peakMbps)}</div>
                            <div class="small text-muted">Peak Bandwidth</div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = html;
    }
    
    function updateBandwidthConsumersFallback() {
        const container = document.getElementById('bandwidth-consumers');
        container.innerHTML = '<div class="text-center py-3 text-muted">Bandwidth monitoring data will appear here once available</div>';
    }
    
    function formatBandwidthValue(mbps) {
        if (!mbps || mbps === 0) return '0 Mbps';
        if (mbps < 0.1) return '<0.1 Mbps';
        if (mbps < 1) return (mbps * 1000).toFixed(0) + ' Kbps';
        if (mbps < 10) return mbps.toFixed(1) + ' Mbps';
        return mbps.toFixed(0) + ' Mbps';
    }
    
    function formatDataUsage(gb) {
        if (!gb || gb === 0) return '0 GB';
        if (gb < 0.01) return '<0.01 GB';
        if (gb < 1) return (gb * 1024).toFixed(0) + ' MB';
        return gb.toFixed(2) + ' GB';
    }
</script>
{% endblock %}