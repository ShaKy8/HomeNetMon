{% extends "base.html" %}

{% block title %}Alerts - HomeNetMon{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-exclamation-triangle"></i> Alerts</h1>
    
    <div class="btn-group">
        <button type="button" class="btn btn-outline-primary" id="refresh-alerts">
            <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
        <button type="button" class="btn btn-outline-secondary" id="acknowledge-all">
            <i class="bi bi-check-all"></i> Acknowledge All
        </button>
        <button type="button" class="btn btn-outline-danger" id="clear-all-alerts">
            <i class="bi bi-trash"></i> Clear All Alerts
        </button>
    </div>
</div>

<!-- Alert Summary -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card border-danger">
            <div class="card-body text-center">
                <i class="bi bi-exclamation-triangle display-4 text-danger"></i>
                <h3 class="mt-2 text-danger" id="critical-count">-</h3>
                <p class="mb-0">Critical</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card border-warning">
            <div class="card-body text-center">
                <i class="bi bi-exclamation-circle display-4 text-warning"></i>
                <h3 class="mt-2 text-warning" id="warning-count">-</h3>
                <p class="mb-0">Warning</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card border-info">
            <div class="card-body text-center">
                <i class="bi bi-info-circle display-4 text-info"></i>
                <h3 class="mt-2 text-info" id="info-count">-</h3>
                <p class="mb-0">Info</p>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row align-items-end">
            <div class="col-md-3">
                <label for="filter-severity" class="form-label">Severity</label>
                <select class="form-select" id="filter-severity">
                    <option value="">All Severities</option>
                    <option value="critical">Critical</option>
                    <option value="warning">Warning</option>
                    <option value="info">Info</option>
                </select>
            </div>
            
            <div class="col-md-3">
                <label for="filter-status" class="form-label">Status</label>
                <select class="form-select" id="filter-status">
                    <option value="">All</option>
                    <option value="false" selected>Active</option>
                    <option value="true">Resolved</option>
                </select>
            </div>
            
            <div class="col-md-3">
                <label for="filter-hours" class="form-label">Time Period</label>
                <select class="form-select" id="filter-hours">
                    <option value="24">Last 24 Hours</option>
                    <option value="168" selected>Last 7 Days</option>
                    <option value="720">Last 30 Days</option>
                </select>
            </div>
            
            <div class="col-md-3">
                <button type="button" class="btn btn-outline-secondary" id="clear-filters">
                    <i class="bi bi-x-circle"></i> Clear Filters
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Indicator -->
<div class="text-center py-5" id="loading-indicator">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2 text-muted">Loading alerts...</p>
</div>

<!-- Alerts List -->
<div class="card" id="alerts-container" style="display: none;">
    <div class="card-header">
        <h5 class="mb-0">Alerts List</h5>
    </div>
    <div class="card-body p-0">
        <div id="alerts-list">
            <!-- Alert items will be inserted here -->
        </div>
    </div>
</div>

<!-- No Alerts Message -->
<div class="text-center py-5" id="no-alerts" style="display: none;">
    <i class="bi bi-check-circle display-1 text-success"></i>
    <h3 class="mt-3 text-success">No alerts found</h3>
    <p class="text-muted">All systems are running smoothly!</p>
</div>

<!-- Alert Detail Modal -->
<div class="modal fade" id="alertDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Alert Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="alert-detail-content">
                <!-- Alert details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-warning" id="acknowledge-alert-btn" style="display: none;">
                    <i class="bi bi-check"></i> Acknowledge
                </button>
                <button type="button" class="btn btn-success" id="resolve-alert-btn" style="display: none;">
                    <i class="bi bi-check-circle"></i> Resolve
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Simple alerts loading
async function loadAlerts(filters = {}) {
    console.log('Loading alerts with filters:', filters);
    
    // Show loading indicator
    document.getElementById('loading-indicator').style.display = 'block';
    document.getElementById('alerts-container').style.display = 'none';
    document.getElementById('no-alerts').style.display = 'none';
    
    try {
        // Build query parameters
        const params = new URLSearchParams();
        if (filters.severity) params.append('severity', filters.severity);
        if (filters.resolved !== undefined) params.append('resolved', filters.resolved);
        if (filters.hours) params.append('hours', filters.hours);
        params.append('limit', '50'); // Get more alerts for filtering
        
        const url = `/api/monitoring/alerts${params.toString() ? '?' + params.toString() : ''}`;
        console.log('Fetching:', url);
        
        const response = await fetch(url);
        const data = await response.json();
        
        console.log('Alerts loaded:', data);
        
        // Update summary counts based on loaded alerts
        const criticalCount = data.alerts ? data.alerts.filter(a => a.severity === 'critical').length : 0;
        const warningCount = data.alerts ? data.alerts.filter(a => a.severity === 'warning').length : 0;
        const infoCount = data.alerts ? data.alerts.filter(a => a.severity === 'info').length : 0;
        
        document.getElementById('critical-count').textContent = criticalCount;
        document.getElementById('warning-count').textContent = warningCount;
        document.getElementById('info-count').textContent = infoCount;
        
        if (data.alerts && data.alerts.length > 0) {
            // Show alerts
            document.getElementById('alerts-container').style.display = 'block';
            document.getElementById('no-alerts').style.display = 'none';
            
            // Simple alert display
            const alertsList = document.getElementById('alerts-list');
            alertsList.innerHTML = '';
            
            data.alerts.forEach(alert => {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'p-3 border-bottom';
                alertDiv.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1 me-3">
                            <h6 class="mb-1">${alert.device_name} (${alert.device_ip})</h6>
                            <p class="mb-1">${alert.message}</p>
                            <small class="text-muted">Created: ${new Date(alert.created_at).toLocaleString()}</small>
                            ${alert.acknowledged ? `<br><small class="text-success">Acknowledged by ${alert.acknowledged_by} on ${new Date(alert.acknowledged_at).toLocaleString()}</small>` : ''}
                            ${alert.resolved ? `<br><small class="text-info">Resolved on ${new Date(alert.resolved_at).toLocaleString()}</small>` : ''}
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <span class="badge ${
                                alert.severity === 'critical' ? 'bg-danger text-white' :
                                alert.severity === 'warning' ? 'bg-warning text-dark' :
                                alert.severity === 'info' ? 'bg-info text-white' : 'bg-secondary text-white'
                            }">${alert.severity.toUpperCase()}</span>
                            <button type="button" class="btn btn-sm btn-outline-danger delete-alert-btn" data-alert-id="${alert.id}" title="Delete Alert">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                alertsList.appendChild(alertDiv);
            });
            
        } else {
            // No alerts
            document.getElementById('alerts-container').style.display = 'none';
            document.getElementById('no-alerts').style.display = 'block';
        }
        
    } catch (error) {
        console.error('Error loading alerts:', error);
        
        // Show error
        document.getElementById('alerts-container').style.display = 'none';
        document.getElementById('no-alerts').style.display = 'none';
        
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger';
        errorDiv.innerHTML = `<h4>Error Loading Alerts</h4><p>${error.message}</p>`;
        document.body.appendChild(errorDiv);
    } finally {
        // Always hide loading indicator
        document.getElementById('loading-indicator').style.display = 'none';
    }
}

// Get current filter values from form
function getCurrentFilters() {
    return {
        severity: document.getElementById('filter-severity').value || undefined,
        resolved: document.getElementById('filter-status').value === '' ? undefined : document.getElementById('filter-status').value,
        hours: parseInt(document.getElementById('filter-hours').value) || 168
    };
}

// Apply filters
function applyFilters() {
    const filters = getCurrentFilters();
    loadAlerts(filters);
}

// Clear all filters
function clearFilters() {
    document.getElementById('filter-severity').value = '';
    document.getElementById('filter-status').value = 'false'; // Reset to Active
    document.getElementById('filter-hours').value = '168'; // Reset to Last 7 Days
    loadAlerts();
}

// Acknowledge all alerts function
async function acknowledgeAllAlerts() {
    try {
        const response = await fetch('/api/monitoring/alerts/acknowledge-all', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                acknowledged_by: 'web_user'
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            console.log('Acknowledged alerts:', data);
            showSuccessMessage(data.message);
            await loadAlerts();
        } else {
            console.error('Error acknowledging alerts:', data);
            alert('Error acknowledging alerts: ' + (data.error || 'Unknown error'));
        }
        
    } catch (error) {
        console.error('Error acknowledging alerts:', error);
        alert('Error acknowledging alerts: ' + error.message);
    }
}

// Clear all alerts function
async function clearAllAlerts() {
    if (!confirm('Are you sure you want to permanently delete ALL alerts? This action cannot be undone.')) {
        return;
    }
    
    // Double confirmation for destructive action
    if (!confirm('This will permanently delete all alerts from the database. Are you absolutely sure?')) {
        return;
    }
    
    try {
        const response = await fetch('/api/monitoring/alerts/delete-all', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                confirm: true
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            console.log('Cleared all alerts:', data);
            showSuccessMessage(`Successfully deleted ${data.total_deleted} alerts`);
            await loadAlerts();
        } else {
            console.error('Error clearing alerts:', data);
            alert('Error clearing alerts: ' + (data.error || 'Unknown error'));
        }
        
    } catch (error) {
        console.error('Error clearing alerts:', error);
        alert('Error clearing alerts: ' + error.message);
    }
}

// Delete single alert function
async function deleteAlert(alertId) {
    if (!confirm('Are you sure you want to permanently delete this alert?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/monitoring/alerts/${alertId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (response.ok) {
            console.log('Deleted alert:', data);
            showSuccessMessage('Alert deleted successfully');
            await loadAlerts();
        } else {
            console.error('Error deleting alert:', data);
            alert('Error deleting alert: ' + (data.error || 'Unknown error'));
        }
        
    } catch (error) {
        console.error('Error deleting alert:', error);
        alert('Error deleting alert: ' + error.message);
    }
}

// Helper function to show success messages
function showSuccessMessage(message) {
    const alertsContainer = document.getElementById('alerts-container') || document.querySelector('.container');
    const successDiv = document.createElement('div');
    successDiv.className = 'alert alert-success alert-dismissible fade show';
    successDiv.innerHTML = `
        <i class="bi bi-check-circle"></i> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    if (alertsContainer.firstChild) {
        alertsContainer.insertBefore(successDiv, alertsContainer.firstChild);
    } else {
        alertsContainer.appendChild(successDiv);
    }
    
    // Auto-dismiss after 4 seconds
    setTimeout(() => {
        if (successDiv.parentNode) {
            successDiv.remove();
        }
    }, 4000);
}

// Simple initialization
document.addEventListener('DOMContentLoaded', function() {
    console.log('Alerts page loaded, calling loadAlerts()');
    loadAlerts();
    
    // Add refresh button listener
    const refreshBtn = document.getElementById('refresh-alerts');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', loadAlerts);
    }
    
    // Add acknowledge all button listener
    const acknowledgeAllBtn = document.getElementById('acknowledge-all');
    if (acknowledgeAllBtn) {
        acknowledgeAllBtn.addEventListener('click', acknowledgeAllAlerts);
    }
    
    // Add clear all alerts button listener
    const clearAllBtn = document.getElementById('clear-all-alerts');
    if (clearAllBtn) {
        clearAllBtn.addEventListener('click', clearAllAlerts);
    }
    
    // Add filter event listeners
    document.getElementById('filter-severity').addEventListener('change', applyFilters);
    document.getElementById('filter-status').addEventListener('change', applyFilters);
    document.getElementById('filter-hours').addEventListener('change', applyFilters);
    document.getElementById('clear-filters').addEventListener('click', clearFilters);
    
    // Add event delegation for delete alert buttons
    document.addEventListener('click', function(e) {
        if (e.target.closest('.delete-alert-btn')) {
            const alertId = e.target.closest('.delete-alert-btn').dataset.alertId;
            if (alertId) {
                deleteAlert(parseInt(alertId));
            }
        }
    });
});
</script>
{% endblock %}