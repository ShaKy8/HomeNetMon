{% extends "base.html" %}

{% block title %}Alerts - HomeNetMon{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-exclamation-triangle"></i> Alerts</h1>
    
    <div class="btn-group">
        <button type="button" class="btn btn-outline-primary" id="refresh-alerts">
            <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
        <button type="button" class="btn btn-outline-secondary" id="acknowledge-all">
            <i class="bi bi-check-all"></i> Acknowledge All
        </button>
    </div>
</div>

<!-- Alert Summary -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card border-danger">
            <div class="card-body text-center">
                <i class="bi bi-exclamation-triangle display-4 text-danger"></i>
                <h3 class="mt-2 text-danger" id="critical-count">-</h3>
                <p class="mb-0">Critical</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card border-warning">
            <div class="card-body text-center">
                <i class="bi bi-exclamation-circle display-4 text-warning"></i>
                <h3 class="mt-2 text-warning" id="warning-count">-</h3>
                <p class="mb-0">Warning</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card border-info">
            <div class="card-body text-center">
                <i class="bi bi-info-circle display-4 text-info"></i>
                <h3 class="mt-2 text-info" id="info-count">-</h3>
                <p class="mb-0">Info</p>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row align-items-end">
            <div class="col-md-3">
                <label for="filter-severity" class="form-label">Severity</label>
                <select class="form-select" id="filter-severity">
                    <option value="">All Severities</option>
                    <option value="critical">Critical</option>
                    <option value="warning">Warning</option>
                    <option value="info">Info</option>
                </select>
            </div>
            
            <div class="col-md-3">
                <label for="filter-status" class="form-label">Status</label>
                <select class="form-select" id="filter-status">
                    <option value="">All</option>
                    <option value="false" selected>Active</option>
                    <option value="true">Resolved</option>
                </select>
            </div>
            
            <div class="col-md-3">
                <label for="filter-hours" class="form-label">Time Period</label>
                <select class="form-select" id="filter-hours">
                    <option value="24">Last 24 Hours</option>
                    <option value="168">Last 7 Days</option>
                    <option value="720">Last 30 Days</option>
                </select>
            </div>
            
            <div class="col-md-3">
                <button type="button" class="btn btn-outline-secondary" id="clear-filters">
                    <i class="bi bi-x-circle"></i> Clear Filters
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Indicator -->
<div class="text-center py-5" id="loading-indicator">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2 text-muted">Loading alerts...</p>
</div>

<!-- Alerts List -->
<div class="card" id="alerts-container" style="display: none;">
    <div class="card-header">
        <h5 class="mb-0">Alerts List</h5>
    </div>
    <div class="card-body p-0">
        <div id="alerts-list">
            <!-- Alert items will be inserted here -->
        </div>
    </div>
</div>

<!-- No Alerts Message -->
<div class="text-center py-5" id="no-alerts" style="display: none;">
    <i class="bi bi-check-circle display-1 text-success"></i>
    <h3 class="mt-3 text-success">No alerts found</h3>
    <p class="text-muted">All systems are running smoothly!</p>
</div>

<!-- Alert Detail Modal -->
<div class="modal fade" id="alertDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Alert Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="alert-detail-content">
                <!-- Alert details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-warning" id="acknowledge-alert-btn" style="display: none;">
                    <i class="bi bi-check"></i> Acknowledge
                </button>
                <button type="button" class="btn btn-success" id="resolve-alert-btn" style="display: none;">
                    <i class="bi bi-check-circle"></i> Resolve
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Simple alerts loading
async function loadAlerts() {
    console.log('Loading alerts...');
    
    // Force hide loading immediately
    document.getElementById('loading-indicator').style.display = 'none';
    
    try {
        const response = await fetch('/api/monitoring/alerts');
        const data = await response.json();
        
        console.log('Alerts loaded:', data);
        
        // Update summary counts
        document.getElementById('critical-count').textContent = '0';
        document.getElementById('warning-count').textContent = '0';
        document.getElementById('info-count').textContent = data.alerts ? data.alerts.length : '0';
        
        if (data.alerts && data.alerts.length > 0) {
            // Show alerts
            document.getElementById('alerts-container').style.display = 'block';
            document.getElementById('no-alerts').style.display = 'none';
            
            // Simple alert display
            const alertsList = document.getElementById('alerts-list');
            alertsList.innerHTML = '';
            
            data.alerts.forEach(alert => {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'p-3 border-bottom';
                alertDiv.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">${alert.device_name} (${alert.device_ip})</h6>
                            <p class="mb-1">${alert.message}</p>
                            <small class="text-muted">Created: ${new Date(alert.created_at).toLocaleString()}</small>
                        </div>
                        <span class="badge bg-info">${alert.severity.toUpperCase()}</span>
                    </div>
                `;
                alertsList.appendChild(alertDiv);
            });
            
        } else {
            // No alerts
            document.getElementById('alerts-container').style.display = 'none';
            document.getElementById('no-alerts').style.display = 'block';
        }
        
    } catch (error) {
        console.error('Error loading alerts:', error);
        
        // Show error
        document.getElementById('alerts-container').style.display = 'none';
        document.getElementById('no-alerts').style.display = 'none';
        
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger';
        errorDiv.innerHTML = `<h4>Error Loading Alerts</h4><p>${error.message}</p>`;
        document.body.appendChild(errorDiv);
    }
}

// Acknowledge all alerts function
async function acknowledgeAllAlerts() {
    try {
        const response = await fetch('/api/monitoring/alerts/acknowledge-all', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                acknowledged_by: 'web_user'
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            console.log('Acknowledged alerts:', data);
            // Show success message
            const alertsContainer = document.getElementById('alerts-container');
            if (alertsContainer) {
                const successDiv = document.createElement('div');
                successDiv.className = 'alert alert-success alert-dismissible fade show';
                successDiv.innerHTML = `
                    <i class="bi bi-check-circle"></i> ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                alertsContainer.insertBefore(successDiv, alertsContainer.firstChild);
                
                // Auto-dismiss after 3 seconds
                setTimeout(() => {
                    if (successDiv.parentNode) {
                        successDiv.remove();
                    }
                }, 3000);
            }
            
            // Reload alerts to show updated status
            await loadAlerts();
        } else {
            console.error('Error acknowledging alerts:', data);
            alert('Error acknowledging alerts: ' + (data.error || 'Unknown error'));
        }
        
    } catch (error) {
        console.error('Error acknowledging alerts:', error);
        alert('Error acknowledging alerts: ' + error.message);
    }
}

// Simple initialization
document.addEventListener('DOMContentLoaded', function() {
    console.log('Alerts page loaded, calling loadAlerts()');
    loadAlerts();
    
    // Add refresh button listener
    const refreshBtn = document.getElementById('refresh-alerts');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', loadAlerts);
    }
    
    // Add acknowledge all button listener
    const acknowledgeAllBtn = document.getElementById('acknowledge-all');
    if (acknowledgeAllBtn) {
        acknowledgeAllBtn.addEventListener('click', acknowledgeAllAlerts);
    }
});
</script>
{% endblock %}