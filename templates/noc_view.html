{% extends "base_beautiful.html" %}

{% block title %}NOC - Network Operations Center | HomeNetMon{% endblock %}

{% block navbar %}
<!-- Override standard navigation with NOC-specific header -->
<div class="noc-header">
    <div class="row align-items-center">
        <div class="col-md-3">
            <div class="noc-clock" id="noc-clock">--:--:--</div>
        </div>
        <div class="col-md-6 text-center">
            <h2 class="mb-0">
                <i class="bi bi-hdd-network me-2"></i>
                NETWORK OPERATIONS CENTER
            </h2>
        </div>
        <div class="col-md-3 text-end">
            <div class="network-status" id="network-status" role="status" aria-live="polite">
                <span class="status-indicator" aria-label="Network status">INITIALIZING</span>
                <span class="visually-hidden" id="network-status-description">Network status is initializing</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Cache buster for layout updates */
meta[name="cache-buster"] { content: "noc-layout-fix-v5-no-overlap"; }

/* NOC Dark Theme */
:root {
    --noc-bg-primary: #0a0e27;
    --noc-bg-secondary: #1a1f3a;
    --noc-bg-tertiary: #2a2f4a;
    --noc-accent-cyan: #00ffff;
    --noc-accent-green: #00ff41;
    --noc-accent-red: #ff0040;
    --noc-accent-yellow: #ffff00;
    --noc-text-primary: #ffffff;
    --noc-text-secondary: #a0a0a0;
    --noc-border: #3a3f5a;
}

/* Override body styles for NOC mode */
body {
    background: linear-gradient(135deg, var(--noc-bg-primary) 0%, var(--noc-bg-secondary) 100%);
    font-family: 'Courier New', monospace;
    color: var(--noc-text-primary);
    overflow-x: hidden;
}

/* Header */
.noc-header {
    background: var(--noc-bg-secondary);
    border-bottom: 2px solid var(--noc-accent-cyan);
    padding: 10px 20px;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    box-shadow: 0 2px 20px rgba(0, 255, 255, 0.3);
}

.noc-clock {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--noc-accent-cyan);
    text-shadow: 0 0 10px var(--noc-accent-cyan);
    line-height: 1.2;
}

.noc-clock small,
.noc-clock .noc-date {
    font-size: 0.7rem;
    opacity: 0.8;
    display: block;
    margin-top: 2px;
    color: var(--noc-accent-cyan);
    font-weight: normal;
}

.network-status {
    font-size: 1.2rem;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 2px;
}

.status-online {
    color: var(--noc-accent-green);
    text-shadow: 0 0 10px var(--noc-accent-green);
}
.status-degraded {
    color: var(--noc-accent-yellow);
    text-shadow: 0 0 10px var(--noc-accent-yellow);
}
.status-critical {
    color: var(--noc-accent-red);
    text-shadow: 0 0 10px var(--noc-accent-red);
}

/* Content area adjustment for fixed header */
.main-content {
    margin-top: 80px;
    padding: 20px;
}

.noc-content {
    padding: 20px;
    min-height: calc(100vh - 100px);
}

/* Status Panels */
.noc-panel {
    background: var(--noc-bg-secondary);
    border: 1px solid var(--noc-border);
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    backdrop-filter: blur(10px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
}

.noc-panel h5 {
    color: var(--noc-accent-cyan);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 15px;
    font-size: 1rem;
}

.stat-gauge {
    text-align: center;
    padding: 10px;
}

.stat-value {
    font-size: 1.8rem;
    font-weight: bold;
    margin-bottom: 5px;
}

.stat-label {
    font-size: 0.8rem;
    text-transform: uppercase;
    opacity: 0.8;
    letter-spacing: 0.5px;
}

/* Enhanced Health Score Panel */
.health-score-panel-enhanced {
    border: 2px solid var(--noc-accent-cyan);
    background: linear-gradient(135deg, var(--noc-bg-secondary) 0%, rgba(0, 255, 255, 0.05) 100%);
    box-shadow: 0 8px 40px rgba(0, 255, 255, 0.3);
}

.health-score-display-enhanced {
    text-align: center;
    padding: 20px;
}

.health-score-number-enhanced {
    font-size: 4rem;
    font-weight: 300;
    color: var(--noc-accent-cyan);
    text-shadow: 0 0 20px var(--noc-accent-cyan);
    line-height: 1;
}

.health-score-label-enhanced {
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 2px;
    opacity: 0.8;
    margin-top: 10px;
}

.health-summary-text {
    font-size: 0.85rem;
    opacity: 0.7;
    margin-top: 8px;
    font-style: italic;
}

.health-trend-indicator {
    display: flex;
    align-items: center;
}

.trend-arrow {
    font-size: 2rem;
    animation: trendPulse 2s ease-in-out infinite;
}

@keyframes trendPulse {
    0%, 100% { opacity: 0.7; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.1); }
}

/* Health Score Color Variations */
.health-score-excellent { color: var(--noc-accent-green); text-shadow: 0 0 20px var(--noc-accent-green); }
.health-score-good { color: var(--noc-accent-cyan); text-shadow: 0 0 20px var(--noc-accent-cyan); }
.health-score-fair { color: var(--noc-accent-yellow); text-shadow: 0 0 20px var(--noc-accent-yellow); }
.health-score-poor { color: var(--noc-accent-red); text-shadow: 0 0 20px var(--noc-accent-red); }

/* Device Grid */
.device-tile {
    background: var(--noc-bg-tertiary);
    border: 2px solid var(--noc-border);
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.device-tile:hover {
    border-color: var(--noc-accent-cyan);
    box-shadow: 0 0 20px rgba(0, 255, 255, 0.4);
    transform: translateY(-2px);
}

.device-tile.device-online {
    border-left: 4px solid var(--noc-accent-green);
}

.device-tile.device-offline {
    border-left: 4px solid var(--noc-accent-red);
    animation: criticalPulse 2s ease-in-out infinite;
}

.device-tile.device-warning {
    border-left: 4px solid var(--noc-accent-yellow);
}

@keyframes criticalPulse {
    0%, 100% { box-shadow: 0 0 5px rgba(255, 0, 64, 0.3); }
    50% { box-shadow: 0 0 20px rgba(255, 0, 64, 0.8); }
}

.device-name {
    font-weight: bold;
    font-size: 1rem;
    margin-bottom: 5px;
    color: var(--noc-text-primary);
}

.device-ip {
    font-size: 0.85rem;
    opacity: 0.8;
    margin-bottom: 8px;
    font-family: 'Courier New', monospace;
}

.device-status {
    font-size: 0.8rem;
    text-transform: uppercase;
    font-weight: bold;
    letter-spacing: 0.5px;
}

.device-priority-indicator {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid var(--noc-bg-secondary);
}

.device-priority-indicator.critical {
    background: var(--noc-accent-red);
    box-shadow: 0 0 8px var(--noc-accent-red);
    animation: criticalPulse 1.5s ease-in-out infinite;
}

.device-priority-indicator.normal {
    background: var(--noc-accent-green);
}

.device-priority-indicator.monitoring {
    background: var(--noc-accent-cyan);
}

.device-response-time {
    font-size: 0.75rem;
    opacity: 0.7;
    margin-top: 5px;
}

/* Quick Actions */
.quick-actions {
    margin-top: 10px;
}

.quick-action-btn {
    background: var(--noc-bg-secondary);
    border: 1px solid var(--noc-accent-cyan);
    color: var(--noc-accent-cyan);
    font-size: 0.7rem;
    padding: 2px 6px;
    margin-right: 5px;
    border-radius: 3px;
    text-decoration: none;
}

.quick-action-btn:hover {
    background: var(--noc-accent-cyan);
    color: var(--noc-bg-primary);
}

/* Badge Styles */
.noc-badge {
    font-size: 0.65rem;
    font-weight: bold;
    padding: 2px 4px;
    border-radius: 3px;
    background: var(--noc-accent-red);
    color: white;
    opacity: 0.9;
}

.device-count-badge {
    background: var(--noc-accent-cyan);
    color: var(--noc-bg-primary);
}

/* Device Controls */
.device-controls {
    display: flex;
    align-items: center;
    gap: 10px;
}

.device-controls .btn-group {
    flex-shrink: 0;
}

.device-controls .btn {
    font-size: 0.8rem;
    padding: 4px 8px;
}

/* Device Groups (Collapsible) */
.device-group {
    border: 1px solid var(--noc-border);
    border-radius: 6px;
    margin-bottom: 15px;
    background: var(--noc-bg-primary);
}

.device-group-header {
    padding: 10px 15px;
    background: var(--noc-bg-secondary);
    border-bottom: 1px solid var(--noc-border);
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: background-color 0.3s ease;
}

.device-group-header:hover {
    background: var(--noc-bg-tertiary);
}

.device-group-content {
    padding: 15px;
}

.device-group-title {
    font-weight: bold;
    color: var(--noc-accent-cyan);
    margin: 0;
}

.device-group-count {
    background: var(--noc-accent-cyan);
    color: var(--noc-bg-primary);
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.8rem;
}

/* Show More Button */
#show-more-devices {
    background-color: transparent;
    border: 1px solid var(--noc-accent-cyan);
    color: var(--noc-accent-cyan);
    transition: all 0.3s ease;
}

#show-more-devices:hover {
    background-color: var(--noc-accent-cyan);
    color: var(--noc-bg-primary);
    transform: translateY(-2px);
}

/* Advanced Search Panel */
.advanced-search-panel {
    background: var(--noc-bg-primary);
    border: 1px solid var(--noc-border);
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
}

.advanced-search-panel .form-control,
.advanced-search-panel .form-select {
    background-color: var(--noc-bg-secondary) !important;
    border-color: var(--noc-border) !important;
    color: var(--noc-text-primary) !important;
}

.advanced-search-panel .form-control:focus,
.advanced-search-panel .form-select:focus {
    border-color: var(--noc-accent-cyan) !important;
    box-shadow: 0 0 0 0.2rem rgba(0, 255, 255, 0.25) !important;
}

.advanced-search-panel .input-group-text {
    background-color: var(--noc-bg-secondary) !important;
    border-color: var(--noc-border) !important;
    color: var(--noc-accent-cyan) !important;
}

.quick-filter-btn {
    margin: 2px;
    font-size: 0.8rem;
    padding: 4px 8px;
}

.quick-filter-btn.active {
    background-color: var(--noc-accent-cyan);
    border-color: var(--noc-accent-cyan);
    color: var(--noc-bg-primary);
}

/* Search Results */
.search-results-summary {
    padding: 8px 12px;
    background: rgba(0, 255, 255, 0.1);
    border-radius: 4px;
    border-left: 3px solid var(--noc-accent-cyan);
    margin-bottom: 10px;
}

.search-highlight {
    background: rgba(255, 255, 0, 0.3);
    padding: 1px 3px;
    border-radius: 2px;
}

/* Device Type Filters */
.device-type-filter {
    margin-bottom: 15px;
}

.device-type-filter .btn {
    font-size: 0.8rem;
    padding: 4px 8px;
    margin: 2px;
}

/* Toggle Search Button */
#toggle-search {
    background-color: transparent;
    border: 1px solid var(--noc-accent-cyan);
    color: var(--noc-accent-cyan);
    transition: all 0.3s ease;
}

#toggle-search:hover,
#toggle-search.active {
    background-color: var(--noc-accent-cyan);
    color: var(--noc-bg-primary);
}

/* Skeleton Loading States */
.skeleton {
    background: linear-gradient(90deg,
        var(--noc-bg-tertiary) 25%,
        var(--noc-bg-secondary) 50%,
        var(--noc-bg-tertiary) 75%
    );
    background-size: 200% 100%;
    animation: skeletonLoading 1.5s infinite;
}

@keyframes skeletonLoading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

/* Loading Overlays */
.loading-overlay::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.loading-overlay[data-loading-size="small"]::after {
    font-size: 0.8rem;
}

.loading-overlay[data-loading-size="large"]::after {
    font-size: 1.5rem;
}

/* Modal Loading */
.modal-loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(26, 31, 58, 0.9);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 1050;
}

.modal-loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid var(--noc-bg-tertiary);
    border-top: 4px solid var(--noc-accent-cyan);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 15px;
}

.modal-loading-text {
    color: var(--noc-accent-cyan);
    font-size: 0.9rem;
    text-align: center;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Button Loading States */
.btn-loading {
    position: relative;
    pointer-events: none;
}

.btn-loading::after {
    content: '';
    position: absolute;
    width: 16px;
    height: 16px;
    top: 50%;
    left: 50%;
    margin-left: -8px;
    margin-top: -8px;
    border: 2px solid transparent;
    border-top: 2px solid currentColor;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

/* Progress Bars */
.noc-progress {
    height: 4px;
    background: var(--noc-bg-tertiary);
    border-radius: 2px;
    overflow: hidden;
    margin-bottom: 10px;
}

.noc-progress-bar {
    height: 100%;
    background: linear-gradient(90deg,
        var(--noc-accent-cyan),
        var(--noc-accent-green),
        var(--noc-accent-cyan)
    );
    background-size: 200% 100%;
    animation: progressShimmer 2s infinite;
    transition: width 0.3s ease;
}

@keyframes progressShimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

/* Toast Notifications */
.noc-toast {
    position: fixed;
    top: 100px;
    right: 20px;
    background: var(--noc-bg-secondary);
    border: 1px solid var(--noc-accent-cyan);
    color: var(--noc-text-primary);
    padding: 12px 16px;
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    z-index: 1060;
    max-width: 300px;
    animation: slideInRight 0.3s ease;
}

.noc-toast.toast-error {
    border-color: var(--noc-accent-red);
    background: linear-gradient(135deg, var(--noc-bg-secondary), rgba(255, 0, 64, 0.1));
}

.noc-toast.toast-success {
    border-color: var(--noc-accent-green);
    background: linear-gradient(135deg, var(--noc-bg-secondary), rgba(0, 255, 65, 0.1));
}

.noc-toast.toast-warning {
    border-color: var(--noc-accent-yellow);
    background: linear-gradient(135deg, var(--noc-bg-secondary), rgba(255, 255, 0, 0.1));
}

@keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

/* Alerts Feed */
.alerts-feed {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid var(--noc-border);
    border-radius: 5px;
    padding: 10px;
    background: var(--noc-bg-primary);
}

.alert-item {
    background: var(--noc-bg-tertiary);
    border-left: 4px solid;
    padding: 8px 12px;
    margin-bottom: 8px;
    border-radius: 4px;
    font-size: 0.85rem;
    transition: all 0.3s ease;
}

.alert-item:hover {
    transform: translateX(5px);
}

.alert-critical {
    border-left-color: var(--noc-accent-red);
    background: linear-gradient(135deg, var(--noc-bg-tertiary) 0%, rgba(255, 0, 64, 0.1) 100%);
}
.alert-warning {
    border-left-color: var(--noc-accent-yellow);
    background: linear-gradient(135deg, var(--noc-bg-tertiary) 0%, rgba(255, 255, 0, 0.1) 100%);
}
.alert-info {
    border-left-color: var(--noc-accent-cyan);
    background: linear-gradient(135deg, var(--noc-bg-tertiary) 0%, rgba(0, 255, 255, 0.1) 100%);
}

.alert-timestamp {
    font-size: 0.7rem;
    opacity: 0.7;
    float: right;
}

.alert-acknowledged {
    opacity: 0.6;
    text-decoration: line-through;
}

/* Critical Alert Banner */
.critical-alert-banner {
    margin-bottom: 15px;
    animation: criticalAlertPulse 2s ease-in-out infinite;
}

.critical-alert-banner .alert {
    background: linear-gradient(135deg, var(--noc-accent-red), rgba(255, 0, 64, 0.7));
    border: 2px solid var(--noc-accent-red);
    box-shadow: 0 0 20px rgba(255, 0, 64, 0.5);
    color: white;
    font-weight: bold;
    margin: 0;
}

@keyframes criticalAlertPulse {
    0%, 100% { opacity: 0.9; }
    50% { opacity: 1; }
}

/* Alert Controls */
.alert-controls {
    margin-bottom: 10px;
}

.alert-controls .btn {
    font-size: 0.75rem;
    padding: 3px 6px;
}

.alert-sound-toggle button {
    background-color: transparent;
    border: 1px solid var(--noc-accent-cyan);
    color: var(--noc-accent-cyan);
}

.alert-sound-toggle button:hover {
    background-color: var(--noc-accent-cyan);
    color: var(--noc-bg-primary);
}

/* Sound indicator for disabled alerts */
.alert-sound-disabled #sound-icon::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 2px;
    height: 20px;
    background: var(--noc-accent-red);
    transform: rotate(45deg);
    top: 50%;
    left: 50%;
    margin-top: -10px;
    margin-left: -1px;
}

/* Alert Severity Headers */
.alert-severity-section {
    margin-bottom: 20px;
}

.alert-severity-header {
    padding: 8px 12px;
    border-radius: 4px;
    font-weight: bold;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.alert-severity-header.critical {
    background: rgba(255, 0, 64, 0.2);
    color: var(--noc-accent-red);
    border: 1px solid var(--noc-accent-red);
}

.alert-severity-header.warning {
    background: rgba(255, 255, 0, 0.2);
    color: var(--noc-accent-yellow);
    border: 1px solid var(--noc-accent-yellow);
}

.alert-severity-header.info {
    background: rgba(0, 255, 255, 0.2);
    color: var(--noc-accent-cyan);
    border: 1px solid var(--noc-accent-cyan);
}

/* Network Map */
.network-map {
    height: 250px;
    background: var(--noc-bg-primary);
    border: 1px solid var(--noc-border);
    border-radius: 8px;
    position: relative;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
}

.map-node {
    position: absolute;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 2px solid;
    cursor: pointer;
    transition: all 0.3s ease;
}

.map-node:hover {
    transform: scale(1.2);
}

.map-node.online {
    background: var(--noc-accent-green);
    border-color: var(--noc-accent-green);
    box-shadow: 0 0 10px var(--noc-accent-green);
}
.map-node.offline {
    background: var(--noc-accent-red);
    border-color: var(--noc-accent-red);
    box-shadow: 0 0 10px var(--noc-accent-red);
}

.map-connection {
    position: absolute;
    height: 1px;
    background: var(--noc-accent-cyan);
    opacity: 0.6;
}

/* Scrollbar Styling */
::-webkit-scrollbar {
    width: 8px;
}

::-webkit-scrollbar-track {
    background: var(--noc-bg-primary);
}

::-webkit-scrollbar-thumb {
    background: var(--noc-accent-cyan);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: var(--noc-accent-green);
}

/* Full Screen Button */
.fullscreen-btn {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--noc-bg-secondary);
    border: 1px solid var(--noc-accent-cyan);
    color: var(--noc-accent-cyan);
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    z-index: 1001;
    transition: all 0.3s ease;
}

.fullscreen-btn:hover {
    background: var(--noc-accent-cyan);
    color: var(--noc-bg-primary);
}

/* Responsive Styles */
@media (max-width: 768px) {
    .noc-header {
        padding: 8px 15px;
        position: relative;
    }

    .noc-header .row {
        align-items: center !important;
    }

    .noc-header .col-md-3,
    .noc-header .col-md-6 {
        text-align: center !important;
        margin-bottom: 5px;
    }

    .noc-header h2 {
        font-size: 1.2rem;
        margin: 0;
    }

    .noc-clock {
        font-size: 1.2rem;
    }

    .health-score-number-enhanced {
        font-size: 3rem;
    }

    .device-tile {
        margin-bottom: 10px;
        padding: 12px;
    }

    .noc-panel {
        padding: 15px;
        margin-bottom: 15px;
    }

    .device-controls {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
    }

    .device-controls .btn-group {
        width: 100%;
    }

    .advanced-search-panel .row {
        margin-bottom: 10px;
    }

    .advanced-search-panel .col-md-8,
    .advanced-search-panel .col-md-4 {
        margin-bottom: 10px;
    }

    .quick-filters .btn-group {
        width: 100%;
    }

    .quick-filter-btn {
        flex: 1;
    }

    .network-map {
        height: 200px;
    }

    .alerts-feed {
        max-height: 300px;
    }
}

@media (max-width: 576px) {
    .main-content {
        margin-top: 60px;
        padding: 10px;
    }

    .noc-content {
        padding: 10px;
    }

    .noc-header {
        padding: 5px 15px;
    }

    .noc-clock {
        font-size: 1rem;
    }

    .noc-clock small,
    .noc-clock .noc-date {
        font-size: 0.6rem;
    }

    .network-status {
        font-size: 0.9rem;
    }

    .health-score-number-enhanced {
        font-size: 2.5rem;
    }

    .noc-panel {
        padding: 10px;
    }

    .device-tile {
        padding: 10px;
    }

    .device-controls .btn {
        font-size: 0.7rem;
        padding: 3px 6px;
    }

    .fullscreen-btn {
        top: 10px;
        right: 10px;
        padding: 6px 10px;
        font-size: 0.8rem;
    }
}

/* Global Loading Indicator */
.global-loading {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 255, 255, 0.9);
    color: var(--noc-bg-primary);
    padding: 12px 20px;
    border-radius: 6px;
    z-index: 10000;
    font-weight: bold;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
}

/* Touch feedback for mobile */
.device-tile:active,
.quick-action-btn:active,
.btn:active {
    transform: scale(0.95);
}

/* Accessibility improvements */
.visually-hidden {
    position: absolute !important;
    width: 1px !important;
    height: 1px !important;
    padding: 0 !important;
    margin: -1px !important;
    overflow: hidden !important;
    clip: rect(0, 0, 0, 0) !important;
    white-space: nowrap !important;
    border: 0 !important;
}

/* Focus styles for keyboard navigation */
.device-tile:focus,
.quick-action-btn:focus,
.btn:focus {
    outline: 2px solid var(--noc-accent-cyan);
    outline-offset: 2px;
}

/* High contrast mode adjustments */
@media (prefers-contrast: high) {
    :root {
        --noc-border: #ffffff;
        --noc-text-secondary: #ffffff;
    }

    .noc-panel {
        border: 2px solid var(--noc-border);
    }

    .device-tile {
        border: 2px solid var(--noc-border);
    }
}

/* Reduced motion for accessibility */
@media (prefers-reduced-motion: reduce) {
    * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- Full Screen Button -->
<button class="fullscreen-btn" onclick="toggleFullscreen()">
    <i class="bi bi-fullscreen"></i>
</button>

<!-- Main Content -->
<div class="noc-content">
    <div class="row">
        <!-- Top Row - Prominent Health Score -->
        <div class="col-12 mb-4">
            <div class="row">
                <!-- Enhanced Health Score Panel (Larger) -->
                <div class="col-lg-6">
                    <div class="noc-panel health-score-panel-enhanced">
                        <h4 class="text-center mb-3">
                            <i class="bi bi-heart-pulse me-2"></i>NETWORK HEALTH
                        </h4>
                        <div class="health-score-display-enhanced" role="region" aria-labelledby="health-score-heading">
                            <div class="d-flex align-items-center justify-content-center">
                                <div class="health-score-number-enhanced" id="health-score"
                                     aria-label="Network health score out of 100"
                                     role="status" aria-live="polite">--</div>
                                <div class="health-trend-indicator ms-3" id="health-trend">
                                    <i class="bi bi-arrow-up text-success trend-arrow" id="trend-arrow" style="display: none;"></i>
                                </div>
                            </div>
                            <div class="health-score-label-enhanced" id="health-score-heading">HEALTH SCORE</div>
                            <div class="health-summary-text" id="health-summary">
                                Network operational status
                            </div>
                            <div class="visually-hidden" id="health-score-description">
                                Network health score indicates overall system performance and availability
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Network Summary (Moved from left column) -->
                <div class="col-lg-6">
                    <div class="noc-panel">
                        <h5 class="mb-3">
                            <i class="bi bi-speedometer2 me-2"></i>NETWORK SUMMARY
                        </h5>
                        <div class="row">
                            <div class="col-6">
                                <div class="stat-gauge">
                                    <div class="stat-value text-info" id="noc-avg-response-time">--</div>
                                    <div class="stat-label">Avg Response</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stat-gauge">
                                    <div class="stat-value text-secondary" id="noc-last-update">--</div>
                                    <div class="stat-label">Last Update</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Left Column - Network Map -->
        <div class="col-lg-4">
            <!-- Network Map -->
            <div class="noc-panel">
                <h5 class="mb-3">
                    <i class="bi bi-diagram-3 me-2"></i>NETWORK TOPOLOGY
                </h5>
                <div class="network-map" id="network-map">
                    <!-- Network nodes will be dynamically added here -->
                </div>
            </div>
        </div>

        <!-- Center Column - Device Grid -->
        <div class="col-lg-5">
            <div class="noc-panel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">
                        <i class="bi bi-hdd-stack me-2"></i>DEVICES
                        <span class="badge bg-secondary ms-2" id="device-count">0</span>
                    </h5>
                    <div class="device-controls">
                        <div class="btn-group btn-group-sm" role="group">
                            <input type="checkbox" class="btn-check" id="show-critical-only" checked>
                            <label class="btn btn-outline-danger" for="show-critical-only">Critical</label>

                            <input type="checkbox" class="btn-check" id="show-all-devices">
                            <label class="btn btn-outline-secondary" for="show-all-devices">All</label>

                            <button class="btn btn-outline-info btn-sm" id="toggle-search" title="Toggle search">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Advanced Search Interface -->
                <div class="advanced-search-panel" id="advanced-search-panel" style="display: none;">
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text bg-dark border-secondary">
                                    <i class="bi bi-search text-info"></i>
                                </span>
                                <input type="text"
                                       class="form-control bg-dark border-secondary text-light"
                                       id="device-search"
                                       placeholder="Search devices by name, IP, MAC, or type..."
                                       autocomplete="off">
                                <button class="btn btn-outline-secondary" id="clear-search" title="Clear search">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <select class="form-select form-select-sm bg-dark border-secondary text-light" id="search-sort">
                                <option value="priority">Sort by Priority</option>
                                <option value="name">Sort by Name</option>
                                <option value="status">Sort by Status</option>
                                <option value="response_time">Sort by Response Time</option>
                                <option value="last_seen">Sort by Last Seen</option>
                            </select>
                        </div>
                    </div>

                    <!-- Quick Filter Buttons -->
                    <div class="quick-filters mb-3">
                        <div class="btn-group btn-group-sm flex-wrap" role="group">
                            <button class="btn btn-outline-danger quick-filter-btn" data-filter="down">
                                <i class="bi bi-x-circle me-1"></i>Offline
                            </button>
                            <button class="btn btn-outline-warning quick-filter-btn" data-filter="warning">
                                <i class="bi bi-exclamation-triangle me-1"></i>Warning
                            </button>
                            <button class="btn btn-outline-success quick-filter-btn" data-filter="up">
                                <i class="bi bi-check-circle me-1"></i>Online
                            </button>
                            <button class="btn btn-outline-primary quick-filter-btn" data-filter="favorites">
                                <i class="bi bi-star-fill me-1"></i>Favorites
                            </button>
                            <button class="btn btn-outline-info quick-filter-btn" data-filter="recent">
                                <i class="bi bi-clock me-1"></i>Recent
                            </button>
                        </div>
                    </div>

                    <!-- Search Results Summary -->
                    <div class="search-results-summary" id="search-results-summary" style="display: none;">
                        <small class="text-muted">
                            <span id="search-results-count">0</span> results found
                            <span id="search-results-terms" class="ms-2"></span>
                        </small>
                    </div>
                </div>

                <!-- Device Type Filter -->
                <div class="device-type-filter mb-3" id="device-type-filter" style="display: none;">
                    <div class="btn-group btn-group-sm flex-wrap" role="group">
                        <input type="checkbox" class="btn-check" id="filter-router" checked>
                        <label class="btn btn-outline-info" for="filter-router">
                            <i class="bi bi-router me-1"></i>Network
                        </label>

                        <input type="checkbox" class="btn-check" id="filter-computer" checked>
                        <label class="btn btn-outline-success" for="filter-computer">
                            <i class="bi bi-pc-display me-1"></i>Computers
                        </label>

                        <input type="checkbox" class="btn-check" id="filter-mobile" checked>
                        <label class="btn btn-outline-warning" for="filter-mobile">
                            <i class="bi bi-phone me-1"></i>Mobile
                        </label>

                        <input type="checkbox" class="btn-check" id="filter-iot" checked>
                        <label class="btn btn-outline-secondary" for="filter-iot">
                            <i class="bi bi-cpu me-1"></i>IoT
                        </label>
                    </div>
                </div>

                <!-- Device Grid -->
                <div class="device-grid-container">
                    <div class="row" id="device-grid">
                        <!-- Device tiles will be dynamically added here -->
                    </div>

                    <!-- Show More Button -->
                    <div class="text-center mt-3" id="show-more-container" style="display: none;">
                        <button class="btn btn-outline-secondary btn-sm" id="show-more-devices">
                            <i class="bi bi-chevron-down me-1"></i>Show More Devices
                        </button>
                    </div>

                    <!-- Device Groups (Expandable Sections) -->
                    <div class="device-groups" id="device-groups" style="display: none;">
                        <!-- Groups will be dynamically added here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column - Alerts and Activity -->
        <div class="col-lg-3">
            <!-- Active Alerts -->
            <div class="noc-panel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">
                        <i class="bi bi-exclamation-triangle me-2"></i>ACTIVE ALERTS
                        <span class="badge bg-danger ms-2" id="critical-alert-count" style="display: none;">0</span>
                        <span class="badge bg-warning ms-1" id="warning-alert-count" style="display: none;">0</span>
                    </h5>
                    <div class="alert-sound-toggle">
                        <button class="btn btn-outline-secondary btn-sm" id="alert-sound-toggle" title="Toggle alert sounds">
                            <i class="bi bi-volume-up" id="sound-icon"></i>
                        </button>
                    </div>
                </div>

                <!-- Critical Alert Banner (only shown when critical alerts exist) -->
                <div class="critical-alert-banner" id="critical-alert-banner" style="display: none;">
                    <div class="alert alert-danger d-flex align-items-center" role="alert">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <div class="flex-grow-1">
                            <strong>CRITICAL ALERT:</strong> <span id="critical-alert-text">Network issues detected</span>
                        </div>
                        <button class="btn btn-outline-light btn-sm" id="view-critical-btn">View All</button>
                    </div>
                </div>

                <div class="alert-controls mb-2">
                    <div class="btn-group btn-group-sm" role="group">
                        <input type="checkbox" class="btn-check" id="filter-critical" checked>
                        <label class="btn btn-outline-danger" for="filter-critical">Critical</label>

                        <input type="checkbox" class="btn-check" id="filter-warning" checked>
                        <label class="btn btn-outline-warning" for="filter-warning">Warning</label>

                        <input type="checkbox" class="btn-check" id="filter-info" checked>
                        <label class="btn btn-outline-info" for="filter-info">Info</label>

                        <input type="checkbox" class="btn-check" id="show-acknowledged">
                        <label class="btn btn-outline-secondary" for="show-acknowledged">Acknowledged</label>
                    </div>
                    <button class="btn btn-outline-secondary btn-sm ms-2" id="acknowledge-all-btn" title="Acknowledge all visible alerts">
                        <i class="bi bi-check-all"></i>
                    </button>
                </div>
                <div class="alerts-feed" id="alerts-feed" role="log" aria-live="polite" aria-label="Active alerts feed">
                    <!-- Alerts will be dynamically added here -->
                </div>
            </div>

            <!-- Activity Feed -->
            <div class="noc-panel">
                <h5 class="mb-3">
                    <i class="bi bi-activity me-2"></i>RECENT ACTIVITY
                </h5>
                <div class="alerts-feed" id="activity-feed">
                    <!-- Activity will be dynamically added here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- NOC Device Details Modal -->
<div class="modal fade" id="nocDeviceModal" data-bs-theme="dark" tabindex="-1" aria-labelledby="nocDeviceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: var(--noc-bg-secondary); border: 1px solid var(--noc-accent-cyan);">
            <div class="modal-header" style="border-bottom: 1px solid var(--noc-accent-cyan);">
                <h5 class="modal-title" id="nocDeviceModalLabel">
                    <i class="bi bi-hdd-network me-2"></i>Device Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Device Information -->
                    <div class="col-md-8">
                        <div class="noc-panel mb-3">
                            <h6 class="text-uppercase mb-3" style="color: var(--noc-accent-cyan); letter-spacing: 1px;">
                                <i class="bi bi-info-circle me-2"></i>Device Information
                            </h6>
                            <div class="row">
                                <div class="col-sm-4"><strong>Name:</strong></div>
                                <div class="col-sm-8" id="modal-device-name">--</div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-sm-4"><strong>IP Address:</strong></div>
                                <div class="col-sm-8" id="modal-device-ip">--</div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-sm-4"><strong>MAC Address:</strong></div>
                                <div class="col-sm-8" id="modal-device-mac">--</div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-sm-4"><strong>Vendor:</strong></div>
                                <div class="col-sm-8" id="modal-device-vendor">--</div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-sm-4"><strong>Device Type:</strong></div>
                                <div class="col-sm-8" id="modal-device-type">--</div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-sm-4"><strong>Status:</strong></div>
                                <div class="col-sm-8">
                                    <span id="modal-device-status" class="badge">--</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Monitoring Controls -->
                    <div class="col-md-4">
                        <div class="noc-panel mb-3">
                            <h6 class="text-uppercase mb-3" style="color: var(--noc-accent-green); letter-spacing: 1px;">
                                <i class="bi bi-activity me-2"></i>Monitoring
                            </h6>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="modal-monitoring-toggle" style="background-color: var(--noc-bg-primary); border-color: var(--noc-accent-cyan);">
                                <label class="form-check-label" for="modal-monitoring-toggle">
                                    Enable Monitoring
                                </label>
                            </div>
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-outline-info btn-sm" id="modal-ping-btn">
                                    <i class="bi bi-wifi me-1"></i>Ping Device
                                </button>
                                <button type="button" class="btn btn-outline-warning btn-sm" id="modal-wake-btn">
                                    <i class="bi bi-power me-1"></i>Wake on LAN
                                </button>
                                <button type="button" class="btn btn-outline-success btn-sm" id="modal-scan-btn">
                                    <i class="bi bi-search me-1"></i>Port Scan
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Metrics -->
                <div class="noc-panel">
                    <h6 class="text-uppercase mb-3" style="color: var(--noc-accent-yellow); letter-spacing: 1px;">
                        <i class="bi bi-speedometer2 me-2"></i>Performance Metrics
                    </h6>
                    <div class="row text-center">
                        <div class="col-3">
                            <div class="stat-value" id="modal-response-time" style="color: var(--noc-accent-cyan);">--</div>
                            <div class="stat-label">Response Time</div>
                        </div>
                        <div class="col-3">
                            <div class="stat-value" id="modal-uptime" style="color: var(--noc-accent-green);">--</div>
                            <div class="stat-label">Uptime %</div>
                        </div>
                        <div class="col-3">
                            <div class="stat-value" id="modal-last-seen" style="color: var(--noc-accent-yellow);">--</div>
                            <div class="stat-label">Last Seen</div>
                        </div>
                        <div class="col-3">
                            <div class="stat-value" id="modal-alerts-count" style="color: var(--noc-accent-red);">--</div>
                            <div class="stat-label">Active Alerts</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid var(--noc-accent-cyan);">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-outline-primary" id="modal-view-details-btn">
                    <i class="bi bi-box-arrow-up-right me-1"></i>View Full Details
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Action Results Modal -->
<div class="modal fade" id="actionResultsModal" data-bs-theme="dark" tabindex="-1" aria-labelledby="actionResultsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: var(--noc-bg-secondary); border: 1px solid var(--noc-accent-cyan);">
            <div class="modal-header" style="border-bottom: 1px solid var(--noc-accent-cyan);">
                <h5 class="modal-title" id="actionResultsModalLabel">
                    <i class="bi bi-terminal me-2"></i>Action Results
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <strong>Action:</strong> <span id="results-action-type" class="text-info">--</span><br>
                    <strong>Device:</strong> <span id="results-device-name" class="text-warning">--</span><br>
                    <strong>Timestamp:</strong> <span id="results-timestamp" class="text-muted">--</span>
                </div>

                <div class="noc-panel">
                    <h6 class="text-uppercase mb-3" style="color: var(--noc-accent-green); letter-spacing: 1px;">
                        <i class="bi bi-code-square me-2"></i>Results
                    </h6>
                    <pre id="results-content" style="background: var(--noc-bg-primary); color: var(--noc-text-primary); padding: 15px; border-radius: 8px; border: 1px solid var(--noc-border); max-height: 400px; overflow-y: auto; font-size: 0.9rem;"></pre>
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid var(--noc-accent-cyan);">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-outline-info" id="copy-results-btn">
                    <i class="bi bi-clipboard me-1"></i>Copy Results
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Force clear any cached device data on page load -->
<script>
if (typeof(Storage) !== "undefined") {
    localStorage.removeItem('noc-device-cache');
    sessionStorage.clear();
}
</script>

<!-- Chart.js for real-time charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Socket.IO for real-time updates -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<script>
// NOC Dashboard JavaScript
let socket;
let deviceModal = null;
let actionResultsModal = null;
let currentDeviceId = null;
let nocData = {
    healthScore: 0,
    devicesOnline: 0,
    devicesOffline: 0,
    avgResponseTime: 0,
    activeAlerts: 0,
    devices: [],
    alerts: []
};

// Global cleanup tracking
window.nocTimers = {
    clockInterval: null,
    dataRefreshInterval: null,
    healthCheckInterval: null
};

// Request management for API call deduplication
window.nocRequests = {
    controllers: {},
    inProgress: new Set()
};

// Enhanced fetch with deduplication and cancellation
async function nocFetch(url, options = {}) {
    const requestKey = `${options.method || 'GET'}:${url}`;

    // Cancel existing request if in progress
    if (window.nocRequests.controllers[requestKey]) {
        window.nocRequests.controllers[requestKey].abort();
        window.nocRequests.inProgress.delete(requestKey);
    }

    // Skip if same request already in progress (unless forced)
    if (window.nocRequests.inProgress.has(requestKey) && !options.force) {
        return { deduped: true };
    }

    // Create new AbortController for this request
    const controller = new AbortController();
    window.nocRequests.controllers[requestKey] = controller;
    window.nocRequests.inProgress.add(requestKey);

    try {
        // Remove timeout from options since fetch doesn't support it
        const { timeout, ...fetchOptions } = options;

        const response = await fetch(url, {
            ...fetchOptions,
            signal: controller.signal
        });

        return response;
    } catch (error) {
        if (error.name === 'AbortError') {
            return { cancelled: true };
        }
        throw error;
    } finally {
        // Cleanup
        delete window.nocRequests.controllers[requestKey];
        window.nocRequests.inProgress.delete(requestKey);
    }
}

// Enhanced Loading State Management
window.nocLoading = {
    activeOperations: new Set(),
    globalIndicator: null
};

function showGlobalLoading(message = 'Loading...') {
    if (!window.nocLoading.globalIndicator) {
        const indicator = document.createElement('div');
        indicator.className = 'global-loading';
        indicator.innerHTML = `<span>${message}</span>`;
        document.body.appendChild(indicator);
        window.nocLoading.globalIndicator = indicator;
    } else {
        window.nocLoading.globalIndicator.querySelector('span').textContent = message;
    }
}

function hideGlobalLoading() {
    if (window.nocLoading.globalIndicator) {
        window.nocLoading.globalIndicator.remove();
        window.nocLoading.globalIndicator = null;
    }
}

function showButtonLoading(button, originalText) {
    if (button) {
        button.disabled = true;
        button.classList.add('btn-loading');
        button.dataset.originalText = originalText || button.textContent;
        button.textContent = '';
    }
}

function hideButtonLoading(button) {
    if (button) {
        button.disabled = false;
        button.classList.remove('btn-loading');
        if (button.dataset.originalText) {
            button.textContent = button.dataset.originalText;
            delete button.dataset.originalText;
        }
    }
}

function showModalLoading(modal, message = 'Loading device details...') {
    const modalBody = modal.querySelector('.modal-body');
    if (modalBody) {
        const existingOverlay = modalBody.querySelector('.modal-loading-overlay');
        if (!existingOverlay) {
            const overlay = document.createElement('div');
            overlay.className = 'modal-loading-overlay';
            overlay.innerHTML = `
                <div class="modal-loading-spinner"></div>
                <div class="modal-loading-text">${message}</div>
            `;
            modalBody.appendChild(overlay);
        }
    }
}

function hideModalLoading(modal) {
    const modalBody = modal.querySelector('.modal-body');
    if (modalBody) {
        const overlay = modalBody.querySelector('.modal-loading-overlay');
        if (overlay) {
            overlay.remove();
        }
    }
}

function addLoadingToElement(element, size = 'normal') {
    if (element && !element.classList.contains('loading-overlay')) {
        element.classList.add('loading-overlay');
        element.dataset.loadingSize = size;
    }
}

function removeLoadingFromElement(element) {
    if (element) {
        element.classList.remove('loading-overlay');
        delete element.dataset.loadingSize;
    }
}

// Enhanced Error Handling System
window.nocErrors = {
    retryAttempts: new Map(),
    maxRetries: 3,
    retryDelay: 2000
};

// Enhanced error classification and user-friendly messages
function getErrorContext(error, operation = 'operation') {
    const message = error.message || error.toString();

    // Network errors
    if (error.name === 'TypeError' && message.includes('fetch')) {
        return {
            type: 'network',
            title: 'Connection Error',
            message: `Unable to connect to the server. Please check your network connection.`,
            userFriendly: true,
            retryable: true,
            icon: ''
        };
    }

    // Timeout errors
    if (message.includes('timeout') || message.includes('Timeout')) {
        return {
            type: 'timeout',
            title: 'Request Timeout',
            message: `The ${operation} took too long to complete. The server might be busy.`,
            userFriendly: true,
            retryable: true,
            icon: ''
        };
    }

    // Server errors (5xx)
    if (message.includes('HTTP 5')) {
        return {
            type: 'server',
            title: 'Server Error',
            message: `The server encountered an error while processing your request.`,
            userFriendly: true,
            retryable: true,
            icon: ''
        };
    }

    // Client errors (4xx)
    if (message.includes('HTTP 4')) {
        return {
            type: 'client',
            title: 'Request Error',
            message: `The request couldn't be processed. Please try again.`,
            userFriendly: true,
            retryable: false,
            icon: ''
        };
    }

    // Permission/Auth errors
    if (message.includes('Unauthorized') || message.includes('Forbidden')) {
        return {
            type: 'auth',
            title: 'Access Denied',
            message: `You don't have permission to perform this action.`,
            userFriendly: true,
            retryable: false,
            icon: ''
        };
    }

    // Device-specific errors
    if (message.includes('device') || message.includes('Device')) {
        return {
            type: 'device',
            title: 'Device Error',
            message: `Unable to communicate with the device. It might be offline or unreachable.`,
            userFriendly: true,
            retryable: true,
            icon: ''
        };
    }

    // Generic fallback
    return {
        type: 'generic',
        title: 'Unexpected Error',
        message: `An unexpected error occurred: ${message}`,
        userFriendly: false,
        retryable: true,
        icon: ''
    };
}

// Enhanced error display with retry options
function showEnhancedError(error, operation = 'operation', context = {}) {
    const errorInfo = getErrorContext(error, operation);
    const canRetry = errorInfo.retryable && context.onRetry;

    const toastType = errorInfo.type === 'network' ? 'warning' : 'error';
    const retryText = canRetry ? ' Click to retry.' : '';

    showToast(`${errorInfo.icon} ${errorInfo.title}: ${errorInfo.message}${retryText}`, toastType);

    // Add retry click handler if applicable
    if (canRetry) {
        const toasts = document.querySelectorAll('.toast:last-child');
        if (toasts.length > 0) {
            const lastToast = toasts[toasts.length - 1];
            lastToast.style.cursor = 'pointer';
            lastToast.onclick = async () => {
                lastToast.onclick = null; // Prevent multiple clicks
                await attemptRetry(operation, context.onRetry, error);
            };
        }
    }

    return errorInfo;
}

// Retry mechanism with exponential backoff
async function attemptRetry(operation, retryFunction, originalError) {
    const retryKey = `${operation}-${Date.now()}`;
    const currentAttempts = window.nocErrors.retryAttempts.get(operation) || 0;

    if (currentAttempts >= window.nocErrors.maxRetries) {
        showToast(` Maximum retry attempts reached for ${operation}`, 'error');
        window.nocErrors.retryAttempts.delete(operation);
        return false;
    }

    const delay = window.nocErrors.retryDelay * Math.pow(2, currentAttempts);
    showToast(` Retrying ${operation} in ${delay/1000} seconds...`, 'info');

    setTimeout(async () => {
        try {
            window.nocErrors.retryAttempts.set(operation, currentAttempts + 1);
            await retryFunction();
            window.nocErrors.retryAttempts.delete(operation);
            showToast(` ${operation} succeeded after retry`, 'success');
        } catch (retryError) {
            showEnhancedError(retryError, operation, { onRetry: retryFunction });
        }
    }, delay);

    return true;
}

// Enhanced modal error display
function showEnhancedModalError(error, operation = 'operation') {
    const errorInfo = getErrorContext(error, operation);

    // Update modal title
    const modalTitle = document.querySelector('#nocDeviceModal .modal-title');
    if (modalTitle) {
        modalTitle.innerHTML = `${errorInfo.icon} ${errorInfo.title}`;
    }

    // Show error in modal body
    const modalBody = document.querySelector('#nocDeviceModal .modal-body');
    if (modalBody) {
        modalBody.innerHTML = `
            <div class="alert alert-danger d-flex align-items-center" role="alert">
                <div class="me-3" style="font-size: 2rem;">${errorInfo.icon}</div>
                <div>
                    <h6 class="alert-heading mb-1">${errorInfo.title}</h6>
                    <p class="mb-0">${errorInfo.message}</p>
                    ${errorInfo.retryable ?
                        '<small class="text-muted">You can close this dialog and try again.</small>' :
                        ''}
                </div>
            </div>
        `;
    }
}

// Network status error display
function showNetworkError(error) {
    const healthScore = getElement('healthScore');
    const networkStatus = getElement('networkStatus');

    if (healthScore) {
        healthScore.innerHTML = `<div class="text-danger"></div>`;
        healthScore.className = 'health-score-number health-score-poor';
        healthScore.title = 'Network monitoring unavailable';
    }

    if (networkStatus) {
        networkStatus.textContent = 'CONNECTION ERROR';
        networkStatus.className = 'status-indicator status-critical';
        networkStatus.title = error.message;
    }
}

// DOM Element Caching System for Performance Optimization
window.nocElements = {
    cache: {},
    selectors: {
        // Core UI elements
        healthScore: '#health-score',
        networkStatus: '#network-status .status-indicator',
        deviceGrid: '#device-grid',
        alertsFeed: '#alerts-feed',
        nocClock: '#noc-clock',

        // Modal elements
        nocDeviceModal: '#nocDeviceModal',
        actionResultsModal: '#actionResultsModal',

        // Search and filter elements
        deviceSearch: '#device-search',
        searchSort: '#search-sort',
        advancedSearchPanel: '#advanced-search-panel',

        // Control elements
        showCriticalOnly: '#show-critical-only',
        showAllDevices: '#show-all-devices',
        toggleSearch: '#toggle-search',

        // Statistics elements
        deviceCount: '#device-count',
        nocAvgResponseTime: '#noc-avg-response-time',
        nocLastUpdate: '#noc-last-update',
        criticalAlertCount: '#critical-alert-count',
        warningAlertCount: '#warning-alert-count'
    }
};

// Cached DOM element getter with automatic fallback
function getElement(key, forceRefresh = false) {
    // Return cached element if available and not forcing refresh
    if (!forceRefresh && window.nocElements.cache[key]) {
        // Verify element is still in DOM
        if (document.contains(window.nocElements.cache[key])) {
            return window.nocElements.cache[key];
        } else {
            // Element was removed from DOM, clear cache
            delete window.nocElements.cache[key];
        }
    }

    // Look up selector and find element
    const selector = window.nocElements.selectors[key];
    if (!selector) {
        console.warn(`DOM cache: Unknown element key '${key}'`);
        return null;
    }

    const element = document.querySelector(selector);
    if (element) {
        window.nocElements.cache[key] = element;
    }

    return element;
}

// Get multiple elements at once
function getElements(keys, forceRefresh = false) {
    const elements = {};
    keys.forEach(key => {
        elements[key] = getElement(key, forceRefresh);
    });
    return elements;
}

// Clear element cache (call after major DOM changes)
function clearElementCache() {
    window.nocElements.cache = {};
}

// Touch feedback system for mobile devices
window.nocTouch = {
    activeElements: new Set(),
    swipeIndicator: null
};

// Touch feedback functions
function addTouchFeedback(element) {
    if (element && !window.nocTouch.activeElements.has(element)) {
        element.style.transform = 'scale(0.95)';
        element.style.transition = 'transform 0.1s ease';
        window.nocTouch.activeElements.add(element);
    }
}

function clearTouchFeedback() {
    window.nocTouch.activeElements.forEach(element => {
        if (element) {
            element.style.transform = '';
            element.style.transition = '';
        }
    });
    window.nocTouch.activeElements.clear();
}

// Swipe indicator for mobile navigation
function showSwipeIndicator(direction) {
    if (!window.nocTouch.swipeIndicator) {
        const indicator = document.createElement('div');
        indicator.className = 'swipe-indicator';
        indicator.innerHTML = `<span>Swipe ${direction}</span>`;
        indicator.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 255, 255, 0.9);
            color: var(--noc-bg-primary);
            padding: 12px 20px;
            border-radius: 6px;
            z-index: 10000;
            font-weight: bold;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            pointer-events: none;
        `;
        document.body.appendChild(indicator);
        window.nocTouch.swipeIndicator = indicator;

        // Auto-hide after 2 seconds
        setTimeout(() => {
            hideSwipeIndicator();
        }, 2000);
    }
}

function hideSwipeIndicator() {
    if (window.nocTouch.swipeIndicator) {
        window.nocTouch.swipeIndicator.remove();
        window.nocTouch.swipeIndicator = null;
    }
}

// Enhanced touch feedback for different interaction types
function provideTouchFeedback(type) {
    // Haptic feedback
    if (navigator.vibrate) {
        const patterns = {
            tap: [10],
            longPress: [50, 50, 50],
            error: [100, 50, 100],
            success: [25, 25, 25]
        };
        navigator.vibrate(patterns[type] || patterns.tap);
    }

    // Audio feedback (optional, very subtle)
    if (window.nocAudioFeedback && window.nocAudioFeedback.enabled) {
        // Could add subtle audio cues here
    }
}

// Initialize NOC dashboard system
function initializeNOCSystem() {
    try {
        console.log('NOC: Initializing dashboard system...');

        // Initialize modals
        const modalElements = document.querySelectorAll('.modal');
        modalElements.forEach(modalEl => {
            if (modalEl.id === 'nocDeviceModal') {
                deviceModal = new bootstrap.Modal(modalEl);
            } else if (modalEl.id === 'actionResultsModal') {
                actionResultsModal = new bootstrap.Modal(modalEl);
            }
        });

        // Clear any existing timers
        Object.keys(window.nocTimers).forEach(timer => {
            if (window.nocTimers[timer]) {
                clearInterval(window.nocTimers[timer]);
                window.nocTimers[timer] = null;
            }
        });

        // Clear caches
        clearElementCache();

        // Clear touch feedback
        clearTouchFeedback();
        hideSwipeIndicator();

        console.log('NOC: System initialization completed successfully');
        return true;

    } catch (error) {
        console.error('NOC: Failed to initialize system:', error);
        return false;
    }
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('NOC: DOM loaded, starting initialization...');

    // Initialize system
    if (!initializeNOCSystem()) {
        console.error('NOC: System initialization failed, stopping startup sequence');
        return;
    }

    // Start the clock immediately
    updateClock();
    window.nocTimers.clockInterval = setInterval(updateClock, 1000);

    // Load initial data
    loadHealthOverview();
    loadDevices();
    loadAlerts();

    // Set up data refresh intervals
    window.nocTimers.dataRefreshInterval = setInterval(() => {
        loadHealthOverview();
        loadDevices();
        loadAlerts();
    }, 30000); // Refresh every 30 seconds

    // Health check interval (more frequent)
    window.nocTimers.healthCheckInterval = setInterval(loadHealthOverview, 10000); // Every 10 seconds

    // Initialize WebSocket connection
    initializeWebSocket();

    // Set up event listeners
    setupEventListeners();

    console.log('NOC: Dashboard fully initialized and running');
});

// Update clock display
function updateClock() {
    try {
        const now = new Date();
        const timeString = now.toLocaleTimeString('en-US', {
            hour12: false,
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        const dateString = now.toLocaleDateString('en-US', {
            weekday: 'short',
            month: 'short',
            day: 'numeric',
            year: 'numeric'
        });

        const clockElement = getElement('nocClock');
        if (!clockElement) {
            return;
        }

        clockElement.innerHTML = `
            ${timeString}
            <small class="noc-date">${dateString}</small>
        `;
    } catch (error) {
        console.error('NOC: Error updating clock:', error);
    }
}

// Load health overview data
async function loadHealthOverview() {
    try {
        const response = await nocFetch('/api/health/overview');
        if (response.deduped || response.cancelled) return;

        const data = await response.json();
        updateHealthDisplay(data);
        updateNetworkSummary(data);
        updateNetworkStatus(data);

    } catch (error) {
        console.error('NOC: Error loading health overview:', error);
        showNetworkError(error);
    }
}

// Update health score display
function updateHealthDisplay(data) {
    try {
        const score = data.health_score || 0;
        const scoreElement = getElement('healthScore');

        if (!scoreElement) {
            console.warn('NOC: Health score element not found');
            return;
        }

        // Update score number
        scoreElement.textContent = Math.round(score);

        // Update score color based on value
        scoreElement.className = 'health-score-number-enhanced';
        if (score >= 90) {
            scoreElement.classList.add('health-score-excellent');
        } else if (score >= 75) {
            scoreElement.classList.add('health-score-good');
        } else if (score >= 50) {
            scoreElement.classList.add('health-score-fair');
        } else {
            scoreElement.classList.add('health-score-poor');
        }

        // Update health summary text
        const summaryElement = document.getElementById('health-summary');
        if (summaryElement) {
            let summaryText = 'Network operational status';
            if (data.devices) {
                try {
                    const devicesTotal = data.devices.length || 0;
                    const devicesOnline = data.devices.filter(d => d.status === 'online').length || 0;
                    summaryText = `${devicesOnline}/${devicesTotal} devices online`;
                } catch (deviceCountError) {
                    console.error('NOC: Error calculating device counts:', deviceCountError);
                    // Use fallback values
                    devicesTotal = 0;
                    devicesOnline = 0;
                    summaryText = 'Device status unavailable';
                }
            }
            summaryElement.textContent = summaryText;
        }

        // Update trend indicator
        updateHealthTrend(score);

        // Update accessibility description
        const descElement = document.getElementById('health-score-description');
        if (descElement) {
            let status = 'unknown';
            if (score >= 90) status = 'excellent';
            else if (score >= 75) status = 'good';
            else if (score >= 50) status = 'fair';
            else status = 'poor';

            descElement.textContent = `Network health score is ${score} out of 100, indicating ${status} performance`;
        }

    } catch (error) {
        console.error('NOC: Error updating health display:', error);
        console.error('NOC: Error data:', data);
        console.error('NOC: Error stack:', error.stack);

        // Fallback: At least show the score even if other updates fail
        const scoreElement = document.getElementById('health-score');
        if (scoreElement && typeof score === 'number') {
            scoreElement.textContent = Math.round(score);
        }
    }
}

// Update health trend indicator
function updateHealthTrend(currentScore) {
    const trendArrow = document.getElementById('trend-arrow');
    if (!trendArrow) return;

    // Add current score to history
    if (!window.nocData.healthHistory) {
        window.nocData.healthHistory = [];
    }

    window.nocData.healthHistory.push(currentScore);

    // Keep only last 10 readings
    if (window.nocData.healthHistory.length > 10) {
        window.nocData.healthHistory.shift();
    }

    // Calculate trend if we have enough data
    if (window.nocData.healthHistory.length >= 3) {
        const recent = window.nocData.healthHistory.slice(-3);
        const avg = recent.reduce((a, b) => a + b, 0) / recent.length;
        const previousAvg = window.nocData.healthHistory.slice(-6, -3);

        if (previousAvg.length >= 3) {
            const prevAvg = previousAvg.reduce((a, b) => a + b, 0) / previousAvg.length;
            const trendDiff = avg - prevAvg;

            if (Math.abs(trendDiff) > 2) { // Only show trend if significant
                trendArrow.style.display = 'block';
                if (trendDiff > 0) {
                    trendArrow.className = 'bi bi-arrow-up text-success trend-arrow';
                    trendArrow.title = 'Health score trending up';
                } else {
                    trendArrow.className = 'bi bi-arrow-down text-danger trend-arrow';
                    trendArrow.title = 'Health score trending down';
                }
            } else {
                trendArrow.style.display = 'none';
            }
        }
    }
}

// Update network summary
function updateNetworkSummary(data) {
    try {
        const avgResponseElement = getElement('nocAvgResponseTime');
        const lastUpdateElement = getElement('nocLastUpdate');

        if (avgResponseElement) {
            const avgResponse = data.average_response_time || 0;
            avgResponseElement.textContent = avgResponse > 0 ? `${avgResponse.toFixed(1)}ms` : '--';
        }

        if (lastUpdateElement) {
            const lastUpdate = data.last_update ? new Date(data.last_update) : new Date();
            const timeAgo = getTimeAgo(lastUpdate);
            lastUpdateElement.textContent = timeAgo;
        }

    } catch (error) {
        console.error('NOC: Error updating network summary:', error);
    }
}

// Update network status indicator
function updateNetworkStatus(data) {
    try {
        const networkStatusElement = getElement('networkStatus');
        if (!networkStatusElement) return;

        const score = data.health_score || 0;
        let status = 'UNKNOWN';
        let statusClass = 'status-critical';

        if (score >= 90) {
            status = 'OPTIMAL';
            statusClass = 'status-online';
        } else if (score >= 75) {
            status = 'NORMAL';
            statusClass = 'status-online';
        } else if (score >= 50) {
            status = 'DEGRADED';
            statusClass = 'status-degraded';
        } else {
            status = 'CRITICAL';
            statusClass = 'status-critical';
        }

        networkStatusElement.textContent = status;
        networkStatusElement.className = `status-indicator ${statusClass}`;

        // Update accessibility description
        const descElement = document.getElementById('network-status-description');
        if (descElement) {
            descElement.textContent = `Network status is ${status.toLowerCase()}`;
        }

    } catch (error) {
        console.error('NOC: Error updating network status:', error);
    }
}

// Load devices data
async function loadDevices() {
    try {
        const response = await nocFetch('/api/devices/status');
        if (response.deduped || response.cancelled) return;

        const devices = await response.json();
        updateDeviceGrid(devices);
        updateDeviceCount(devices);
        updateNetworkMap(devices);

    } catch (error) {
        console.error('NOC: Error loading devices:', error);
        showEnhancedError(error, 'device loading', {
            onRetry: loadDevices
        });
    }
}

// Update device grid
function updateDeviceGrid(devices) {
    try {
        const deviceGrid = getElement('deviceGrid');
        if (!deviceGrid) {
            console.error('NOC: Critical element deviceGrid not found in DOM!');
            showSystemError('Device grid element not found. Page may not be fully loaded.');
            return false;
        }

        const showCriticalOnly = getElement('showCriticalOnly');
        const showAllDevices = getElement('showAllDevices');

        let filteredDevices = devices;

        // Apply filters
        if (showCriticalOnly && showCriticalOnly.checked) {
            filteredDevices = devices.filter(device =>
                device.status !== 'online' || device.alerts_count > 0
            );
        }

        if (!showAllDevices || !showAllDevices.checked) {
            filteredDevices = filteredDevices.slice(0, 20); // Limit to 20 for NOC view
        }

        // Clear existing content
        deviceGrid.innerHTML = '';

        if (filteredDevices.length === 0) {
            deviceGrid.innerHTML = `
                <div class="col-12">
                    <div class="text-center py-4 text-muted">
                        <i class="bi bi-search mb-2" style="font-size: 2rem;"></i>
                        <p>No devices found matching current filters</p>
                    </div>
                </div>
            `;
            return;
        }

        // Create device tiles
        filteredDevices.forEach(device => {
            const deviceTile = createDeviceTile(device);
            deviceGrid.appendChild(deviceTile);
        });

        // Update show more button
        const showMoreContainer = document.getElementById('show-more-container');
        if (showMoreContainer) {
            if (devices.length > filteredDevices.length) {
                showMoreContainer.style.display = 'block';
            } else {
                showMoreContainer.style.display = 'none';
            }
        }

    } catch (error) {
        console.error('NOC: Error updating device grid:', error);
        const deviceGrid = getElement('deviceGrid');
        if (deviceGrid) {
            deviceGrid.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-danger" role="alert">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Error loading device data. Please refresh the page.
                    </div>
                </div>
            `;
        }
    }
}

// Create individual device tile
function createDeviceTile(device) {
    const col = document.createElement('div');
    col.className = 'col-lg-6 col-xl-4 mb-3';

    const statusClass = device.status === 'online' ? 'device-online' :
                       device.status === 'offline' ? 'device-offline' : 'device-warning';

    const priorityClass = device.alerts_count > 0 ? 'critical' :
                         device.status === 'online' ? 'normal' : 'monitoring';

    const responseTime = device.avg_response_time > 0 ?
                        `${device.avg_response_time.toFixed(1)}ms` : '--';

    const deviceType = device.device_type || 'unknown';
    const deviceIcon = getDeviceIcon(deviceType);

    col.innerHTML = `
        <div class="device-tile ${statusClass}"
             data-device-id="${device.id}"
             onclick="showDeviceModal(${device.id})"
             role="button"
             tabindex="0"
             aria-label="Device ${device.name || device.ip}, status ${device.status}">

            <div class="device-priority-indicator ${priorityClass}"
                 aria-label="Priority: ${priorityClass}"></div>

            <div class="d-flex align-items-start">
                <div class="me-2">
                    <i class="bi ${deviceIcon} text-info" style="font-size: 1.2rem;"></i>
                </div>
                <div class="flex-grow-1">
                    <div class="device-name">${device.name || device.ip}</div>
                    <div class="device-ip">${device.ip}</div>
                    <div class="device-status text-${device.status === 'online' ? 'success' : 'danger'}">
                        ${device.status.toUpperCase()}
                    </div>
                    <div class="device-response-time">
                        Response: ${responseTime}
                    </div>

                    ${device.alerts_count > 0 ? `
                        <div class="mt-2">
                            <span class="noc-badge">${device.alerts_count} alert${device.alerts_count !== 1 ? 's' : ''}</span>
                        </div>
                    ` : ''}
                </div>
            </div>

            <div class="quick-actions mt-2">
                <a href="/device/${device.id}" class="quick-action-btn" onclick="event.stopPropagation();">
                    <i class="bi bi-info-circle"></i> Details
                </a>
                ${device.status === 'offline' ? `
                    <button class="quick-action-btn" onclick="event.stopPropagation(); pingDevice(${device.id});">
                        <i class="bi bi-wifi"></i> Ping
                    </button>
                ` : ''}
            </div>
        </div>
    `;

    return col;
}

// Get device icon based on type
function getDeviceIcon(deviceType) {
    const icons = {
        'router': 'bi-router',
        'switch': 'bi-diagram-3',
        'computer': 'bi-pc-display',
        'laptop': 'bi-laptop',
        'phone': 'bi-phone',
        'tablet': 'bi-tablet',
        'server': 'bi-server',
        'printer': 'bi-printer',
        'camera': 'bi-camera-video',
        'smart_tv': 'bi-tv',
        'game_console': 'bi-controller',
        'iot': 'bi-cpu',
        'unknown': 'bi-question-circle'
    };

    return icons[deviceType] || icons.unknown;
}

// Update device count
function updateDeviceCount(devices) {
    try {
        const deviceCountElement = getElement('deviceCount');
        if (deviceCountElement) {
            const onlineCount = devices.filter(d => d.status === 'online').length;
            deviceCountElement.textContent = `${onlineCount}/${devices.length}`;
            deviceCountElement.className = onlineCount === devices.length ?
                'badge bg-success ms-2' : 'badge bg-warning ms-2';
        }
    } catch (error) {
        console.error('NOC: Error updating device count:', error);
    }
}

// Update network map
function updateNetworkMap(devices) {
    try {
        const networkMap = document.getElementById('network-map');
        if (!networkMap) return;

        // Clear existing nodes
        networkMap.innerHTML = '';

        if (devices.length === 0) {
            networkMap.innerHTML = '<div class="text-center text-muted">No devices to display</div>';
            return;
        }

        // Create a simple grid layout for devices
        const maxNodes = 20; // Limit for performance
        const displayDevices = devices.slice(0, maxNodes);

        displayDevices.forEach((device, index) => {
            const node = document.createElement('div');
            node.className = `map-node ${device.status}`;

            // Position nodes in a grid pattern
            const cols = Math.ceil(Math.sqrt(displayDevices.length));
            const row = Math.floor(index / cols);
            const col = index % cols;

            const x = (col + 1) * (100 / (cols + 1));
            const y = (row + 1) * (100 / (Math.ceil(displayDevices.length / cols) + 1));

            node.style.left = `${x}%`;
            node.style.top = `${y}%`;
            node.title = `${device.name || device.ip} (${device.status})`;

            node.onclick = () => showDeviceModal(device.id);

            networkMap.appendChild(node);
        });

        if (devices.length > maxNodes) {
            const moreIndicator = document.createElement('div');
            moreIndicator.className = 'text-center text-muted mt-2';
            moreIndicator.style.position = 'absolute';
            moreIndicator.style.bottom = '10px';
            moreIndicator.style.left = '50%';
            moreIndicator.style.transform = 'translateX(-50%)';
            moreIndicator.innerHTML = `<small>+${devices.length - maxNodes} more devices</small>`;
            networkMap.appendChild(moreIndicator);
        }

    } catch (error) {
        console.error('NOC: Error updating network map:', error);
    }
}

// Load alerts data
async function loadAlerts() {
    try {
        const response = await nocFetch('/api/alerts/active');
        if (response.deduped || response.cancelled) return;

        const alerts = await response.json();
        updateAlertsDisplay(alerts);
        updateAlertCounts(alerts);
        updateCriticalBanner(alerts);

    } catch (error) {
        console.error('NOC: Error loading alerts:', error);
        showEnhancedError(error, 'alert loading', {
            onRetry: loadAlerts
        });
    }
}

// Update alerts display
function updateAlertsDisplay(alerts) {
    try {
        const alertsFeed = getElement('alertsFeed');
        if (!alertsFeed) return;

        alertsFeed.innerHTML = '';

        if (alerts.length === 0) {
            alertsFeed.innerHTML = `
                <div class="text-center text-muted py-3">
                    <i class="bi bi-check-circle mb-2" style="font-size: 2rem; color: var(--noc-accent-green);"></i>
                    <p class="mb-0">No active alerts</p>
                </div>
            `;
            return;
        }

        // Group alerts by severity
        const groupedAlerts = {
            critical: alerts.filter(a => a.severity === 'critical'),
            warning: alerts.filter(a => a.severity === 'warning'),
            info: alerts.filter(a => a.severity === 'info')
        };

        // Display each group
        Object.entries(groupedAlerts).forEach(([severity, severityAlerts]) => {
            if (severityAlerts.length === 0) return;

            // Add severity header
            const header = document.createElement('div');
            header.className = `alert-severity-header ${severity}`;
            header.innerHTML = `
                <span>${severity.toUpperCase()}</span>
                <span class="badge">${severityAlerts.length}</span>
            `;
            alertsFeed.appendChild(header);

            // Add alerts for this severity
            severityAlerts.slice(0, 10).forEach(alert => { // Limit to 10 per severity
                const alertElement = createAlertElement(alert);
                alertsFeed.appendChild(alertElement);
            });
        });

    } catch (error) {
        console.error('NOC: Error updating alerts display:', error);
    }
}

// Create individual alert element
function createAlertElement(alert) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert-item alert-${alert.severity}`;
    alertDiv.dataset.alertId = alert.id;

    const timeAgo = getTimeAgo(new Date(alert.created_at));

    alertDiv.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
                <strong>${alert.device_name || 'System'}</strong>
                <br>
                <span class="alert-message">${alert.message}</span>
            </div>
            <div class="alert-timestamp">${timeAgo}</div>
        </div>
        ${alert.acknowledged ? '<div class="text-muted small mt-1">Acknowledged</div>' : ''}
    `;

    // Add click handler for acknowledgment
    if (!alert.acknowledged) {
        alertDiv.onclick = () => acknowledgeAlert(alert.id);
        alertDiv.style.cursor = 'pointer';
        alertDiv.title = 'Click to acknowledge';
    }

    return alertDiv;
}

// Update alert counts
function updateAlertCounts(alerts) {
    try {
        const criticalCount = alerts.filter(a => a.severity === 'critical').length;
        const warningCount = alerts.filter(a => a.severity === 'warning').length;

        const criticalBadge = getElement('criticalAlertCount');
        const warningBadge = getElement('warningAlertCount');

        if (criticalBadge) {
            if (criticalCount > 0) {
                criticalBadge.textContent = criticalCount;
                criticalBadge.style.display = 'inline';
            } else {
                criticalBadge.style.display = 'none';
            }
        }

        if (warningBadge) {
            if (warningCount > 0) {
                warningBadge.textContent = warningCount;
                warningBadge.style.display = 'inline';
            } else {
                warningBadge.style.display = 'none';
            }
        }

    } catch (error) {
        console.error('NOC: Error updating alert counts:', error);
    }
}

// Update critical alert banner
function updateCriticalBanner(alerts) {
    try {
        const criticalAlerts = alerts.filter(a => a.severity === 'critical');
        const banner = document.getElementById('critical-alert-banner');

        if (!banner) return;

        if (criticalAlerts.length > 0) {
            const alertText = document.getElementById('critical-alert-text');
            if (alertText) {
                if (criticalAlerts.length === 1) {
                    alertText.textContent = criticalAlerts[0].message;
                } else {
                    alertText.textContent = `${criticalAlerts.length} critical issues detected`;
                }
            }
            banner.style.display = 'block';
        } else {
            banner.style.display = 'none';
        }

    } catch (error) {
        console.error('NOC: Error updating critical banner:', error);
    }
}

// Show device modal
async function showDeviceModal(deviceId) {
    if (!deviceModal) return;

    currentDeviceId = deviceId;

    try {
        showModalLoading(deviceModal._element);
        deviceModal.show();

        const response = await nocFetch(`/api/devices/${deviceId}`);
        if (response.deduped || response.cancelled) return;

        const device = await response.json();
        updateDeviceModal(device);

    } catch (error) {
        console.error('NOC: Error loading device details:', error);
        showEnhancedModalError(error, 'device detail loading');
    } finally {
        hideModalLoading(deviceModal._element);
    }
}

// Update device modal with data
function updateDeviceModal(device) {
    try {
        // Update modal title
        const modalTitle = document.getElementById('nocDeviceModalLabel');
        if (modalTitle) {
            modalTitle.innerHTML = `
                <i class="bi bi-hdd-network me-2"></i>
                ${device.name || device.ip}
            `;
        }

        // Update device information
        const updates = {
            'modal-device-name': device.name || device.ip,
            'modal-device-ip': device.ip,
            'modal-device-mac': device.mac_address || '--',
            'modal-device-vendor': device.vendor || '--',
            'modal-device-type': device.device_type || '--'
        };

        Object.entries(updates).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (element) element.textContent = value;
        });

        // Update status badge
        const statusElement = document.getElementById('modal-device-status');
        if (statusElement) {
            statusElement.textContent = device.status.toUpperCase();
            statusElement.className = `badge bg-${device.status === 'online' ? 'success' : 'danger'}`;
        }

        // Update monitoring toggle
        const monitoringToggle = document.getElementById('modal-monitoring-toggle');
        if (monitoringToggle) {
            monitoringToggle.checked = device.monitoring_enabled;
        }

        // Update performance metrics
        const perfUpdates = {
            'modal-response-time': device.avg_response_time > 0 ? `${device.avg_response_time.toFixed(1)}ms` : '--',
            'modal-uptime': device.uptime_percentage ? `${device.uptime_percentage.toFixed(1)}%` : '--',
            'modal-last-seen': device.last_seen ? getTimeAgo(new Date(device.last_seen)) : '--',
            'modal-alerts-count': device.alerts_count || '0'
        };

        Object.entries(perfUpdates).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (element) element.textContent = value;
        });

    } catch (error) {
        console.error('NOC: Error updating device modal:', error);
    }
}

// Initialize WebSocket connection
function initializeWebSocket() {
    try {
        socket = io();

        socket.on('connect', () => {
            console.log('NOC: WebSocket connected');
            showToast(' Real-time connection established', 'success');
        });

        socket.on('disconnect', () => {
            console.log('NOC: WebSocket disconnected');
            showToast(' Real-time connection lost', 'warning');
        });

        socket.on('device_status_update', (data) => {
            updateDeviceInGrid(data);
        });

        socket.on('alert_update', (data) => {
            if (data.type === 'new_alert') {
                showToast(` ${data.alert.severity.toUpperCase()}: ${data.alert.message}`, 'error');
                loadAlerts(); // Refresh alerts display
            }
        });

        socket.on('health_update', (data) => {
            updateHealthDisplay(data);
        });

    } catch (error) {
        console.error('NOC: Error initializing WebSocket:', error);
    }
}

// Update single device in grid
function updateDeviceInGrid(deviceData) {
    try {
        const deviceTile = document.querySelector(`[data-device-id="${deviceData.id}"]`);
        if (!deviceTile) return;

        // Update status class
        deviceTile.className = deviceTile.className.replace(
            /device-(online|offline|warning)/g,
            `device-${deviceData.status}`
        );

        // Update status text
        const statusElement = deviceTile.querySelector('.device-status');
        if (statusElement) {
            statusElement.textContent = deviceData.status.toUpperCase();
            statusElement.className = `device-status text-${deviceData.status === 'online' ? 'success' : 'danger'}`;
        }

        // Update response time
        const responseElement = deviceTile.querySelector('.device-response-time');
        if (responseElement && deviceData.response_time) {
            responseElement.textContent = `Response: ${deviceData.response_time.toFixed(1)}ms`;
        }

    } catch (error) {
        console.error('NOC: Error updating device in grid:', error);
    }
}

// Setup event listeners
function setupEventListeners() {
    try {
        // Search toggle
        const toggleSearch = getElement('toggleSearch');
        if (toggleSearch) {
            toggleSearch.addEventListener('click', () => {
                const searchPanel = getElement('advancedSearchPanel');
                if (searchPanel) {
                    const isVisible = searchPanel.style.display !== 'none';
                    searchPanel.style.display = isVisible ? 'none' : 'block';
                    toggleSearch.classList.toggle('active', !isVisible);
                }
            });
        }

        // Device search
        const deviceSearch = getElement('deviceSearch');
        if (deviceSearch) {
            deviceSearch.addEventListener('input', debounce(handleDeviceSearch, 300));
        }

        // Filter toggles
        const showCriticalOnly = getElement('showCriticalOnly');
        const showAllDevices = getElement('showAllDevices');

        if (showCriticalOnly) {
            showCriticalOnly.addEventListener('change', () => {
                if (showAllDevices) showAllDevices.checked = false;
                loadDevices();
            });
        }

        if (showAllDevices) {
            showAllDevices.addEventListener('change', () => {
                if (showCriticalOnly) showCriticalOnly.checked = false;
                loadDevices();
            });
        }

        // Full screen button
        const fullscreenBtn = document.querySelector('.fullscreen-btn');
        if (fullscreenBtn) {
            fullscreenBtn.addEventListener('click', toggleFullscreen);
        }

        // Modal action buttons
        setupModalActionListeners();

        // Keyboard shortcuts
        document.addEventListener('keydown', handleKeyboardShortcuts);

        // Touch events for mobile
        setupTouchEventListeners();

    } catch (error) {
        console.error('NOC: Error setting up event listeners:', error);
    }
}

// Setup modal action listeners
function setupModalActionListeners() {
    const modalPingBtn = document.getElementById('modal-ping-btn');
    const modalWakeBtn = document.getElementById('modal-wake-btn');
    const modalScanBtn = document.getElementById('modal-scan-btn');
    const modalViewDetailsBtn = document.getElementById('modal-view-details-btn');

    if (modalPingBtn) {
        modalPingBtn.addEventListener('click', () => {
            if (currentDeviceId) pingDevice(currentDeviceId);
        });
    }

    if (modalWakeBtn) {
        modalWakeBtn.addEventListener('click', () => {
            if (currentDeviceId) wakeDevice(currentDeviceId);
        });
    }

    if (modalScanBtn) {
        modalScanBtn.addEventListener('click', () => {
            if (currentDeviceId) scanDevice(currentDeviceId);
        });
    }

    if (modalViewDetailsBtn) {
        modalViewDetailsBtn.addEventListener('click', () => {
            if (currentDeviceId) {
                window.open(`/device/${currentDeviceId}`, '_blank');
            }
        });
    }
}

// Setup touch event listeners for mobile
function setupTouchEventListeners() {
    // Add touch feedback to device tiles
    document.addEventListener('touchstart', (e) => {
        const deviceTile = e.target.closest('.device-tile');
        if (deviceTile) {
            addTouchFeedback(deviceTile);
        }
    });

    document.addEventListener('touchend', () => {
        clearTouchFeedback();
    });

    // Swipe gestures for navigation
    let touchStartX = 0;
    let touchStartY = 0;

    document.addEventListener('touchstart', (e) => {
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
    });

    document.addEventListener('touchmove', (e) => {
        if (!touchStartX || !touchStartY) return;

        const touchEndX = e.touches[0].clientX;
        const touchEndY = e.touches[0].clientY;

        const diffX = touchStartX - touchEndX;
        const diffY = touchStartY - touchEndY;

        // Only handle horizontal swipes
        if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
            if (diffX > 0) {
                // Swipe left - could trigger filter change
                showSwipeIndicator('left for filters');
            } else {
                // Swipe right - could trigger menu
                showSwipeIndicator('right for menu');
            }
        }
    });
}

// Handle device search
function handleDeviceSearch() {
    const searchTerm = getElement('deviceSearch')?.value?.toLowerCase();
    if (!searchTerm) {
        loadDevices();
        return;
    }

    // Filter devices based on search term
    // This would normally filter the device grid
    console.log('NOC: Searching for:', searchTerm);
}

// Handle keyboard shortcuts
function handleKeyboardShortcuts(e) {
    switch(e.key) {
        case 'F11':
            e.preventDefault();
            toggleFullscreen();
            break;
        case 'Escape':
            if (deviceModal && deviceModal._isShown) {
                deviceModal.hide();
            }
            break;
        case '?':
            if (e.shiftKey) {
                showKeyboardShortcuts();
            }
            break;
    }
}

// Device action functions
async function pingDevice(deviceId) {
    try {
        showToast(' Pinging device...', 'info');
        const response = await nocFetch(`/api/devices/${deviceId}/ping`, { method: 'POST' });
        const result = await response.json();

        if (result.success) {
            showToast(` Ping successful: ${result.response_time}ms`, 'success');
        } else {
            showToast(` Ping failed: ${result.error}`, 'error');
        }

    } catch (error) {
        showEnhancedError(error, 'device ping');
    }
}

async function wakeDevice(deviceId) {
    try {
        showToast(' Sending Wake-on-LAN packet...', 'info');
        const response = await nocFetch(`/api/devices/${deviceId}/wake`, { method: 'POST' });
        const result = await response.json();

        if (result.success) {
            showToast(' Wake packet sent successfully', 'success');
        } else {
            showToast(` Wake failed: ${result.error}`, 'error');
        }

    } catch (error) {
        showEnhancedError(error, 'device wake');
    }
}

async function scanDevice(deviceId) {
    try {
        showToast(' Starting port scan...', 'info');
        const response = await nocFetch(`/api/devices/${deviceId}/scan`, { method: 'POST' });
        const result = await response.json();

        if (result.success) {
            showActionResults('Port Scan', result);
        } else {
            showToast(` Scan failed: ${result.error}`, 'error');
        }

    } catch (error) {
        showEnhancedError(error, 'device scan');
    }
}

// Show action results in modal
function showActionResults(actionType, result) {
    if (!actionResultsModal) return;

    document.getElementById('results-action-type').textContent = actionType;
    document.getElementById('results-device-name').textContent = result.device_name || 'Unknown';
    document.getElementById('results-timestamp').textContent = new Date().toLocaleString();
    document.getElementById('results-content').textContent = result.output || 'No output available';

    actionResultsModal.show();
}

// Acknowledge alert
async function acknowledgeAlert(alertId) {
    try {
        const response = await nocFetch(`/api/alerts/${alertId}/acknowledge`, { method: 'POST' });
        if (response.ok) {
            showToast(' Alert acknowledged', 'success');
            loadAlerts(); // Refresh alerts
        }
    } catch (error) {
        showEnhancedError(error, 'alert acknowledgment');
    }
}

// Toggle fullscreen mode
function toggleFullscreen() {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
            console.error('NOC: Error attempting to enable fullscreen:', err);
        });
    } else {
        document.exitFullscreen();
    }
}

// Utility functions
function getTimeAgo(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMins / 60);
    const diffDays = Math.floor(diffHours / 24);

    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    return `${diffDays}d ago`;
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `noc-toast toast-${type}`;
    toast.textContent = message;

    document.body.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, 5000);
}

function showSystemError(message) {
    showToast(` System Error: ${message}`, 'error');
}

// Cleanup function for page unload
window.addEventListener('beforeunload', () => {
    // Clear timers
    Object.keys(window.nocTimers).forEach(timer => {
        if (window.nocTimers[timer]) {
            clearInterval(window.nocTimers[timer]);
        }
    });

    // Disconnect WebSocket
    if (socket) {
        socket.disconnect();
    }

    // Cancel pending requests
    Object.values(window.nocRequests.controllers).forEach(controller => {
        controller.abort();
    });
});

// Handle visibility change (tab switching)
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        // Page is hidden, reduce update frequency
        if (window.nocTimers.dataRefreshInterval) {
            clearInterval(window.nocTimers.dataRefreshInterval);
            window.nocTimers.dataRefreshInterval = setInterval(() => {
                loadHealthOverview();
                loadDevices();
                loadAlerts();
            }, 60000); // Slower refresh when hidden
        }
    } else {
        // Page is visible, restore normal frequency
        if (window.nocTimers.dataRefreshInterval) {
            clearInterval(window.nocTimers.dataRefreshInterval);
            window.nocTimers.dataRefreshInterval = setInterval(() => {
                loadHealthOverview();
                loadDevices();
                loadAlerts();
            }, 30000); // Normal refresh rate
        }

        // Immediate refresh when page becomes visible
        loadHealthOverview();
        loadDevices();
        loadAlerts();
    }
});

// Performance monitoring
if (window.performance && window.performance.mark) {
    window.performance.mark('noc-script-end');
    console.log('NOC: Script initialization completed');
}

// Keyboard shortcuts help
document.addEventListener('keydown', (e) => {
    if (e.key === '?' && e.shiftKey) {
        showKeyboardShortcuts();
    }
});

function showKeyboardShortcuts() {
    alert('Keyboard Shortcuts:\n\nArrow Keys - Navigate devices\nEnter/Space - Open device details\nF11 - Toggle fullscreen\nESC - Close modals');
}
</script>
{% endblock %}