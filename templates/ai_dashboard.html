{% extends "base_beautiful.html" %}

{% block title %}AI Dashboard - HomeNetMon{% endblock %}

{% block extra_css %}
<style>
/* AI Dashboard specific styling */
.ai-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 1rem;
}

.ai-stat-card {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 0.75rem;
    backdrop-filter: blur(20px);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.ai-stat-card:hover {
    transform: translateY(-2px);
    border-color: rgba(255, 255, 255, 0.2);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.ai-stat-card.primary {
    border-left: 4px solid rgba(59, 130, 246, 0.8);
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(255, 255, 255, 0.03) 100%);
}

.ai-stat-card.warning {
    border-left: 4px solid rgba(245, 158, 11, 0.8);
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(255, 255, 255, 0.03) 100%);
}

.ai-stat-card.info {
    border-left: 4px solid rgba(14, 165, 233, 0.8);
    background: linear-gradient(135deg, rgba(14, 165, 233, 0.1) 0%, rgba(255, 255, 255, 0.03) 100%);
}

.ai-stat-card.success {
    border-left: 4px solid rgba(34, 197, 94, 0.8);
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(255, 255, 255, 0.03) 100%);
}

.stat-icon {
    position: absolute;
    top: 1rem;
    right: 1rem;
    font-size: 2rem;
    opacity: 0.3;
}

.stat-label {
    font-size: 0.875rem;
    opacity: 0.7;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.stat-value {
    font-size: 2rem;
    font-weight: 300;
    color: #ffffff;
    margin-bottom: 0.25rem;
}

.detection-progress {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(14, 165, 233, 0.3);
    border-radius: 16px;
    padding: 0.75rem;
    backdrop-filter: blur(20px);
    margin-bottom: 1rem;
}

.progress-modern {
    height: 8px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    overflow: hidden;
}

.progress-bar-modern {
    height: 100%;
    background: linear-gradient(90deg, rgba(14, 165, 233, 0.8) 0%, rgba(59, 130, 246, 0.8) 100%);
    border-radius: 4px;
    transition: width 0.3s ease;
    position: relative;
}

.progress-bar-modern::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    animation: shimmer 2s infinite;
}

@keyframes shimmer {
    0% { left: -100%; }
    100% { left: 100%; }
}

.ai-controls {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    margin-bottom: 1rem;
}

.anomaly-list {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    backdrop-filter: blur(20px);
}

.anomaly-item {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    transition: background 0.3s ease;
}

.anomaly-item:hover {
    background: rgba(255, 255, 255, 0.05);
}

.anomaly-item:last-child {
    border-bottom: none;
}

.anomaly-severity {
    padding: 0.25rem 0.75rem;
    border-radius: 8px;
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
}

.severity-high {
    background: rgba(239, 68, 68, 0.2);
    color: #fca5a5;
    border: 1px solid rgba(239, 68, 68, 0.3);
}

.severity-medium {
    background: rgba(245, 158, 11, 0.2);
    color: #fcd34d;
    border: 1px solid rgba(245, 158, 11, 0.3);
}

.severity-low {
    background: rgba(34, 197, 94, 0.2);
    color: #86efac;
    border: 1px solid rgba(34, 197, 94, 0.3);
}

.ai-model-status {
    background: rgba(14, 165, 233, 0.1);
    border: 1px solid rgba(14, 165, 233, 0.3);
    border-radius: 12px;
    padding: 1rem 1.5rem;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.chart-container {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 1rem;
    backdrop-filter: blur(20px);
    margin-bottom: 0.75rem;
}

.mobile-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
}

@media (min-width: 992px) {
    .mobile-stats {
        display: none;
    }
}

@media (max-width: 991px) {
    .ai-stats-grid {
        display: none;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">AI Dashboard</h1>
    <p class="page-subtitle">Intelligent anomaly detection and network analysis</p>
    <div class="page-version">ML Engine v1.2</div>
</div>

<!-- AI Controls -->
<div class="ai-controls">
    <button class="btn-modern btn-primary" id="refresh-ai-data">
        <i class="bi bi-arrow-clockwise"></i> Refresh Data
    </button>
    <button class="btn-modern btn-success" id="run-detection">
        <i class="bi bi-play-circle"></i> Run Detection
    </button>
    <button class="btn-modern btn-secondary" id="view-models">
        <i class="bi bi-robot"></i> Model Status
    </button>
    <button class="btn-modern btn-warning" id="configure-ai">
        <i class="bi bi-gear"></i> Configure
    </button>
</div>

<!-- Detection Progress -->
<div class="detection-progress" id="detection-progress-container" style="display: none;">
    <div class="d-flex align-items-center mb-2">
        <div class="spinning me-2">
            <i class="bi bi-cpu"></i>
        </div>
        <strong>Running AI Detection...</strong>
        <span class="ms-auto text-muted" id="detection-status-text">Initializing...</span>
    </div>
    <div class="progress-modern">
        <div class="progress-bar-modern" id="detection-progress-bar" style="width: 0%;"></div>
    </div>
    <small class="text-muted mt-1" id="detection-details">Analyzing device patterns and historical data...</small>
</div>

<!-- AI Model Status -->
<div class="ai-model-status" id="ai-model-status-banner" style="display: none;">
    <i class="bi bi-robot"></i>
    <div class="flex-grow-1">
        <strong>AI Model Status:</strong>
        <span id="ai-model-status-text">Checking...</span>
    </div>
    <small class="text-muted" id="ai-model-last-update">Last updated: --</small>
</div>

<!-- Mobile Stats (small screens) -->
<div class="mobile-stats">
    <div class="modern-card text-center">
        <div class="card-body">
            <div class="stat-value" id="mobile-ai-status">--</div>
            <div class="stat-label">AI Status</div>
        </div>
    </div>
    <div class="modern-card text-center">
        <div class="card-body">
            <div class="stat-value" id="mobile-anomalies">--</div>
            <div class="stat-label">Anomalies</div>
        </div>
    </div>
</div>

<!-- Desktop AI Stats Grid -->
<div class="ai-stats-grid">
    <div class="ai-stat-card primary">
        <i class="bi bi-cpu stat-icon"></i>
        <div class="stat-label">
            Detection Status
            <i class="bi bi-question-circle" title="Shows whether AI anomaly detection is actively running"></i>
        </div>
        <div class="stat-value" id="detection-status">Loading...</div>
    </div>

    <div class="ai-stat-card warning">
        <i class="bi bi-exclamation-triangle stat-icon"></i>
        <div class="stat-label">
            Anomalies (24h)
            <i class="bi bi-question-circle" title="Number of unusual patterns detected in the last 24 hours"></i>
        </div>
        <div class="stat-value" id="total-anomalies">--</div>
    </div>

    <div class="ai-stat-card info">
        <i class="bi bi-shield-check stat-icon"></i>
        <div class="stat-label">
            Detection Quality
            <i class="bi bi-question-circle" title="Average confidence level of AI detections"></i>
        </div>
        <div class="stat-value" id="avg-confidence">--</div>
    </div>

    <div class="ai-stat-card success">
        <i class="bi bi-graph-up stat-icon"></i>
        <div class="stat-label">
            Model Accuracy
            <i class="bi bi-question-circle" title="Current ML model prediction accuracy"></i>
        </div>
        <div class="stat-value" id="model-accuracy">--</div>
    </div>
</div>

<!-- Charts Row -->
<div class="row">
    <div class="col-lg-8 mb-2">
        <div class="chart-container">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5><i class="bi bi-graph-up"></i> Anomaly Trends</h5>
                <div class="btn-group btn-group-sm">
                    <button class="btn-modern btn-secondary active" data-period="24h">24H</button>
                    <button class="btn-modern btn-secondary" data-period="7d">7D</button>
                    <button class="btn-modern btn-secondary" data-period="30d">30D</button>
                </div>
            </div>
            <canvas id="anomalyTrendsChart" height="120"></canvas>
        </div>
    </div>

    <div class="col-lg-4 mb-2">
        <div class="chart-container">
            <h5 class="mb-2"><i class="bi bi-pie-chart"></i> Detection Types</h5>
            <canvas id="detectionTypesChart" height="120"></canvas>
        </div>
    </div>
</div>

<!-- Recent Anomalies -->
<div class="modern-card">
    <div class="card-header">
        <h3><i class="bi bi-exclamation-triangle"></i> Recent Anomalies</h3>
        <button class="btn-modern btn-secondary" id="export-anomalies">
            <i class="bi bi-download"></i> Export
        </button>
    </div>
    <div class="card-body p-0">
        <div id="anomalies-list">
            <!-- Anomalies will be loaded here -->
        </div>
    </div>
</div>

<!-- Model Status Modal -->
<div class="modal fade" id="modelStatusModal" tabindex="-1" aria-labelledby="modelStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="modelStatusModalLabel">
                    <i class="bi bi-cpu me-2"></i>AI Model Status
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row" id="modelStatusContent">
                    <div class="col-12 text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading model status...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="refreshModelStatus()">
                    <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<!-- AI Configuration Modal -->
<div class="modal fade" id="aiConfigModal" tabindex="-1" aria-labelledby="aiConfigModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="aiConfigModalLabel">
                    <i class="bi bi-gear me-2"></i>AI Configuration
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="aiConfigForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="detectionSensitivity" class="form-label">Detection Sensitivity</label>
                                <select class="form-select bg-dark text-light border-secondary" id="detectionSensitivity">
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                </select>
                                <div class="form-text text-muted">Higher sensitivity detects more anomalies but may increase false positives</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="analysisInterval" class="form-label">Analysis Interval (minutes)</label>
                                <select class="form-select bg-dark text-light border-secondary" id="analysisInterval">
                                    <option value="5">5 minutes</option>
                                    <option value="15" selected>15 minutes</option>
                                    <option value="30">30 minutes</option>
                                    <option value="60">1 hour</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Detection Types</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="detectResponseTime" checked>
                                    <label class="form-check-label" for="detectResponseTime">Response Time Anomalies</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="detectUptime" checked>
                                    <label class="form-check-label" for="detectUptime">Uptime Pattern Anomalies</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="detectConnectivity" checked>
                                    <label class="form-check-label" for="detectConnectivity">Connectivity Anomalies</label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Notification Settings</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="notifyEmail" checked>
                                    <label class="form-check-label" for="notifyEmail">Email Notifications</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="notifyWebhook">
                                    <label class="form-check-label" for="notifyWebhook">Webhook Notifications</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="notifyDashboard" checked>
                                    <label class="form-check-label" for="notifyDashboard">Dashboard Alerts</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="confidenceThreshold" class="form-label">Confidence Threshold: <span id="confidenceValue">75</span>%</label>
                        <input type="range" class="form-range" id="confidenceThreshold" min="50" max="95" value="75" oninput="document.getElementById('confidenceValue').textContent = this.value">
                        <div class="form-text text-muted">Only report anomalies with confidence above this threshold</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="saveAIConfiguration()">
                    <i class="bi bi-check-lg me-1"></i>Save Configuration
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let anomalyTrendsChart = null;
let detectionTypesChart = null;

document.addEventListener('DOMContentLoaded', function() {
    initializeAIDashboard();
    initializeCharts();
    setupEventListeners();

    // Refresh data every 30 seconds
    setInterval(loadAIData, 30000);
});

function initializeAIDashboard() {
    loadAIData();
    checkModelStatus();
}

function loadAIData() {
    fetch('/api/ai/dashboard')
        .then(response => response.json())
        .then(data => {
            updateAIStats(data);
            updateAnomaliesList(data.recent_anomalies || []);
            updateCharts(data);
        })
        .catch(error => {
            console.error('Error loading AI data:', error);
            showErrorState();
        });
}

function updateAIStats(data) {
    // Update desktop stats
    document.getElementById('detection-status').textContent = data.detection_status || 'Unknown';
    document.getElementById('total-anomalies').textContent = data.anomalies_24h || '0';
    document.getElementById('avg-confidence').textContent = data.avg_confidence || '--';
    document.getElementById('model-accuracy').textContent = data.model_accuracy || '--';

    // Update mobile stats
    document.getElementById('mobile-ai-status').textContent = data.detection_status || 'Unknown';
    document.getElementById('mobile-anomalies').textContent = data.anomalies_24h || '0';
}

function updateAnomaliesList(anomalies) {
    const listContainer = document.getElementById('anomalies-list');

    if (!anomalies || anomalies.length === 0) {
        listContainer.innerHTML = `
            <div class="text-center p-4">
                <i class="bi bi-shield-check" style="font-size: 3rem; opacity: 0.5;"></i>
                <p class="mt-2 mb-0">No anomalies detected recently</p>
                <small class="text-muted">Your network is operating normally</small>
            </div>
        `;
        return;
    }

    listContainer.innerHTML = anomalies.map(anomaly => `
        <div class="anomaly-item">
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <div class="d-flex align-items-center gap-2 mb-1">
                        <strong>${anomaly.title || 'Anomaly Detected'}</strong>
                        <span class="anomaly-severity severity-${anomaly.severity || 'medium'}">${anomaly.severity || 'Medium'}</span>
                    </div>
                    <p class="mb-1">${anomaly.description || 'No description available'}</p>
                    <small class="text-muted">
                        <i class="bi bi-clock"></i> ${formatDate(anomaly.detected_at)}
                        ${anomaly.device ? `• Device: ${anomaly.device}` : ''}
                        ${anomaly.confidence ? `• Confidence: ${anomaly.confidence}%` : ''}
                    </small>
                </div>
                <div class="text-end">
                    <button class="btn-modern btn-secondary btn-sm" onclick="viewAnomalyDetails(${anomaly.id})">
                        <i class="bi bi-eye"></i>
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

function initializeCharts() {
    // Initialize anomaly trends chart
    const trendsCtx = document.getElementById('anomalyTrendsChart').getContext('2d');
    anomalyTrendsChart = new Chart(trendsCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Anomalies Detected',
                data: [],
                borderColor: 'rgba(239, 68, 68, 1)',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: 'white' }
                }
            },
            scales: {
                x: {
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                y: {
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                }
            }
        }
    });

    // Initialize detection types chart
    const typesCtx = document.getElementById('detectionTypesChart').getContext('2d');
    detectionTypesChart = new Chart(typesCtx, {
        type: 'doughnut',
        data: {
            labels: ['Network', 'Performance', 'Security', 'Behavioral'],
            datasets: [{
                data: [0, 0, 0, 0],
                backgroundColor: [
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(34, 197, 94, 0.8)',
                    'rgba(239, 68, 68, 0.8)',
                    'rgba(245, 158, 11, 0.8)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: 'white' }
                }
            }
        }
    });
}

function updateCharts(data) {
    // Update anomaly trends chart
    if (data.trends && anomalyTrendsChart) {
        anomalyTrendsChart.data.labels = data.trends.labels || [];
        anomalyTrendsChart.data.datasets[0].data = data.trends.values || [];
        anomalyTrendsChart.update();
    }

    // Update detection types chart
    if (data.detection_types && detectionTypesChart) {
        detectionTypesChart.data.datasets[0].data = [
            data.detection_types.network || 0,
            data.detection_types.performance || 0,
            data.detection_types.security || 0,
            data.detection_types.behavioral || 0
        ];
        detectionTypesChart.update();
    }
}

function setupEventListeners() {
    document.getElementById('refresh-ai-data').addEventListener('click', loadAIData);
    document.getElementById('run-detection').addEventListener('click', runAIDetection);
    document.getElementById('view-models').addEventListener('click', viewModelStatus);
    document.getElementById('configure-ai').addEventListener('click', configureAI);
    document.getElementById('export-anomalies').addEventListener('click', exportAnomalies);

    // Period selection buttons
    document.querySelectorAll('[data-period]').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('[data-period]').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            loadDataForPeriod(this.dataset.period);
        });
    });
}

function runAIDetection() {
    const progressContainer = document.getElementById('detection-progress-container');
    const progressBar = document.getElementById('detection-progress-bar');
    const statusText = document.getElementById('detection-status-text');
    const detailsText = document.getElementById('detection-details');

    progressContainer.style.display = 'block';
    progressBar.style.width = '0%';
    statusText.textContent = 'Initializing...';

    // Simulate detection progress
    let progress = 0;
    const steps = [
        { progress: 20, status: 'Loading models...', details: 'Initializing ML models and algorithms...' },
        { progress: 40, status: 'Analyzing data...', details: 'Processing historical network data...' },
        { progress: 60, status: 'Running detection...', details: 'Scanning for anomalous patterns...' },
        { progress: 80, status: 'Validating results...', details: 'Verifying detection confidence...' },
        { progress: 100, status: 'Complete', details: 'Detection completed successfully' }
    ];

    steps.forEach((step, index) => {
        setTimeout(() => {
            progressBar.style.width = step.progress + '%';
            statusText.textContent = step.status;
            detailsText.textContent = step.details;

            if (step.progress === 100) {
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    loadAIData();
                    showGlobalLoading = showGlobalLoading || function() {};
                    showSuccess('AI detection completed successfully');
                }, 1000);
            }
        }, (index + 1) * 1500);
    });

    // Make actual API call
    if (window.makeRequest) {
        // Use CSRF-protected request
        window.makeRequest('/api/ai/run-detection', {
            method: 'POST',
            body: JSON.stringify({}),
            headers: { 'Content-Type': 'application/json' }
        })
        .then(data => {
            console.log('AI detection result:', data);
            progressContainer.style.display = 'none';
            if (data.success) {
                showSuccess(data.message || 'AI detection completed successfully');
            } else {
                showError(data.error || 'AI detection failed');
            }
        })
        .catch(error => {
            console.error('AI detection error:', error);
            progressContainer.style.display = 'none';
            showError('AI detection failed: ' + error.message);
        });
    } else {
        // Fallback if CSRF handler not available
        fetch('/api/ai/run-detection', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            console.log('AI detection result:', data);
            progressContainer.style.display = 'none';
            if (data.success) {
                showSuccess(data.message || 'AI detection completed successfully');
            } else {
                showError(data.error || 'AI detection failed');
            }
        })
        .catch(error => {
            console.error('AI detection error:', error);
            progressContainer.style.display = 'none';
            showError('AI detection failed: ' + error.message);
        });
    }
}

function checkModelStatus() {
    fetch('/api/ai/model-status')
        .then(response => response.json())
        .then(data => {
            const banner = document.getElementById('ai-model-status-banner');
            const statusText = document.getElementById('ai-model-status-text');
            const lastUpdate = document.getElementById('ai-model-last-update');

            if (data.status) {
                banner.style.display = 'block';
                statusText.textContent = data.status;
                lastUpdate.textContent = `Last updated: ${formatDate(data.last_update)}`;
            }
        })
        .catch(error => {
            console.error('Error checking model status:', error);
        });
}

function viewModelStatus() {
    // Show modal and load model status
    const modal = new bootstrap.Modal(document.getElementById('modelStatusModal'));
    modal.show();
    loadModelStatusData();
}

function configureAI() {
    // Show configuration modal and load current settings
    const modal = new bootstrap.Modal(document.getElementById('aiConfigModal'));
    modal.show();
    loadAIConfigurationData();
}

function exportAnomalies() {
    window.open('/api/ai/export-anomalies', '_blank');
}

function viewAnomalyDetails(anomalyId) {
    // This could open a detailed view of the anomaly
    alert(`Viewing details for anomaly ${anomalyId} - Details view not yet implemented`);
}

function loadDataForPeriod(period) {
    // Reload charts for the selected time period
    fetch(`/api/ai/dashboard?period=${period}`)
        .then(response => response.json())
        .then(data => {
            updateCharts(data);
        })
        .catch(error => {
            console.error('Error loading period data:', error);
        });
}

function showErrorState() {
    document.getElementById('detection-status').textContent = 'Error';
    document.getElementById('total-anomalies').textContent = '--';
    document.getElementById('avg-confidence').textContent = '--';
    document.getElementById('model-accuracy').textContent = '--';

    document.getElementById('anomalies-list').innerHTML = `
        <div class="text-center p-4">
            <i class="bi bi-exclamation-circle text-danger" style="font-size: 3rem;"></i>
            <p class="mt-2 mb-0">Error loading AI data</p>
            <small class="text-muted">Please try refreshing the page</small>
        </div>
    `;
}

function formatDate(dateString) {
    if (!dateString) return 'Unknown';
    return new Date(dateString).toLocaleString();
}

function loadModelStatusData() {
    fetch('/api/ai/model-status')
        .then(response => response.json())
        .then(data => {
            displayModelStatus(data);
        })
        .catch(error => {
            console.error('Error loading model status:', error);
            document.getElementById('modelStatusContent').innerHTML = `
                <div class="col-12 text-center">
                    <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                    <p class="mt-2 mb-0">Error loading model status</p>
                    <small class="text-muted">Please try again later</small>
                </div>
            `;
        });
}

function displayModelStatus(data) {
    const content = document.getElementById('modelStatusContent');
    content.innerHTML = `
        <div class="col-md-6">
            <div class="card bg-secondary mb-3">
                <div class="card-header">
                    <i class="bi bi-speedometer2 me-2"></i>Performance Metrics
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <div class="text-center">
                                <h5 class="text-primary">${data.accuracy || 'N/A'}</h5>
                                <small>Accuracy</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <h5 class="text-success">${data.performance_metrics?.f1_score ? (data.performance_metrics.f1_score * 100).toFixed(1) + '%' : 'N/A'}</h5>
                                <small>F1 Score</small>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-6">
                            <div class="text-center">
                                <h5 class="text-info">${data.performance_metrics?.precision ? (data.performance_metrics.precision * 100).toFixed(1) + '%' : 'N/A'}</h5>
                                <small>Precision</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <h5 class="text-warning">${data.performance_metrics?.recall ? (data.performance_metrics.recall * 100).toFixed(1) + '%' : 'N/A'}</h5>
                                <small>Recall</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card bg-secondary mb-3">
                <div class="card-header">
                    <i class="bi bi-info-circle me-2"></i>Model Information
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <strong>Status:</strong>
                        <span class="badge ${data.status === 'Active' ? 'bg-success' : 'bg-warning'}">${data.status || 'Unknown'}</span>
                    </div>
                    <div class="mb-2">
                        <strong>Version:</strong> ${data.model_version || 'N/A'}
                    </div>
                    <div class="mb-2">
                        <strong>Training Data:</strong> ${data.training_data_size || 'N/A'}
                    </div>
                    <div class="mb-2">
                        <strong>Last Update:</strong> ${formatDate(data.last_update)}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12">
            <div class="card bg-secondary">
                <div class="card-header">
                    <i class="bi bi-list-check me-2"></i>Detection Capabilities
                </div>
                <div class="card-body">
                    <div class="row">
                        ${data.detection_types ? data.detection_types.map(type => `
                            <div class="col-md-4 mb-2">
                                <i class="bi bi-check-circle text-success me-1"></i>${type}
                            </div>
                        `).join('') : '<div class="col-12 text-muted">No detection types available</div>'}
                    </div>
                </div>
            </div>
        </div>
    `;
}

function refreshModelStatus() {
    document.getElementById('modelStatusContent').innerHTML = `
        <div class="col-12 text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Refreshing model status...</p>
        </div>
    `;
    loadModelStatusData();
}

function loadAIConfigurationData() {
    // Load current configuration from API
    fetch('/api/ai/configure')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.config) {
                populateConfigurationForm(data.config);
            } else {
                console.log('Using default configuration values');
            }
        })
        .catch(error => {
            console.error('Error loading AI configuration:', error);
            console.log('Using default configuration values');
        });
}

function populateConfigurationForm(config) {
    // Populate form fields with loaded configuration
    if (config.detection_sensitivity) {
        document.getElementById('detectionSensitivity').value = config.detection_sensitivity;
    }
    if (config.analysis_interval) {
        document.getElementById('analysisInterval').value = config.analysis_interval;
    }
    if (config.confidence_threshold) {
        document.getElementById('confidenceThreshold').value = config.confidence_threshold;
        document.getElementById('confidenceValue').textContent = config.confidence_threshold;
    }
    if (config.detection_types) {
        document.getElementById('detectResponseTime').checked = config.detection_types.response_time || false;
        document.getElementById('detectUptime').checked = config.detection_types.uptime || false;
        document.getElementById('detectConnectivity').checked = config.detection_types.connectivity || false;
    }
    if (config.notifications) {
        document.getElementById('notifyEmail').checked = config.notifications.email || false;
        document.getElementById('notifyWebhook').checked = config.notifications.webhook || false;
        document.getElementById('notifyDashboard').checked = config.notifications.dashboard || false;
    }
}

function saveAIConfiguration() {
    const formData = {
        detection_sensitivity: document.getElementById('detectionSensitivity').value,
        analysis_interval: parseInt(document.getElementById('analysisInterval').value),
        detection_types: {
            response_time: document.getElementById('detectResponseTime').checked,
            uptime: document.getElementById('detectUptime').checked,
            connectivity: document.getElementById('detectConnectivity').checked
        },
        notifications: {
            email: document.getElementById('notifyEmail').checked,
            webhook: document.getElementById('notifyWebhook').checked,
            dashboard: document.getElementById('notifyDashboard').checked
        },
        confidence_threshold: parseInt(document.getElementById('confidenceThreshold').value)
    };

    // Show saving state
    const saveBtn = event.target;
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="bi bi-arrow-clockwise spin me-1"></i>Saving...';
    saveBtn.disabled = true;

    // Make API call to save configuration
    if (window.makeRequest) {
        // Use CSRF-protected request
        window.makeRequest('/api/ai/configure', {
            method: 'POST',
            body: JSON.stringify(formData),
            headers: { 'Content-Type': 'application/json' }
        })
        .then(data => {
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;

            if (data.success) {
                showSuccess(data.message || 'AI configuration saved successfully');

                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('aiConfigModal'));
                modal.hide();
            } else {
                showError(data.error || 'Failed to save configuration');
            }
        })
        .catch(error => {
            console.error('Error saving AI configuration:', error);
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
            showError('Failed to save AI configuration');
        });
    } else {
        // Fallback if CSRF handler not available
        fetch('/api/ai/configure', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;

            if (data.success) {
                showSuccess(data.message || 'AI configuration saved successfully');

                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('aiConfigModal'));
                modal.hide();
            } else {
                showError(data.error || 'Failed to save configuration');
            }
        })
        .catch(error => {
            console.error('Error saving AI configuration:', error);
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
            showError('Failed to save AI configuration');
        });
    }

    console.log('Saving AI configuration:', formData);
}

function showError(message) {
    // You can implement a toast notification system here
    alert('Error: ' + message);
}

function showSuccess(message) {
    // You can implement a toast notification system here
    alert('Success: ' + message);
}
</script>
{% endblock %}