<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - HomeNetMon</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <!-- Custom CSS -->
    <link href="/static/css/app.css" rel="stylesheet">
    
    <style>
        .status-up { color: #28a745; }
        .status-down { color: #dc3545; }
        .status-warning { color: #ffc107; }
        .status-unknown { color: #6c757d; }
        
        .device-card {
            transition: transform 0.2s;
            cursor: pointer;
        }
        
        .device-card:hover {
            transform: translateY(-2px);
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-indicator.up { background-color: #28a745; }
        .status-indicator.down { background-color: #dc3545; }
        .status-indicator.warning { background-color: #ffc107; }
        .status-indicator.unknown { background-color: #6c757d; }
        
        .sidebar {
            min-height: calc(100vh - 56px);
            background-color: #f8f9fa;
        }
        
        .main-content {
            padding: 20px;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }
        
        .alert-badge {
            position: absolute;
            top: -8px;
            right: -8px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="bi bi-router"></i> HomeNetMon
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/">
                            <i class="bi bi-speedometer2"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/alerts">
                            <i class="bi bi-exclamation-triangle"></i> Alerts
                            <span id="alert-count-badge" class="badge bg-danger ms-1" style="display: none;">0</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/settings">
                            <i class="bi bi-gear"></i> Settings
                        </a>
                    </li>
                </ul>
                
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <span class="navbar-text">
                            <span id="connection-status" class="badge bg-success">
                                <i class="bi bi-wifi"></i> Connected
                            </span>
                        </span>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 sidebar p-3">
                <div class="d-flex flex-column">
                    <h6 class="text-muted mb-3">QUICK STATS</h6>
                    
                    <div class="mb-3">
                        <small class="text-muted">Total Devices</small>
                        <div class="h5 mb-0" id="total-devices">-</div>
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted">Devices Up</small>
                        <div class="h5 mb-0 text-success" id="devices-up">-</div>
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted">Devices Down</small>
                        <div class="h5 mb-0 text-danger" id="devices-down">-</div>
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted">Active Alerts</small>
                        <div class="h5 mb-0 text-warning" id="active-alerts">-</div>
                    </div>
                    
                    <hr>
                    
                    <div class="mb-3">
                        <small class="text-muted">Last Update</small>
                        <div class="small" id="last-update">-</div>
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted">Network Range</small>
                        <div class="small" id="network-range">192.168.86.0/24</div>
                    </div>
                </div>
            </div>
            
            <!-- Main Content Area -->
            <div class="col-md-10 main-content">
                
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-speedometer2"></i> Kyle's Network Dashboard</h1>
    
    <div class="btn-group" role="group">
        <button type="button" class="btn btn-outline-primary" id="refresh-btn">
            <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
        <button type="button" class="btn btn-outline-primary" id="scan-btn">
            <i class="bi bi-search"></i> Scan Network
        </button>
        <button type="button" class="btn btn-outline-success" id="ping-all-btn">
            <i class="bi bi-broadcast"></i> Ping All
        </button>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="bi bi-eye"></i> View
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" id="view-grid">Grid View</a></li>
                <li><a class="dropdown-item" href="#" id="view-list">List View</a></li>
            </ul>
        </div>
    </div>
</div>

<!-- Background Activity Status Bar -->
<div id="background-status-bar" class="mb-3" style="display: none;">
    <div class="alert alert-info mb-0 d-flex align-items-center">
        <div class="spinner-border spinner-border-sm me-2" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div class="flex-grow-1">
            <strong id="background-activity-text">Background monitoring active</strong>
            <br>
            <small id="background-activity-detail" class="text-muted">Next automatic scan in 4m 32s</small>
        </div>
        <div class="d-flex align-items-center">
            <small class="text-muted me-3">
                <i class="bi bi-clock"></i> <span id="current-datetime">-</span>
            </small>
            <small class="text-muted me-3">
                <i class="bi bi-server"></i> Started: <span id="server-start-time">-</span>
            </small>
            <small class="text-muted me-3">
                <i class="bi bi-broadcast"></i> Last ping: <span id="last-ping-time">-</span>
            </small>
            <small class="text-muted">
                <i class="bi bi-search"></i> Last scan: <span id="last-scan-time">-</span>
            </small>
        </div>
    </div>
</div>

<!-- Ping All Progress Bar -->
<div id="ping-progress-container" class="mb-4" style="display: none;">
    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Pinging All Devices</h6>
                <span id="ping-progress-text">0 / 0 devices</span>
            </div>
            <div class="progress">
                <div id="ping-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                </div>
            </div>
            <div class="mt-2 d-flex justify-content-between">
                <small class="text-success">
                    <i class="bi bi-check-circle"></i> 
                    <span id="ping-success-count">0</span> successful
                </small>
                <small class="text-danger">
                    <i class="bi bi-x-circle"></i> 
                    <span id="ping-fail-count">0</span> failed
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Network Scan Progress Bar -->
<div id="scan-progress-container" class="mb-4" style="display: none;">
    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">
                    <i class="bi bi-radar me-2"></i>
                    Scanning Network
                </h6>
                <span id="scan-progress-text">Initializing...</span>
            </div>
            <div class="progress">
                <div id="scan-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-info" 
                     role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                </div>
            </div>
            <div class="mt-2 d-flex justify-content-between">
                <small class="text-info">
                    <i class="bi bi-search"></i> 
                    Discovering devices on 192.168.86.0/24
                </small>
                <small class="text-success">
                    <i class="bi bi-plus-circle"></i> 
                    <span id="scan-new-devices">0</span> new devices found
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Network Overview Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <i class="bi bi-router display-4"></i>
                <h3 class="mt-2" id="overview-total">-</h3>
                <p class="mb-0">Total Devices</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card border-success">
            <div class="card-body text-center">
                <i class="bi bi-check-circle display-4 text-success"></i>
                <h3 class="mt-2 text-success" id="overview-up">-</h3>
                <p class="mb-0">Online</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card border-danger">
            <div class="card-body text-center">
                <i class="bi bi-x-circle display-4 text-danger"></i>
                <h3 class="mt-2 text-danger" id="overview-down">-</h3>
                <p class="mb-0">Offline</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card border-warning">
            <div class="card-body text-center">
                <i class="bi bi-exclamation-triangle display-4 text-warning"></i>
                <h3 class="mt-2 text-warning" id="overview-alerts">-</h3>
                <p class="mb-0">Alerts</p>
            </div>
        </div>
    </div>
</div>

<!-- Filters and Search -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row align-items-end">
            <div class="col-md-3">
                <label for="search-input" class="form-label">Search Devices</label>
                <input type="text" class="form-control" id="search-input" placeholder="Search by name or IP...">
            </div>
            
            <div class="col-md-2">
                <label for="filter-status" class="form-label">Status</label>
                <select class="form-select" id="filter-status">
                    <option value="">All</option>
                    <option value="up">Online</option>
                    <option value="down">Offline</option>
                    <option value="warning">Warning</option>
                    <option value="unknown">Unknown</option>
                </select>
            </div>
            
            <div class="col-md-2">
                <label for="filter-type" class="form-label">Type</label>
                <select class="form-select" id="filter-type">
                    <option value="">All Types</option>
                </select>
            </div>
            
            <div class="col-md-2">
                <label for="filter-group" class="form-label">Group</label>
                <select class="form-select" id="filter-group">
                    <option value="">All Groups</option>
                </select>
            </div>
            
            <div class="col-md-3">
                <button type="button" class="btn btn-outline-secondary me-2" id="clear-filters">
                    <i class="bi bi-x-circle"></i> Clear
                </button>
                <button type="button" class="btn btn-primary" id="add-device-btn" data-bs-toggle="modal" data-bs-target="#addDeviceModal">
                    <i class="bi bi-plus-circle"></i> Add Device
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Indicator -->
<div class="text-center py-5" id="loading-indicator">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2 text-muted">Loading devices...</p>
</div>

<!-- Devices Grid/List -->
<div id="devices-container">
    <!-- Grid View -->
    <div id="grid-view" class="row">
        <!-- Device cards will be inserted here -->
    </div>
    
    <!-- List View -->
    <div id="list-view" class="card" style="display: none;">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Status</th>
                        <th>Name</th>
                        <th>IP Address</th>
                        <th>Type</th>
                        <th>Response Time</th>
                        <th>Uptime</th>
                        <th>Last Seen</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="devices-table-body">
                    <!-- Device rows will be inserted here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- No Devices Message -->
<div class="text-center py-5" id="no-devices" style="display: none;">
    <i class="bi bi-router display-1 text-muted"></i>
    <h3 class="mt-3 text-muted">No devices found</h3>
    <p class="text-muted">Try adjusting your filters or scan the network for new devices.</p>
    <button type="button" class="btn btn-primary" id="scan-network-btn">
        <i class="bi bi-search"></i> Scan Network
    </button>
</div>

<!-- Add Device Modal -->
<div class="modal fade" id="addDeviceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Device</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="add-device-form">
                    <div class="mb-3">
                        <label for="device-ip" class="form-label">IP Address *</label>
                        <input type="text" class="form-control" id="device-ip" required>
                        <div class="form-text">Enter the IP address of the device to monitor</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="device-name" class="form-label">Custom Name</label>
                        <input type="text" class="form-control" id="device-name">
                        <div class="form-text">Optional: Give the device a friendly name</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="device-type" class="form-label">Device Type</label>
                        <select class="form-select" id="device-type">
                            <option value="unknown">Unknown</option>
                            <option value="router">Router</option>
                            <option value="computer">Computer</option>
                            <option value="phone">Phone</option>
                            <option value="iot">IoT Device</option>
                            <option value="printer">Printer</option>
                            <option value="camera">Camera</option>
                            <option value="server">Server</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="device-group" class="form-label">Group</label>
                        <input type="text" class="form-control" id="device-group">
                        <div class="form-text">Optional: Organize devices into groups</div>
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="device-monitor" checked>
                        <label class="form-check-label" for="device-monitor">
                            Monitor this device
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-device-btn">Add Device</button>
            </div>
        </div>
    </div>
</div>

            </div>
        </div>
    </div>

    <!-- Toast Container for Notifications -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <!-- Toast notifications will be added here dynamically -->
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Base JavaScript -->
    <script>
        // Global variables
        let socket;
        let devices = [];
        let alerts = [];
        
        // Initialize Socket.IO connection
        function initializeSocket() {
            socket = io();
            
            socket.on('connect', function() {
                console.log('Connected to HomeNetMon server');
                updateConnectionStatus(true);
            });
            
            socket.on('disconnect', function() {
                console.log('Disconnected from HomeNetMon server');
                updateConnectionStatus(false);
            });
            
            socket.on('device_status_update', function(data) {
                console.log('Device status update:', data);
                updateDeviceStatus(data);
                showToast(`Device ${data.display_name} status updated`, 'info');
            });
            
            socket.on('monitoring_summary', function(data) {
                console.log('Monitoring summary:', data);
                updateSidebarStats(data);
                updateLastUpdateTime();
            });
            
            // Request initial device update
            socket.emit('request_device_update');
        }
        
        // Update connection status indicator
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connection-status');
            if (connected) {
                statusElement.className = 'badge bg-success';
                statusElement.innerHTML = '<i class="bi bi-wifi"></i> Connected';
            } else {
                statusElement.className = 'badge bg-danger';
                statusElement.innerHTML = '<i class="bi bi-wifi-off"></i> Disconnected';
            }
        }
        
        // Update sidebar statistics
        function updateSidebarStats(data) {
            if (data.total_devices !== undefined) {
                document.getElementById('total-devices').textContent = data.total_devices;
            }
            if (data.devices_up !== undefined) {
                document.getElementById('devices-up').textContent = data.devices_up;
            }
            if (data.devices_down !== undefined) {
                document.getElementById('devices-down').textContent = data.devices_down;
            }
        }
        
        // Update last update time
        function updateLastUpdateTime() {
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
        }
        
        // Show toast notification
        function showToast(message, type = 'info', duration = 5000) {
            const toastContainer = document.querySelector('.toast-container');
            const toastId = 'toast-' + Date.now();
            
            const bgClass = {
                'success': 'bg-success',
                'error': 'bg-danger',
                'warning': 'bg-warning',
                'info': 'bg-info'
            }[type] || 'bg-info';
            
            const toastHtml = `
                <div id="${toastId}" class="toast ${bgClass} text-white" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            
            const toast = new bootstrap.Toast(document.getElementById(toastId), {
                autohide: true,
                delay: duration
            });
            
            toast.show();
            
            // Remove element after it's hidden
            document.getElementById(toastId).addEventListener('hidden.bs.toast', function() {
                this.remove();
            });
        }
        
        // Format response time
        function formatResponseTime(ms) {
            if (ms === null || ms === undefined) {
                return 'N/A';
            }
            if (ms < 1) {
                return '<1ms';
            }
            return Math.round(ms) + 'ms';
        }
        
        // Format uptime percentage
        function formatUptime(percentage) {
            if (percentage === null || percentage === undefined) {
                return 'N/A';
            }
            return percentage.toFixed(1) + '%';
        }
        
        // Load active alerts count
        async function loadActiveAlertsCount() {
            try {
                const response = await fetch('/api/monitoring/alerts?resolved=false');
                const data = await response.json();
                
                const count = data.count || 0;
                const badge = document.getElementById('alert-count-badge');
                
                if (count > 0) {
                    badge.textContent = count;
                    badge.style.display = 'inline';
                } else {
                    badge.style.display = 'none';
                }
                
                document.getElementById('active-alerts').textContent = count;
                
            } catch (error) {
                console.error('Error loading alerts count:', error);
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            loadActiveAlertsCount();
            
            // Refresh alerts count periodically
            setInterval(loadActiveAlertsCount, 30000); // Every 30 seconds
        });
    </script>
    
    
<script>
let currentView = 'grid';
let filteredDevices = [];

// Load devices data
async function loadDevices() {
    try {
        document.getElementById('loading-indicator').style.display = 'block';
        document.getElementById('devices-container').style.display = 'none';
        document.getElementById('no-devices').style.display = 'none';
        
        const response = await fetch('/api/devices');
        const data = await response.json();
        
        devices = data.devices || [];
        filteredDevices = devices;
        
        // Load filter options
        await loadFilterOptions();
        
        // Update overview stats
        updateOverviewStats();
        
        // Display devices
        displayDevices();
        
        document.getElementById('loading-indicator').style.display = 'none';
        document.getElementById('devices-container').style.display = 'block';
        
    } catch (error) {
        console.error('Error loading devices:', error);
        showToast('Error loading devices', 'error');
        document.getElementById('loading-indicator').style.display = 'none';
    }
}

// Load filter options
async function loadFilterOptions() {
    try {
        // Load device types
        const typesResponse = await fetch('/api/devices/types');
        const typesData = await typesResponse.json();
        
        const typeSelect = document.getElementById('filter-type');
        typeSelect.innerHTML = '<option value="">All Types</option>';
        typesData.types.forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.textContent = getDeviceTypeDisplayName(type);
            typeSelect.appendChild(option);
        });
        
        // Load device groups
        const groupsResponse = await fetch('/api/devices/groups');
        const groupsData = await groupsResponse.json();
        
        const groupSelect = document.getElementById('filter-group');
        groupSelect.innerHTML = '<option value="">All Groups</option>';
        groupsData.groups.forEach(group => {
            const option = document.createElement('option');
            option.value = group;
            option.textContent = group;
            groupSelect.appendChild(option);
        });
        
    } catch (error) {
        console.error('Error loading filter options:', error);
    }
}

// Get device icon based on device type
function getDeviceIcon(deviceType) {
    const icons = {
        'camera': 'camera-video',
        'router': 'router',
        'apple': 'apple',
        'phone': 'phone',
        'computer': 'laptop',
        'smart_home': 'house-gear',
        'iot': 'cpu',
        'gaming': 'controller',
        'media': 'tv',
        'printer': 'printer',
        'storage': 'hdd-stack',
        'unknown': 'question-circle'
    };
    
    return icons[deviceType] || 'question-circle';
}

// Get device type display name
function getDeviceTypeDisplayName(deviceType) {
    const displayNames = {
        'camera': 'Camera',
        'router': 'Router',
        'apple': 'Apple Device',
        'phone': 'Phone',
        'computer': 'Computer',
        'smart_home': 'Smart Home',
        'iot': 'IoT Device',
        'gaming': 'Gaming',
        'media': 'Media Device',
        'printer': 'Printer',
        'storage': 'Storage',
        'unknown': 'Unknown'
    };
    
    return displayNames[deviceType] || 'Unknown';
}

// Update overview statistics
function updateOverviewStats() {
    const statusCounts = {
        up: 0,
        down: 0,
        warning: 0,
        unknown: 0
    };
    
    devices.forEach(device => {
        if (statusCounts.hasOwnProperty(device.status)) {
            statusCounts[device.status]++;
        }
    });
    
    document.getElementById('overview-total').textContent = devices.length;
    document.getElementById('overview-up').textContent = statusCounts.up;
    document.getElementById('overview-down').textContent = statusCounts.down;
    
    // Update sidebar stats too
    document.getElementById('total-devices').textContent = devices.length;
    document.getElementById('devices-up').textContent = statusCounts.up;
    document.getElementById('devices-down').textContent = statusCounts.down;
}

// Display devices based on current view
function displayDevices() {
    if (filteredDevices.length === 0) {
        document.getElementById('devices-container').style.display = 'none';
        document.getElementById('no-devices').style.display = 'block';
        return;
    }
    
    document.getElementById('devices-container').style.display = 'block';
    document.getElementById('no-devices').style.display = 'none';
    
    if (currentView === 'grid') {
        displayGridView();
    } else {
        displayListView();
    }
}

// Display devices in grid view
function displayGridView() {
    const gridContainer = document.getElementById('grid-view');
    gridContainer.innerHTML = '';
    
    filteredDevices.forEach(device => {
        const card = createDeviceCard(device);
        gridContainer.appendChild(card);
    });
}

// Create device card element
function createDeviceCard(device) {
    const col = document.createElement('div');
    col.className = 'col-md-4 col-lg-3 mb-4';
    
    const alertBadge = device.active_alerts > 0 ? 
        `<span class="badge bg-danger alert-badge">${device.active_alerts}</span>` : '';
    
    col.innerHTML = `
        <div class="card device-card h-100" onclick="viewDevice(${device.id})">
            <div class="card-body position-relative">
                ${alertBadge}
                
                <div class="d-flex align-items-center mb-2">
                    <span class="status-indicator ${device.status}"></span>
                    <i class="bi bi-${getDeviceIcon(device.device_type)} me-2 text-primary"></i>
                    <h6 class="card-title mb-0">${device.display_name}</h6>
                </div>
                
                <p class="text-muted small mb-2">${device.ip_address}</p>
                
                <div class="row text-center">
                    <div class="col-6">
                        <div class="small text-muted">Response</div>
                        <div class="fw-bold">${formatResponseTime(device.latest_response_time)}</div>
                    </div>
                    <div class="col-6">
                        <div class="small text-muted">Uptime</div>
                        <div class="fw-bold">${formatUptime(device.uptime_percentage)}</div>
                    </div>
                </div>
                
                <div class="mt-2">
                    <span class="badge bg-light text-dark">
                        <i class="bi bi-${getDeviceIcon(device.device_type)} me-1"></i>
                        ${getDeviceTypeDisplayName(device.device_type)}
                    </span>
                    ${device.device_group ? `<span class="badge bg-secondary">${device.device_group}</span>` : ''}
                </div>
            </div>
            
            <div class="card-footer bg-transparent">
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                        ${device.last_seen ? new Date(device.last_seen).toLocaleString() : 'Never'}
                    </small>
                    <div class="btn-group btn-group-sm" onclick="event.stopPropagation()">
                        <button class="btn btn-outline-primary" onclick="pingDevice(${device.id})">
                            <i class="bi bi-wifi"></i>
                        </button>
                        <button class="btn btn-outline-secondary" onclick="editDevice(${device.id})">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    return col;
}

// Display devices in list view
function displayListView() {
    const tbody = document.getElementById('devices-table-body');
    tbody.innerHTML = '';
    
    filteredDevices.forEach(device => {
        const row = createDeviceRow(device);
        tbody.appendChild(row);
    });
}

// Create device table row
function createDeviceRow(device) {
    const row = document.createElement('tr');
    row.style.cursor = 'pointer';
    row.onclick = () => viewDevice(device.id);
    
    const alertBadge = device.active_alerts > 0 ? 
        `<span class="badge bg-danger ms-1">${device.active_alerts}</span>` : '';
    
    row.innerHTML = `
        <td>
            <span class="status-indicator ${device.status}"></span>
            ${device.status}
        </td>
        <td>
            <i class="bi bi-${getDeviceIcon(device.device_type)} me-2 text-primary"></i>
            ${device.display_name}
            ${alertBadge}
        </td>
        <td>${device.ip_address}</td>
        <td>
            <span class="badge bg-light text-dark">
                <i class="bi bi-${getDeviceIcon(device.device_type)} me-1"></i>
                ${getDeviceTypeDisplayName(device.device_type)}
            </span>
            ${device.device_group ? `<br><span class="badge bg-secondary">${device.device_group}</span>` : ''}
        </td>
        <td>${formatResponseTime(device.latest_response_time)}</td>
        <td>${formatUptime(device.uptime_percentage)}</td>
        <td>${device.last_seen ? new Date(device.last_seen).toLocaleString() : 'Never'}</td>
        <td onclick="event.stopPropagation()">
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" onclick="pingDevice(${device.id})">
                    <i class="bi bi-wifi"></i>
                </button>
                <button class="btn btn-outline-secondary" onclick="editDevice(${device.id})">
                    <i class="bi bi-pencil"></i>
                </button>
            </div>
        </td>
    `;
    
    return row;
}

// Filter devices based on current filters
function filterDevices() {
    const search = document.getElementById('search-input').value.toLowerCase();
    const status = document.getElementById('filter-status').value;
    const type = document.getElementById('filter-type').value;
    const group = document.getElementById('filter-group').value;
    
    filteredDevices = devices.filter(device => {
        // Search filter
        const matchesSearch = !search || 
            device.display_name.toLowerCase().includes(search) ||
            device.ip_address.toLowerCase().includes(search) ||
            (device.hostname && device.hostname.toLowerCase().includes(search));
        
        // Status filter
        const matchesStatus = !status || device.status === status;
        
        // Type filter
        const matchesType = !type || device.device_type === type;
        
        // Group filter
        const matchesGroup = !group || device.device_group === group;
        
        return matchesSearch && matchesStatus && matchesType && matchesGroup;
    });
    
    displayDevices();
}

// Clear all filters
function clearFilters() {
    document.getElementById('search-input').value = '';
    document.getElementById('filter-status').value = '';
    document.getElementById('filter-type').value = '';
    document.getElementById('filter-group').value = '';
    
    filteredDevices = devices;
    displayDevices();
}

// Switch view mode
function switchView(viewType) {
    currentView = viewType;
    
    if (viewType === 'grid') {
        document.getElementById('grid-view').style.display = 'block';
        document.getElementById('list-view').style.display = 'none';
    } else {
        document.getElementById('grid-view').style.display = 'none';
        document.getElementById('list-view').style.display = 'block';
    }
    
    displayDevices();
}

// View device details
function viewDevice(deviceId) {
    window.location.href = `/device/${deviceId}`;
}

// Edit device
function editDevice(deviceId) {
    // Implementation for edit device modal
    console.log('Edit device:', deviceId);
}

// Ping device manually
async function pingDevice(deviceId) {
    try {
        const response = await fetch(`/api/devices/${deviceId}/ping`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast(`Device pinged successfully: ${formatResponseTime(data.response_time)}`, 'success');
        } else {
            showToast('Device ping failed', 'error');
        }
        
        // Refresh devices after ping
        setTimeout(loadDevices, 1000);
        
    } catch (error) {
        console.error('Error pinging device:', error);
        showToast('Error pinging device', 'error');
    }
}

// Add new device
async function addDevice() {
    try {
        const ip = document.getElementById('device-ip').value.trim();
        const name = document.getElementById('device-name').value.trim();
        const type = document.getElementById('device-type').value;
        const group = document.getElementById('device-group').value.trim();
        const monitor = document.getElementById('device-monitor').checked;
        
        if (!ip) {
            showToast('IP address is required', 'error');
            return;
        }
        
        const deviceData = {
            ip_address: ip,
            custom_name: name || null,
            device_type: type,
            device_group: group || null,
            is_monitored: monitor
        };
        
        const response = await fetch('/api/devices', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(deviceData)
        });
        
        if (response.ok) {
            showToast('Device added successfully', 'success');
            
            // Close modal and reset form
            const modal = bootstrap.Modal.getInstance(document.getElementById('addDeviceModal'));
            modal.hide();
            document.getElementById('add-device-form').reset();
            
            // Reload devices
            loadDevices();
        } else {
            const error = await response.json();
            showToast(error.error || 'Error adding device', 'error');
        }
        
    } catch (error) {
        console.error('Error adding device:', error);
        showToast('Error adding device', 'error');
    }
}

// Update device status from real-time updates
function updateDeviceStatus(data) {
    const device = devices.find(d => d.id === data.device_id);
    if (device) {
        device.latest_response_time = data.response_time;
        device.status = data.status;
        device.last_seen = data.timestamp;
        
        // Update display if device is currently visible
        if (filteredDevices.includes(device)) {
            displayDevices();
        }
        
        updateOverviewStats();
    }
}

// Background activity management
let backgroundStatus = {
    nextScanTime: null,
    lastPingTime: null,
    lastScanTime: null,
    intervalIds: []
};

async function updateBackgroundStatus() {
    try {
        // Add cache-busting parameter to prevent stale data
        const cacheBuster = Date.now();
        const response = await fetch(`/api/monitoring/background-activity?_=${cacheBuster}`);
        if (!response.ok) {
            throw new Error('Failed to fetch background activity');
        }
        
        const data = await response.json();
        
        // Update background status data
        backgroundStatus.lastPingTime = data.last_ping_time;
        backgroundStatus.lastScanTime = data.last_scan_time;
        backgroundStatus.nextScanTime = data.next_scan_time;
        
        const statusBar = document.getElementById('background-status-bar');
        const activityText = document.getElementById('background-activity-text');
        const activityDetail = document.getElementById('background-activity-detail');
        const lastPingElement = document.getElementById('last-ping-time');
        const lastScanElement = document.getElementById('last-scan-time');
        
        // Show the status bar if monitoring is active
        if (data.monitoring_active) {
            statusBar.style.display = 'block';
        } else {
            statusBar.style.display = 'none';
            return;
        }
        
        // Update last activity times
        if (data.last_ping_time) {
            const lastPing = new Date(data.last_ping_time);
            lastPingElement.textContent = formatTimeAgo(lastPing);
        } else {
            lastPingElement.textContent = 'never';
        }
        
        if (data.last_scan_time) {
            const lastScan = new Date(data.last_scan_time);
            lastScanElement.textContent = formatTimeAgo(lastScan);
        } else {
            lastScanElement.textContent = 'never';
        }
        
        // Calculate next scan countdown
        const scanInterval = data.scan_interval_seconds || 300;
        const scanMinutes = Math.round(scanInterval / 60);
        
        let nextScanText = `Automatic scans every ${scanMinutes} minutes`;
        
        // Add countdown if we have last scan time
        if (data.last_scan_time) {
            const lastScan = new Date(data.last_scan_time);
            const nextScanTime = new Date(lastScan.getTime() + (scanInterval * 1000));
            const now = new Date();
            const timeUntilNext = Math.max(0, nextScanTime - now);
            
            if (timeUntilNext > 0) {
                const minutesLeft = Math.ceil(timeUntilNext / (1000 * 60));
                nextScanText += ` • Next scan in ${minutesLeft}m`;
            } else {
                nextScanText += ` • Next scan due now`;
            }
        }
        
        activityDetail.textContent = nextScanText;
        
        // Update activity text based on recent activity
        const recentPings = data.recent_activity.ping_count_1h;
        if (recentPings > 0) {
            activityText.textContent = `Background monitoring active (${recentPings} pings in last hour)`;
        } else {
            activityText.textContent = 'Background monitoring active';
        }
        
    } catch (error) {
        console.error('Error updating background status:', error);
        // Hide status bar on error
        document.getElementById('background-status-bar').style.display = 'none';
    }
}

function formatTimeAgo(date) {
    const now = new Date();
    const diff = now - date;
    const minutes = Math.floor(diff / (1000 * 60));
    const hours = Math.floor(minutes / 60);
    
    if (minutes < 1) {
        return 'just now';
    } else if (minutes < 60) {
        return `${minutes}m ago`;
    } else if (hours < 24) {
        return `${hours}h ago`;
    } else {
        const days = Math.floor(hours / 24);
        return `${days}d ago`;
    }
}

function showBackgroundActivity(type, detail) {
    const statusBar = document.getElementById('background-status-bar');
    const activityText = document.getElementById('background-activity-text');
    const activityDetail = document.getElementById('background-activity-detail');
    const spinner = statusBar.querySelector('.spinner-border');
    
    statusBar.style.display = 'block';
    spinner.style.display = 'inline-block';
    
    if (type === 'ping') {
        activityText.textContent = 'Background ping in progress...';
        activityDetail.textContent = detail || 'Checking device connectivity';
        backgroundStatus.lastPingTime = new Date().toISOString();
    } else if (type === 'scan') {
        activityText.textContent = 'Background network scan in progress...';
        activityDetail.textContent = detail || 'Discovering new devices';
        backgroundStatus.lastScanTime = new Date().toISOString();
    }
}

function hideBackgroundActivity() {
    const statusBar = document.getElementById('background-status-bar');
    const spinner = statusBar.querySelector('.spinner-border');
    
    spinner.style.display = 'none';
    updateBackgroundStatus();
}

function startBackgroundStatusUpdates() {
    // Update status every 5 seconds
    backgroundStatus.intervalIds.push(setInterval(updateBackgroundStatus, 5000));
    
    // Update server health every 30 seconds
    backgroundStatus.intervalIds.push(setInterval(loadServerHealth, 30000));
    
    // Update current date and time every second
    backgroundStatus.intervalIds.push(setInterval(updateCurrentDateTime, 1000));
    
    // Initial update
    updateBackgroundStatus();
}

// Update current date and time
function updateCurrentDateTime() {
    const now = new Date();
    const options = {
        weekday: 'short',
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
    };
    
    const formattedDateTime = now.toLocaleDateString('en-US', options);
    document.getElementById('current-datetime').textContent = formattedDateTime;
}

// Load server health information
async function loadServerHealth() {
    try {
        const response = await fetch('/health');
        const data = await response.json();
        
        if (data.started_at) {
            const startTime = new Date(data.started_at);
            const now = new Date();
            const uptimeMinutes = Math.floor((now - startTime) / 1000 / 60);
            
            let uptimeText = '';
            if (uptimeMinutes < 60) {
                uptimeText = `${uptimeMinutes}m`;
            } else {
                const hours = Math.floor(uptimeMinutes / 60);
                const minutes = uptimeMinutes % 60;
                if (hours < 24) {
                    uptimeText = `${hours}h ${minutes}m`;
                } else {
                    const days = Math.floor(hours / 24);
                    const remainingHours = hours % 24;
                    uptimeText = `${days}d ${remainingHours}h`;
                }
            }
            
            document.getElementById('server-start-time').textContent = uptimeText;
        }
    } catch (error) {
        console.error('Error loading server health:', error);
        document.getElementById('server-start-time').textContent = 'Error';
    }
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Load initial data
    loadDevices();
    
    // Load server health info
    loadServerHealth();
    
    // Update current date and time initially
    updateCurrentDateTime();
    
    // Start background status updates
    startBackgroundStatusUpdates();
    
    // Search and filter event listeners
    document.getElementById('search-input').addEventListener('input', filterDevices);
    document.getElementById('filter-status').addEventListener('change', filterDevices);
    document.getElementById('filter-type').addEventListener('change', filterDevices);
    document.getElementById('filter-group').addEventListener('change', filterDevices);
    
    // Button event listeners
    document.getElementById('clear-filters').addEventListener('click', clearFilters);
    document.getElementById('refresh-btn').addEventListener('click', loadDevices);
    // Network scan button with progress tracking
    document.getElementById('scan-btn').addEventListener('click', async () => {
        startNetworkScan();
    });
    document.getElementById('scan-network-btn').addEventListener('click', async () => {
        startNetworkScan();
    });
    
    // Network scan function
    async function startNetworkScan() {
        const button = document.getElementById('scan-btn');
        const originalText = button.innerHTML;
        const progressContainer = document.getElementById('scan-progress-container');
        const progressBar = document.getElementById('scan-progress-bar');
        const progressText = document.getElementById('scan-progress-text');
        const newDevicesCount = document.getElementById('scan-new-devices');
        
        try {
            // Get current device count
            const beforeResponse = await fetch('/api/devices');
            const beforeData = await beforeResponse.json();
            const devicesBefore = beforeData.devices.length;
            
            // Show progress bar and disable button
            button.disabled = true;
            button.innerHTML = '<i class="bi bi-radar"></i> Scanning...';
            progressContainer.style.display = 'block';
            
            // Initialize progress
            progressText.textContent = 'Initializing scan...';
            progressBar.style.width = '0%';
            progressBar.setAttribute('aria-valuenow', '0');
            newDevicesCount.textContent = '0';
            
            showToast('Network scan initiated - discovering devices...', 'info');
            
            // Simulate scan progress stages
            const scanStages = [
                { progress: 10, text: 'Checking ARP table...', delay: 500 },
                { progress: 25, text: 'Starting nmap scan...', delay: 1000 },
                { progress: 40, text: 'Scanning IP range 192.168.86.1-50...', delay: 1500 },
                { progress: 60, text: 'Scanning IP range 192.168.86.51-100...', delay: 1500 },
                { progress: 75, text: 'Scanning IP range 192.168.86.101-200...', delay: 1500 },
                { progress: 90, text: 'Resolving hostnames and vendors...', delay: 1000 },
                { progress: 100, text: 'Updating database...', delay: 800 }
            ];
            
            for (const stage of scanStages) {
                await new Promise(resolve => setTimeout(resolve, stage.delay));
                progressBar.style.width = `${stage.progress}%`;
                progressBar.setAttribute('aria-valuenow', stage.progress.toString());
                progressText.textContent = stage.text;
            }
            
            // Get updated device count
            const afterResponse = await fetch('/api/devices');
            const afterData = await afterResponse.json();
            const devicesAfter = afterData.devices.length;
            const newDevices = devicesAfter - devicesBefore;
            
            newDevicesCount.textContent = newDevices.toString();
            progressText.textContent = `Scan complete - ${devicesAfter} total devices`;
            
            // Show completion message
            if (newDevices > 0) {
                showToast(`Network scan completed! Found ${newDevices} new devices (${devicesAfter} total)`, 'success');
            } else {
                showToast(`Network scan completed! ${devicesAfter} devices confirmed`, 'info');
            }
            
            // Hide progress bar after a delay
            setTimeout(() => {
                progressContainer.style.display = 'none';
            }, 4000);
            
            // Refresh device list to show any new devices
            setTimeout(loadDevices, 1000);
            
        } catch (error) {
            console.error('Error during network scan:', error);
            showToast('Network scan failed: ' + error.message, 'danger');
            progressContainer.style.display = 'none';
        } finally {
            // Restore button state
            button.disabled = false;
            button.innerHTML = originalText;
        }
    }
    
    // Ping All button with progress tracking
    document.getElementById('ping-all-btn').addEventListener('click', async () => {
        const button = document.getElementById('ping-all-btn');
        const originalText = button.innerHTML;
        const progressContainer = document.getElementById('ping-progress-container');
        const progressBar = document.getElementById('ping-progress-bar');
        const progressText = document.getElementById('ping-progress-text');
        const successCount = document.getElementById('ping-success-count');
        const failCount = document.getElementById('ping-fail-count');
        
        try {
            // Get all monitored devices first
            const devicesResponse = await fetch('/api/devices?monitored=true');
            if (!devicesResponse.ok) {
                throw new Error('Failed to fetch devices');
            }
            const devicesData = await devicesResponse.json();
            const devices = devicesData.devices;
            
            if (devices.length === 0) {
                showToast('No monitored devices found', 'warning');
                return;
            }
            
            // Show progress bar and disable button
            button.disabled = true;
            button.innerHTML = '<i class="bi bi-hourglass-split"></i> Pinging...';
            progressContainer.style.display = 'block';
            
            // Initialize progress
            let completed = 0;
            let successful = 0;
            let failed = 0;
            
            progressText.textContent = `0 / ${devices.length} devices`;
            progressBar.style.width = '0%';
            progressBar.setAttribute('aria-valuenow', '0');
            successCount.textContent = '0';
            failCount.textContent = '0';
            
            showToast(`Pinging ${devices.length} devices...`, 'info');
            
            // Ping devices one by one to show progress
            for (const device of devices) {
                try {
                    const response = await fetch(`/api/devices/${device.id}/ping`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    completed++;
                    const progress = (completed / devices.length) * 100;
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success !== false) {
                            successful++;
                        } else {
                            failed++;
                        }
                    } else {
                        failed++;
                    }
                    
                    // Update progress bar
                    progressBar.style.width = `${progress}%`;
                    progressBar.setAttribute('aria-valuenow', progress.toString());
                    progressText.textContent = `${completed} / ${devices.length} devices`;
                    successCount.textContent = successful.toString();
                    failCount.textContent = failed.toString();
                    
                    // Add small delay to make progress visible
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                } catch (error) {
                    console.error(`Error pinging device ${device.id}:`, error);
                    completed++;
                    failed++;
                    
                    const progress = (completed / devices.length) * 100;
                    progressBar.style.width = `${progress}%`;
                    progressBar.setAttribute('aria-valuenow', progress.toString());
                    progressText.textContent = `${completed} / ${devices.length} devices`;
                    failCount.textContent = failed.toString();
                }
            }
            
            // Show final results
            const successRate = devices.length > 0 ? Math.round((successful / devices.length) * 100) : 0;
            const message = `Ping completed: ${successful}/${devices.length} devices online (${successRate}%)`;
            
            if (successRate >= 80) {
                showToast(message, 'success');
            } else if (successRate >= 50) {
                showToast(message, 'warning');
            } else {
                showToast(message, 'danger');
            }
            
            // Hide progress bar after a delay
            setTimeout(() => {
                progressContainer.style.display = 'none';
            }, 3000);
            
            // Refresh device list to show updated status
            setTimeout(loadDevices, 1000);
            
        } catch (error) {
            console.error('Error pinging devices:', error);
            showToast('Failed to ping devices: ' + error.message, 'danger');
            progressContainer.style.display = 'none';
        } finally {
            // Restore button state
            button.disabled = false;
            button.innerHTML = originalText;
        }
    });
    
    // View switchers
    document.getElementById('view-grid').addEventListener('click', (e) => {
        e.preventDefault();
        switchView('grid');
    });
    document.getElementById('view-list').addEventListener('click', (e) => {
        e.preventDefault();
        switchView('list');
    });
    
    // Add device modal
    document.getElementById('save-device-btn').addEventListener('click', addDevice);
    
    // Auto-refresh every 30 seconds
    setInterval(loadDevices, 30000);
});
</script>

</body>
</html>